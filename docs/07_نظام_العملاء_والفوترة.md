# ูุธุงู ุงูุนููุงุก ูุงูููุชุฑุฉ ูุงูุชุญุตูู

## ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุดุงูู ูุฅุฏุงุฑุฉ ุงูุนููุงุก ูุงููุดุชุฑูููุ ุงูููุชุฑุฉุ ุงูุชุญุตููุ ูุฅุฏุงุฑุฉ ุงูุฏููู. ูุดูู ุฏูุฑุฉ ุญูุงุฉ ุงูุนููู ุงููุงููุฉ ูู ุงูุชุณุฌูู ุญุชู ุงูุชุญุตูู.

### ุงููุตุฏุฑ ูู ุงูุชู ุฏู
- **ุงููููุฉ 0.2 (ุงูุนููุงุก):** ุฅุฏุงุฑุฉ ุจูุงูุงุช ุงูุนููุงุก (40 ุณุงุนุฉ)
- **ุงููููุฉ 0.3:** ุงูููุชุฑุฉ ูุงูุชุญุตูู ุงูุฃุณุงุณูุฉ (120 ุณุงุนุฉ)
- **ุงููุธุงู 2 (ุงูููุงู 4-7):** ุงูููุชุฑุฉ ูุงูุชุญุตูู ุงููุชูุฏูุฉ (600 ุณุงุนุฉ)
- **ุงููุธุงู 8 (ุงูููุงู 32-37):** ุงูุนููุงุก ูุงูุชูุงุตู (600 ุณุงุนุฉ)
- **ุฅุฌูุงูู ุงูุณุงุนุงุช:** 1,360 ุณุงุนุฉ

### ุงูุฃููููุฉ
โญโญโญ ุญุฑุฌุฉ ุฌุฏุงู (ูุตุฏุฑ ุงูุฅูุฑุงุฏุงุช ุงูุฑุฆูุณู)

### ุงูุชุจุนูุงุช
- ุงููุธุงู ุงูุฃู (01) - ุดุฌุฑุฉ ุงูุญุณุงุจุงุช
- ูุธุงู ุงูุฃุตูู (03) - ุงูุนุฏุงุฏุงุช ูุงูุงุดุชุฑุงูุงุช
- ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ (04) - ุงูุชุฑููุจ ูุงููุตู ูุงูุชุญุตูู ุงูููุฏุงูู

---

## ุงูููููุงุช ุงูุฑุฆูุณูุฉ

### 1. ุฅุฏุงุฑุฉ ุงูุนููุงุก (ุงููููุฉ 0.2)

#### 1.1 ุฃููุงุน ุงูุนููุงุก
| ุงูููุน | ุงููุตู | ุงูุชุนุฑูุฉ |
|-------|-------|---------|
| ุณููู | ููุงุฒู ููุณุงูู | ุชุนุฑูุฉ ุณูููุฉ |
| ุชุฌุงุฑู | ูุญูุงุช ูููุงุชุจ | ุชุนุฑูุฉ ุชุฌุงุฑูุฉ |
| ุตูุงุนู | ูุตุงูุน ููุฑุด | ุชุนุฑูุฉ ุตูุงุนูุฉ |
| ุญูููู | ุฌูุงุช ุญููููุฉ | ุชุนุฑูุฉ ุญููููุฉ |
| ุฒุฑุงุนู | ูุฒุงุฑุน ูุขุจุงุฑ | ุชุนุฑูุฉ ุฒุฑุงุนูุฉ |

#### 1.2 ุฌุฏูู ุงูุนููุงุก (customers)
```sql
CREATE TABLE customers (
    id UUID PRIMARY KEY,
    customer_number VARCHAR(20) UNIQUE NOT NULL,
    
    -- ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    name VARCHAR(200) NOT NULL,
    name_en VARCHAR(200),
    customer_type VARCHAR(50) NOT NULL, -- residential, commercial, industrial, government, agricultural
    
    -- ุงููููุฉ
    id_type VARCHAR(50), -- national_id, passport, commercial_register
    id_number VARCHAR(50),
    id_card_image VARCHAR(500), -- ุตูุฑุฉ ุงูุจุทุงูุฉ ุงูุดุฎุตูุฉ
    tax_number VARCHAR(50),
    
    -- ูุนูููุงุช ุงูุงุชุตุงู
    phone VARCHAR(20),
    mobile VARCHAR(20) NOT NULL,
    email VARCHAR(100),
    
    -- ุงูุนููุงู
    address TEXT,
    city VARCHAR(100),
    district VARCHAR(100),
    building VARCHAR(100),
    floor VARCHAR(20),
    
    -- ุงููููุน ุงูุฌุบุฑุงูู
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8),
    
    -- ุจูุงูุงุช ุงูุงุดุชุฑุงู
    connection_date DATE,
    meter_id UUID REFERENCES meters(id),
    tariff_id UUID REFERENCES tariffs(id),
    
    -- ุงูุญุฏูุฏ ูุงูุดุฑูุท
    credit_limit DECIMAL(15,2) DEFAULT 0,
    payment_terms VARCHAR(50) DEFAULT 'prepaid', -- prepaid, postpaid
    billing_cycle VARCHAR(20) DEFAULT 'monthly', -- monthly, quarterly
    
    -- ุงูุฑุจุท ุงููุญุงุณุจู
    account_id UUID REFERENCES accounts(id),
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'active', -- active, inactive, suspended, disconnected
    suspension_reason TEXT,
    disconnection_date DATE,
    
    -- ุจูุงูุงุช ุงูุฏุนู ุงูุญูููู (Subsidy Data)
    is_subsidized BOOLEAN DEFAULT false,
    subsidy_program_id UUID REFERENCES subsidy_programs(id),
    subsidy_reference_number VARCHAR(50), -- ุงูุฑูู ุงููุฑุฌุนู ูู ูุธุงู ุตูุฏูู ุงูุฏุนู
    subsidy_start_date DATE,
    subsidy_end_date DATE,
    
    -- ุฌูุฉ ุงูุงุชุตุงู
    contact_person VARCHAR(100),
    contact_phone VARCHAR(20),
    
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 1.3 ุฌุฏูู ุฌูุงุช ุงุชุตุงู ุงูุนููุงุก (customer_contacts)
```sql
CREATE TABLE customer_contacts (
    id UUID PRIMARY KEY,
    customer_id UUID REFERENCES customers(id),
    
    name VARCHAR(100) NOT NULL,
    position VARCHAR(100),
    phone VARCHAR(20),
    mobile VARCHAR(20),
    email VARCHAR(100),
    is_primary BOOLEAN DEFAULT false,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 1.4 ุฌุฏูู ุนูุงููู ุงูุนููุงุก (customer_addresses)
```sql
CREATE TABLE customer_addresses (
    id UUID PRIMARY KEY,
    customer_id UUID REFERENCES customers(id),
    
    address_type VARCHAR(50), -- billing, service, mailing
    address TEXT NOT NULL,
    city VARCHAR(100),
    district VARCHAR(100),
    postal_code VARCHAR(20),
    
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8),
    
    is_default BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 1.4.1 ุฌุฏูู ููููุงุช ุงูุนููู (customer_components)

> **ุงูุบุฑุถ:** ุชุชุจุน ุงูููููุงุช ุงููุฑูุจุฉ ุญุงููุงู ูุฏู ูู ุนููู (ุงูุนุฏุงุฏุ ุงููุงุทุนุ ุงูุฎุชู)

```sql
CREATE TABLE customer_components (
    id UUID PRIMARY KEY,
    customer_id UUID REFERENCES customers(id),
    
    -- ุจูุงูุงุช ุงูุนุฏุงุฏ
    meter_serial_number VARCHAR(100),
    meter_type VARCHAR(50), -- smart, traditional
    meter_model VARCHAR(100),
    meter_installation_date DATE,
    meter_warranty_end DATE,
    
    -- ุจูุงูุงุช ุงููุงุทุน
    breaker_serial_number VARCHAR(100),
    breaker_type VARCHAR(50),
    breaker_capacity VARCHAR(20), -- ุฃูุจูุฑ
    breaker_brand VARCHAR(50),
    breaker_installation_date DATE,
    breaker_warranty_end DATE,
    
    -- ุจูุงูุงุช ุงูุฎุชู
    seal_number VARCHAR(50),
    seal_color VARCHAR(30),
    seal_type VARCHAR(50),
    seal_installation_date DATE,
    
    -- ุงูุชุญุฏูุซ
    last_updated_at TIMESTAMP DEFAULT NOW(),
    last_updated_by UUID REFERENCES users(id),
    
    created_at TIMESTAMP DEFAULT NOW()
);

-- Index ููุจุญุซ ุงูุณุฑูุน
CREATE INDEX idx_customer_components_customer ON customer_components(customer_id);
CREATE INDEX idx_customer_components_meter ON customer_components(meter_serial_number);
```

#### 1.4.2 ุฌุฏูู ุชุงุฑูุฎ ุงูููููุงุช (component_history)

> **ุงูุบุฑุถ:** ุชุณุฌูู ุชุงุฑูุฎ ูู ุงูููููุงุช ุงูุชู ุชู ุชุฑููุจูุง ูุฏู ุงูุนููู (ูุชู ุชู ุชุฑููุจู ููู ูุฑุฉ ุชู ุงุณุชุจุฏุงูู)

```sql
CREATE TABLE component_history (
    id UUID PRIMARY KEY,
    customer_id UUID REFERENCES customers(id),
    
    -- ููุน ุงููููู
    component_type VARCHAR(50) NOT NULL, -- meter, breaker, seal, cable
    
    -- ุจูุงูุงุช ุงููููู
    serial_number VARCHAR(100),
    model VARCHAR(100),
    brand VARCHAR(100),
    specifications JSONB, -- ููุงุตูุงุช ุฅุถุงููุฉ
    
    -- ุงูุนูููุฉ
    action_type VARCHAR(50) NOT NULL, -- installed, replaced, removed
    action_date DATE NOT NULL,
    action_time TIME,
    
    -- ุงูุณุจุจ
    reason VARCHAR(200), -- ุชุฑููุจ ุฌุฏูุฏุ ุนุทูุ ุชุฑููุฉุ ุตูุงูุฉ ุฏูุฑูุฉ
    notes TEXT,
    
    -- ุงูุถูุงู
    warranty_status VARCHAR(50), -- under_warranty, out_of_warranty, extended_warranty
    warranty_end_date DATE,
    
    -- ุงูุฑุจุท
    work_order_id UUID, -- ุฑุจุท ุจุฃูุฑ ุงูุนูู
    replacement_id UUID, -- ุฑุจุท ุจุนูููุฉ ุงูุงุณุชุจุฏุงู
    technician_id UUID REFERENCES users(id),
    
    -- ุงูุชูููุฉ
    cost DECIMAL(15,2) DEFAULT 0,
    invoice_id UUID, -- ูุงุชูุฑุฉ ุงูุงุณุชุจุฏุงู (ุฅุฐุง ุนูู ุญุณุงุจ ุงูุนููู)
    
    created_at TIMESTAMP DEFAULT NOW()
);

-- Index ููุจุญุซ ุงูุณุฑูุน
CREATE INDEX idx_component_history_customer ON component_history(customer_id);
CREATE INDEX idx_component_history_serial ON component_history(serial_number);
CREATE INDEX idx_component_history_type ON component_history(component_type);
```

#### 1.4.3 APIs ููููุงุช ุงูุนููู

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | /api/v1/customers/:id/components | ุฌูุจ ุงูููููุงุช ุงูุญุงููุฉ ููุนููู |
| GET | /api/v1/customers/:id/component-history | ุฌูุจ ุชุงุฑูุฎ ุงูููููุงุช ููุนููู |
| GET | /api/v1/components/:serial_number/history | ุชุงุฑูุฎ ูููู ูุนูู (ูู ูุฑุฉ ุชู ุงุณุชุจุฏุงูู) |
| GET | /api/v1/components/report/replacements | ุชูุฑูุฑ ุนูููุงุช ุงูุงุณุชุจุฏุงู |

---

### 1.5 ุณูุฑ ุนูู ุชุณุฌูู ุงููุดุชุฑู ุงูุฌุฏูุฏ (New Subscriber Onboarding Workflow)

> **ุงูุบุฑุถ:** ุชุญููู ุนูููุฉ ุชุณุฌูู ุงููุดุชุฑู ูู ูุฑููุฉ ุฅูู ุฑูููุฉ ูุชูุงููุฉ

#### 1.5.1 ุฌุฏูู ุทูุจุงุช ุงูุงุดุชุฑุงู (subscription_requests)
```sql
CREATE TABLE subscription_requests (
    id UUID PRIMARY KEY,
    request_number VARCHAR(20) UNIQUE NOT NULL,
    
    -- ุจูุงูุงุช ุงููุดุชุฑู
    customer_name VARCHAR(200) NOT NULL,
    customer_type VARCHAR(50) NOT NULL, -- residential, commercial, industrial
    id_type VARCHAR(50),
    id_number VARCHAR(50),
    id_card_image VARCHAR(500), -- ุตูุฑุฉ ุงูุจุทุงูุฉ
    phone VARCHAR(20),
    mobile VARCHAR(20) NOT NULL,
    email VARCHAR(100),
    
    -- ุงูุนููุงู ูุงููููุน
    address TEXT,
    city VARCHAR(100),
    district VARCHAR(100),
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8),
    
    -- ุงููุจุงูุบ ุงููุญุณูุจุฉ ุชููุงุฆูุงู
    subscription_fee DECIMAL(15,2),
    connection_fee DECIMAL(15,2),
    deposit_amount DECIMAL(15,2),
    total_amount DECIMAL(15,2),
    
    -- ุญุงูุฉ ุงูุฏูุน
    payment_status VARCHAR(20) DEFAULT 'pending', -- pending, paid, partial
    paid_amount DECIMAL(15,2) DEFAULT 0,
    payment_date TIMESTAMP,
    payment_reference VARCHAR(100),
    invoice_id UUID REFERENCES invoices(id),
    
    -- ุญุงูุฉ ุงูุทูุจ
    status VARCHAR(30) DEFAULT 'pending_review',
    -- ุงูุญุงูุงุช ุงูููููุฉ:
    -- 'pending_review': ููุฏ ุงููุฑุงุฌุนุฉ
    -- 'approved': ููุงูู ุนููู
    -- 'pending_payment': ุจุงูุชุธุงุฑ ุงูุฏูุน
    -- 'ready_for_installation': ุฌุงูุฒ ููุชุฑููุจ (ุจุนุฏ ุงูุฏูุน)
    -- 'assigned_to_technician': ูุณูุฏ ูููู
    -- 'installation_in_progress': ุฌุงุฑู ุงูุชุฑููุจ
    -- 'completed': ููุชูู
    -- 'rejected': ูุฑููุถ
    -- 'cancelled': ููุบู
    
    -- ุงูุฑุจุท
    customer_id UUID REFERENCES customers(id), -- ูููุดุฃ ุจุนุฏ ุงูุฅููุงู
    operation_id UUID, -- ุนูููุฉ ุงูุชุฑููุจ
    assigned_technician_id UUID REFERENCES users(id),
    meter_serial_number VARCHAR(100), -- ุงูุนุฏุงุฏ ุงููุตุฑูู
    
    -- ุงูุชูุงุฑูุฎ
    request_date TIMESTAMP DEFAULT NOW(),
    approval_date TIMESTAMP,
    payment_confirmed_date TIMESTAMP,
    installation_date TIMESTAMP,
    completion_date TIMESTAMP,
    
    -- ุงูููุธููู
    created_by UUID REFERENCES users(id),
    approved_by UUID REFERENCES users(id),
    rejection_reason TEXT,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 1.5.2 Business Rule: ูุง ุชุฑููุจ ูุจู ุงูุฏูุน (Payment Gate)
```sql
-- Trigger ูููุน ุงูุงูุชูุงู ูุญุงูุฉ ุงูุชุฑููุจ ูุจู ุงูุฏูุน
CREATE OR REPLACE FUNCTION check_payment_before_installation()
RETURNS TRIGGER AS $$
BEGIN
    -- ุฅุฐุง ูุงูุช ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ "ุฌุงูุฒ ููุชุฑููุจ" ุฃู ูุง ุจุนุฏูุง
    IF NEW.status IN ('ready_for_installation', 'assigned_to_technician', 'installation_in_progress') THEN
        -- ุชุญูู ูู ุงูุชูุงู ุงูุฏูุน
        IF NEW.payment_status != 'paid' THEN
            RAISE EXCEPTION 'ูุง ูููู ุงูุงูุชูุงู ููุฑุญูุฉ ุงูุชุฑููุจ ูุจู ุงูุชูุงู ุงูุฏูุน';
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER enforce_payment_gate
    BEFORE UPDATE ON subscription_requests
    FOR EACH ROW
    EXECUTE FUNCTION check_payment_before_installation();
```

#### 1.5.3 ุณูุฑ ุงูุนูู ุงูุฑููู
```
โโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโ
โ ููุฏ ุงููุฑุงุฌุนุฉ  โโโโโถโ ุจุงูุชุธุงุฑ ุงูุฏูุน โโโโโถโ ุฌุงูุฒ ููุชุฑููุจ โโโโโถโ ูุณูุฏ ูููู   โ
โ pending_review โ    โpending_paymentโ    โready_for_inst โ    โassigned_tech  โ
โโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโ
        โ                    โ                    โ                    โ
        โ                    โ                    โ                    โผ
        โ                    โ                    โ              โโโโโโโโโโโโโโโโโ
        โ                    โ                    โ              โ ุฌุงุฑู ุงูุชุฑููุจ  โ
        โ                    โ                    โ              โin_progress    โ
        โ                    โ                    โ              โโโโโโโโโโโโโโโโโ
        โ                    โ                    โ                    โ
        โผ                    โผ                    โผ                    โผ
   โโโโโโโโโโ        โโโโโโโโโโ        โโโโโโโโโโ        โโโโโโโโโโ
   โ ูุฑููุถ  โ        โ ููุบู   โ        โ ููุบู   โ        โ ููุชูู  โ
   โโโโโโโโโโ        โโโโโโโโโโ        โโโโโโโโโโ        โโโโโโโโโโ
```

#### 1.5.4 ุฅูุดุงุก ุทูุจ ุงุดุชุฑุงู ุฌุฏูุฏ
```python
def create_subscription_request(data: dict) -> SubscriptionRequest:
    """
    ุฅูุดุงุก ุทูุจ ุงุดุชุฑุงู ุฌุฏูุฏ ูุน ุญุณุงุจ ุงููุจุงูุบ ุชููุงุฆูุงู
    """
    # 1. ุญุณุงุจ ุงููุจุงูุบ ุชููุงุฆูุงู
    pricing = calculate_subscription_amounts(data['customer_type'])
    
    # 2. ุฅูุดุงุก ุงูุทูุจ
    request = SubscriptionRequest.create(
        request_number=generate_request_number(),
        customer_name=data['customer_name'],
        customer_type=data['customer_type'],
        id_type=data.get('id_type'),
        id_number=data.get('id_number'),
        id_card_image=data.get('id_card_image'),
        mobile=data['mobile'],
        address=data.get('address'),
        latitude=data.get('latitude'),
        longitude=data.get('longitude'),
        
        # ุงููุจุงูุบ ุงููุญุณูุจุฉ
        subscription_fee=pricing['subscription_fee'],
        connection_fee=pricing['connection_fee'],
        deposit_amount=pricing['deposit_amount'],
        total_amount=pricing['total_required'],
        
        status='pending_review',
        created_by=current_user.id
    )
    
    # 3. ุฅูุดุงุก ูุงุชูุฑุฉ ุฑูููุฉ
    invoice = Invoice.create(
        invoice_type='subscription',
        total_amount=pricing['total_required'],
        items=[
            {'description': 'ุฑุณู ุงูุงุดุชุฑุงู', 'amount': pricing['subscription_fee']},
            {'description': 'ุฑุณู ุงูุชูุตูู', 'amount': pricing['connection_fee']},
            {'description': 'ุชุฃููู', 'amount': pricing['deposit_amount']}
        ]
    )
    request.invoice_id = invoice.id
    request.save()
    
    return request
```

#### 1.5.5 ูุนุงูุฌุฉ ุงูุฏูุน ูุงูุงูุชูุงู ููุชุฑููุจ
```python
def confirm_payment(request_id: UUID, payment_data: dict):
    """
    ุชุฃููุฏ ุงูุฏูุน ูุงูุงูุชูุงู ูุญุงูุฉ "ุฌุงูุฒ ููุชุฑููุจ"
    """
    request = SubscriptionRequest.get(request_id)
    
    # 1. ุชุญุฏูุซ ุญุงูุฉ ุงูุฏูุน
    request.payment_status = 'paid'
    request.paid_amount = request.total_amount
    request.payment_date = datetime.now()
    request.payment_reference = payment_data.get('reference')
    request.payment_confirmed_date = datetime.now()
    
    # 2. ุงูุงูุชูุงู ูุญุงูุฉ "ุฌุงูุฒ ููุชุฑููุจ" (ุงูุขู ูุณููุญ ูุฃู ุงูุฏูุน ููุชูู)
    request.status = 'ready_for_installation'
    request.save()
    
    # 3. ุฅูุดุงุก ุนูููุฉ ุชุฑููุจ ููุฏุงููุฉ
    operation = FieldOperation.create(
        operation_type='installation',
        reference_type='subscription_request',
        reference_id=request_id,
        title=f'ุชุฑููุจ ุนุฏุงุฏ ุฌุฏูุฏ - {request.customer_name}',
        address=request.address,
        latitude=request.latitude,
        longitude=request.longitude,
        status='scheduled'
    )
    request.operation_id = operation.id
    request.save()
    
    # 4. ุฅุดุนุงุฑ ูุฏูุฑ ุงููุญุทุฉ ูุฅุณูุงุฏ ุงููููุฉ
    notify_station_manager(operation)
    
    return request
```

---

### 1.6 ูุญุฏุฉ ุฅุฏุงุฑุฉ ุงูุฏุนู ุงูุญูููู (Subsidized Tariffs Management)

> **ุงูุบุฑุถ:** ุฅุฏุงุฑุฉ ุงููุดุชุฑููู ุงููุฏุนูููู ูู ุตูุฏูู ุฏุนู ูุชูููุฉ ุงูุญุฏูุฏุฉ

#### 1.5.1 ุฌุฏูู ุจุฑุงูุฌ ุงูุฏุนู (subsidy_programs)
```sql
CREATE TABLE subsidy_programs (
    id UUID PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    
    -- ุงูุฌูุฉ ุงููุงูุญุฉ
    funding_entity VARCHAR(200) NOT NULL, -- ุตูุฏูู ุฏุนู ูุชูููุฉ ุงูุญุฏูุฏุฉ
    contact_person VARCHAR(100),
    contact_phone VARCHAR(20),
    contact_email VARCHAR(100),
    
    -- ุญุฏูุฏ ุงูุฏุนู
    monthly_quota_kwh DECIMAL(10,2) NOT NULL, -- ุงูุญุตุฉ ุงูุดูุฑูุฉ (ูููููุงุท/ุณุงุนุฉ)
    rate_per_kwh DECIMAL(10,4), -- ุณุนุฑ ุงููุญุฏุฉ ุงููุฏุนูู
    
    -- ุงููุชุฑุฉ
    start_date DATE NOT NULL,
    end_date DATE,
    
    -- ุงูุญุงูุฉ
    is_active BOOLEAN DEFAULT true,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ุจุฑุงูุฌ ุงูุฏุนู ุงูุงูุชุฑุงุถูุฉ
INSERT INTO subsidy_programs (code, name, funding_entity, monthly_quota_kwh) VALUES
('HODEIDAH_A', 'ุฏุนู ุงูุญุฏูุฏุฉ - ุงููุฆุฉ ุฃ', 'ุตูุฏูู ุฏุนู ูุชูููุฉ ุงูุญุฏูุฏุฉ', 82),
('HODEIDAH_B', 'ุฏุนู ุงูุญุฏูุฏุฉ - ุงููุฆุฉ ุจ', 'ุตูุฏูู ุฏุนู ูุชูููุฉ ุงูุญุฏูุฏุฉ', 64);
```

#### 1.5.2 ุฌุฏูู ุญุตุต ุงูุฏุนู ุงูุดูุฑูุฉ (subsidy_quotas)
```sql
CREATE TABLE subsidy_quotas (
    id UUID PRIMARY KEY,
    customer_id UUID REFERENCES customers(id),
    program_id UUID REFERENCES subsidy_programs(id),
    
    -- ุงููุชุฑุฉ
    year INT NOT NULL,
    month INT NOT NULL,
    
    -- ุงูุญุตุฉ
    allocated_kwh DECIMAL(10,2) NOT NULL, -- ุงูุญุตุฉ ุงููุฎุตุตุฉ
    consumed_kwh DECIMAL(10,2) DEFAULT 0, -- ุงููุณุชููู
    remaining_kwh DECIMAL(10,2), -- ุงููุชุจูู
    
    -- ุงููููุฉ
    subsidy_value DECIMAL(15,2), -- ูููุฉ ุงูุฏุนู ุงููุณุชุญูุฉ
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'active', -- active, exhausted, expired
    exhausted_at TIMESTAMP, -- ุชุงุฑูุฎ ุงูุชูุงุก ุงูุญุตุฉ
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(customer_id, year, month)
);
```

#### 1.5.3 ุงูููุงู ุงููุฌุฏููุฉ (Scheduled Jobs)

**ูููุฉ 1: ุดุญู ุงูุญุตุต ุงูุดูุฑูุฉ (Monthly Quota Allocation)**
```python
# ุชุนูู ุงูุณุงุนุฉ 12:01 ุตุจุงุญุงู ูู ุงูููู ุงูุฃูู ูู ูู ุดูุฑ
@scheduled_job(cron="1 0 1 * *")
def allocate_monthly_subsidies():
    """
    ุดุญู ุงูุญุตุต ุงููุฏุนููุฉ ูุฌููุน ุงููุดุชุฑููู ุงููุฏุนูููู
    """
    year = datetime.now().year
    month = datetime.now().month
    
    # 1. ุฌูุจ ุฌููุน ุงููุดุชุฑููู ุงููุฏุนูููู ุจุนุฏุงุฏุงุช ุฐููุฉ
    subsidized_customers = db.query("""
        SELECT c.id, c.meter_id, sp.monthly_quota_kwh, sp.id as program_id
        FROM customers c
        JOIN subsidy_programs sp ON c.subsidy_program_id = sp.id
        JOIN meters m ON c.meter_id = m.id
        WHERE c.is_subsidized = true
        AND c.status = 'active'
        AND m.meter_type = 'smart'
        AND sp.is_active = true
    """)
    
    for customer in subsidized_customers:
        # 2. ุฅูุดุงุก ุณุฌู ุงูุญุตุฉ ุงูุดูุฑูุฉ
        SubsidyQuota.create(
            customer_id=customer.id,
            program_id=customer.program_id,
            year=year,
            month=month,
            allocated_kwh=customer.monthly_quota_kwh,
            remaining_kwh=customer.monthly_quota_kwh
        )
        
        # 3. ุฅุฑุณุงู ุฃูุฑ ุดุญู ุงูุญุตุฉ ููุนุฏุงุฏ ุนุจุฑ Acrel API
        AcrelAPI.set_monthly_quota(
            meter_id=customer.meter_id,
            quota_kwh=customer.monthly_quota_kwh
        )
    
    # 4. ุชุณุฌูู ุงูุนูููุฉ
    log.info(f"ุชู ุดุญู ุงูุญุตุต ูู {len(subsidized_customers)} ูุดุชุฑู ูุฏุนูู")
```

**ูููุฉ 2: ุฅุนุฏุงุฏ ุชูุงุฑูุฑ ุตูุฏูู ุงูุฏุนู (Monthly Subsidy Report)**
```python
# ุชุนูู ุงูุณุงุนุฉ 11:59 ูุณุงุกู ูู ุงูููู ุงูุฃุฎูุฑ ูู ูู ุดูุฑ
@scheduled_job(cron="59 23 L * *")  # L = ุงูููู ุงูุฃุฎูุฑ
def generate_subsidy_report():
    """
    ุฅุนุฏุงุฏ ุชูุฑูุฑ ุงูุฏุนู ุงูุดูุฑู ูุตูุฏูู ุงูุฏุนู
    """
    year = datetime.now().year
    month = datetime.now().month
    
    # 1. ุฌูุจ ุจูุงูุงุช ุงูุงุณุชููุงู ููู ูุดุชุฑู ูุฏุนูู
    report_data = []
    subsidized_customers = get_subsidized_customers()
    
    for customer in subsidized_customers:
        # ุฌูุจ ุงูุงุณุชููุงู ูู Acrel
        consumption = AcrelAPI.get_monthly_consumption(
            meter_id=customer.meter_id,
            year=year,
            month=month
        )
        
        # ุญุณุงุจ ุงูุงุณุชููุงู ุงููุฏุนูู (ุงูุฃูู ุจูู ุงููุนูู ูุงูุญุตุฉ)
        subsidized_consumption = min(
            consumption.total_kwh,
            customer.monthly_quota_kwh
        )
        
        # ุญุณุงุจ ุงููููุฉ
        subsidy_value = subsidized_consumption * customer.rate_per_kwh
        
        report_data.append({
            'customer_name': customer.name,
            'reference_number': customer.subsidy_reference_number,
            'program': customer.program_name,
            'quota_kwh': customer.monthly_quota_kwh,
            'actual_consumption_kwh': consumption.total_kwh,
            'subsidized_consumption_kwh': subsidized_consumption,
            'subsidy_value': subsidy_value
        })
        
        # ุชุญุฏูุซ ุณุฌู ุงูุญุตุฉ
        SubsidyQuota.update(
            customer_id=customer.id,
            year=year,
            month=month,
            consumed_kwh=consumption.total_kwh,
            subsidy_value=subsidy_value
        )
    
    # 2. ุฅูุดุงุก ููู Excel
    report_file = generate_excel_report(report_data, year, month)
    
    # 3. ุฅุฑุณุงู ุงูุชูุฑูุฑ (ุงุฎุชูุงุฑู: ุนุจุฑ API ุตูุฏูู ุงูุฏุนู)
    # SubsidyFundAPI.submit_report(report_file)
    
    # 4. ุฅุดุนุงุฑ ุงููุณุคูููู
    notify_admins("ุชูุฑูุฑ ุงูุฏุนู ุงูุดูุฑู ุฌุงูุฒ", report_file)
    
    return report_file
```

#### 1.5.4 ุขููุฉ ุงูุดุญู ุงูุฅุถุงูู ูููุฏุนูููู

```python
def handle_subsidized_topup(customer_id, amount):
    """
    ูุนุงูุฌุฉ ุดุญู ุฑุตูุฏ ุฅุถุงูู ููุดุชุฑู ูุฏุนูู
    ุงููุดุชุฑู ุงููุฏุนูู ููููู ุดุฑุงุก ุฑุตูุฏ ุฅุถุงูู ุจุนุฏ ุงูุชูุงุก ุญุตุชู
    """
    customer = Customer.get(customer_id)
    
    if not customer.is_subsidized:
        # ุนููู ุนุงุฏู - ูุนุงูุฌุฉ ุนุงุฏูุฉ
        return process_normal_topup(customer, amount)
    
    # ุนููู ูุฏุนูู - ุชุญููู ุงููุจูุบ ุฅูู ูููููุงุท/ุณุงุนุฉ
    tariff = Tariff.get(customer.tariff_id)
    kwh_purchased = amount / tariff.base_rate
    
    # ุฅุถุงูุฉ ุงูุฑุตูุฏ ุนุจุฑ Acrel API
    AcrelAPI.add_credit(
        meter_id=customer.meter_id,
        kwh=kwh_purchased
    )
    
    # ุชุณุฌูู ุงูุนูููุฉ
    TopupTransaction.create(
        customer_id=customer_id,
        amount=amount,
        kwh=kwh_purchased,
        transaction_type='additional_credit',
        is_subsidized=False  # ูุฐุง ุดุญู ุบูุฑ ูุฏุนูู
    )
    
    return {
        'success': True,
        'kwh_added': kwh_purchased,
        'new_balance': AcrelAPI.get_meter_balance(customer.meter_id)
    }
```

#### 1.5.5 ููุญุฉ ูุฑุงูุจุฉ ุงุณุชููุงู ุงูุฏุนู

| ุงููููู | ุงููุตู |
|---------|-------|
| **ุฅุฌูุงูู ุงููุณุชููุฏูู** | ุนุฏุฏ ุงููุดุชุฑููู ุงููุฏุนูููู ุญุณุจ ุงููุฆุฉ |
| **ุงุณุชููุงู ุงูุฏุนู** | ุฑุณู ุจูุงูู ููุงุณุชููุงู ุงููุฏุนูู vs ุงูุญุตุฉ |
| **ุชูุจููุงุช 90%** | ูุงุฆูุฉ ุงููุดุชุฑููู ุงูุฐูู ุงุณุชููููุง 90% ูู ุงูุญุตุฉ |
| **ุงูุชุฌุงูุฒุงุช** | ูุงุฆูุฉ ุงููุดุชุฑููู ุงูุฐูู ุชุฌุงูุฒูุง ุงูุญุตุฉ |
| **ูููุฉ ุงูุฏุนู ุงูุดูุฑู** | ุฅุฌูุงูู ูููุฉ ุงูุฏุนู ุงููุณุชุญูุฉ |

---

### 1.6 ุฏุนู ุงููุฑุญูุฉ ุงูุงูุชูุงููุฉ (Hybrid Solution - 2200 ูุดุชุฑู)

> **ุงูุบุฑุถ:** ุฅุฏุงุฑุฉ ุงููุดุชุฑููู ุงููุฏุนูููู ุนูู ุงูุนุฏุงุฏุงุช ุงูุชูููุฏูุฉ ุฅูู ุญูู ุงุณุชุจุฏุงููุง ุจุงูุฐููุฉ

#### 1.6.1 ููุญุฉ ูุฑุงูุจุฉ ุงูุนุฏุงุฏุงุช ุงูุชูููุฏูุฉ ุงููุฏุนููุฉ

**ุงูููููุงุช:**

| ุงููููู | ุงููุตู |
|---------|-------|
| **ูุงุฆูุฉ ุงููุดุชุฑููู** | ุฌููุน ุงููุดุชุฑููู ุงููุฏุนูููู ุนูู ุนุฏุงุฏุงุช ุชูููุฏูุฉ |
| **ูุฆุฉ ุงูุฏุนู** | ุงููุฆุฉ ุฃ (82 ูููู) ุฃู ุงููุฆุฉ ุจ (64 ูููู) |
| **ุงูุงุณุชููุงู ุงูุญุงูู** | ุงูุงุณุชููุงู ููุฐ ุจุฏุงูุฉ ุงูุดูุฑ (ูุชุญุฏุซ ุนูุฏ ุฅุฏุฎุงู ูุฑุงุกุฉ) |
| **ุดุฑูุท ุงูุชูุฏู ุงููุฑุฆู** | ูุณุจุฉ ุงูุงุณุชููุงู ูู ุงูุญุตุฉ (75/82 = 91%) |
| **ุงูุชุฌุงูุฒ** | ุญุฌู ุงูุงุณุชููุงู ุงูุฅุถุงูู ุนูุฏ ุชุฌุงูุฒ 100% |

**ุฃููุงู ุดุฑูุท ุงูุชูุฏู:**

| ุงููุณุจุฉ | ุงูููู | ุงูุญุงูุฉ |
|--------|-------|--------|
| 0% - 70% | ๐ข ุฃุฎุถุฑ | ุขูู |
| 71% - 90% | ๐ก ุฃุตูุฑ | ุชุญุฐูุฑ |
| 91% - 100% | ๐ ุจุฑุชูุงูู | ุงูุชุฑุงุจ ุงูุญุฏ |
| > 100% | ๐ด ุฃุญูุฑ | ุชุฌุงูุฒ (ูุฏููููุฉ) |

#### 1.6.2 ูุธุงู ุงูุฅุดุนุงุฑุงุช ุงูุงุณุชุจุงููุฉ (Proactive Notifications)

**ุงููููุฉ ุงููุฌุฏููุฉ ุงูููููุฉ:**
```python
# ุชุนูู ููููุงู ุงูุณุงุนุฉ 8:00 ุตุจุงุญุงู
@scheduled_job(cron="0 8 * * *")
def check_traditional_meter_subsidies():
    """
    ูุญุต ุงุณุชููุงู ุงููุดุชุฑููู ุงููุฏุนูููู ุนูู ุนุฏุงุฏุงุช ุชูููุฏูุฉ
    ูุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช ุงูููุงุณุจุฉ
    """
    # ุฌูุจ ุงููุดุชุฑููู ุงููุฏุนูููู ุนูู ุนุฏุงุฏุงุช ุชูููุฏูุฉ
    customers = db.query("""
        SELECT c.*, sq.allocated_kwh, sq.consumed_kwh,
               (sq.consumed_kwh / sq.allocated_kwh * 100) as consumption_percent
        FROM customers c
        JOIN subsidy_quotas sq ON c.id = sq.customer_id
        JOIN meters m ON c.meter_id = m.id
        WHERE c.is_subsidized = true
        AND m.meter_type = 'traditional'
        AND sq.year = YEAR(NOW())
        AND sq.month = MONTH(NOW())
    """)
    
    for customer in customers:
        percent = customer.consumption_percent
        
        # ุฅุดุนุงุฑ 90%
        if 90 <= percent < 100 and not customer.notified_90:
            send_sms(customer.mobile, TEMPLATE_90_PERCENT, customer)
            mark_notified(customer.id, '90%')
            create_staff_alert(customer, 'ุงูุชุฑุงุจ ุงูุชูุงุก ุงูุญุตุฉ')
        
        # ุฅุดุนุงุฑ ุงูุชุฌุงูุฒ
        elif percent >= 100 and not customer.notified_exceeded:
            excess_kwh = customer.consumed_kwh - customer.allocated_kwh
            send_sms(customer.mobile, TEMPLATE_EXCEEDED, customer, excess_kwh)
            mark_notified(customer.id, 'exceeded')
            create_staff_alert(customer, 'ุชุฌุงูุฒ ุงูุญุตุฉ', priority='high')
```

**ููุงูุจ ุฑุณุงุฆู ุงูุฅุดุนุงุฑุงุช:**

| ุงููุงูุจ | ุงููุต |
|---------|------|
| **TEMPLATE_90_PERCENT** | "ุนููููุง ุงูุนุฒูุฒ {{customer_name}}ุ ููุฏ ุงุณุชูููุช 90% ูู ุญุตุชู ุงููุฏุนููุฉ ููุฐุง ุงูุดูุฑ ({{consumed}}/{{quota}} ูููู). ุฃู ุงุณุชููุงู ุฅุถุงูู ุณูุชู ุงุญุชุณุงุจู ุจุงูุณุนุฑ ุงูุชุฌุงุฑู. ูุญุทุฉ ุงูููุฑุจุงุก" |
| **TEMPLATE_EXCEEDED** | "ุนููููุง ุงูุนุฒูุฒ {{customer_name}}ุ ููุฏ ุชุฌุงูุฒุช ุญุตุชู ุงููุฏุนููุฉ. ุฑุตูุฏู ุงูุญุงูู: -{{excess}} ูููู (ุณุงูุจ). ูุฑุฌู ุฒูุงุฑุฉ ุฃูุฑุจ ููุชุจ ุฃู ุงุณุชุฎุฏุงู ุฑุงุจุท ุงูุฏูุน: {{payment_link}} ูุชุณููุฉ ุงููุจูุบ ูุชุฌูุจ ุชุฑุงูู ุงููุฏููููุฉ." |

#### 1.6.3 ููุชุฑุฉ ุงูุชุฌุงูุฒ ุงููููุตูุฉ

```python
def generate_monthly_subsidized_invoices():
    """
    ุฅูุดุงุก ููุงุชูุฑ ููุงูุฉ ุงูุดูุฑ ูููุดุชุฑููู ุงููุฏุนูููู
    ุนูู ุนุฏุงุฏุงุช ุชูููุฏูุฉ
    """
    for customer in get_traditional_subsidized_customers():
        quota = customer.monthly_quota_kwh
        consumed = customer.consumed_kwh
        
        # ุงูุฌุฒุก ุงููุฏุนูู (ูุฐูุจ ูุชูุฑูุฑ ุตูุฏูู ุงูุฏุนู)
        subsidized_consumption = min(consumed, quota)
        
        # ุงูุฌุฒุก ุบูุฑ ุงููุฏุนูู (ูุงุชูุฑุฉ ุนูู ุงูุนููู)
        excess_consumption = max(0, consumed - quota)
        
        if excess_consumption > 0:
            # ุฅูุดุงุก ูุงุชูุฑุฉ ุงูุชุฌุงูุฒ
            excess_amount = excess_consumption * get_commercial_rate()
            
            Invoice.create(
                customer_id=customer.id,
                invoice_type='subsidy_excess',  # ููุน ุฎุงุต
                description=f'ุงุณุชููุงู ุฅุถุงูู ุนู ุงูุญุตุฉ ุงููุฏุนููุฉ - {excess_consumption} ูููู',
                amount=excess_amount,
                due_date=get_due_date(),
                items=[
                    {
                        'description': 'ุงุณุชููุงู ุฅุถุงูู',
                        'quantity': excess_consumption,
                        'unit': 'ูููููุงุท/ุณุงุนุฉ',
                        'rate': get_commercial_rate(),
                        'amount': excess_amount
                    }
                ]
            )
            
            # ุชุญุฏูุซ ูุฏููููุฉ ุงูุนููู
            customer.update_debt(excess_amount)
            
            # ุฅุฑุณุงู ุฅุดุนุงุฑ ุจุงููุงุชูุฑุฉ
            send_invoice_notification(customer, excess_amount)
```

#### 1.6.4 ุนุฑุถ ุงููุฏููููุฉ ูู ููู ุงููุดุชุฑู

**ูุณู ุงูุฏุนู ูู ููู ุงููุดุชุฑู:**

| ุงูุญูู | ุงููุตู |
|-------|-------|
| ุจุฑูุงูุฌ ุงูุฏุนู | ุฏุนู ุงูุญุฏูุฏุฉ - ุงููุฆุฉ ุฃ |
| ุงูุญุตุฉ ุงูุดูุฑูุฉ | 82 ูููููุงุท/ุณุงุนุฉ |
| ุงูุงุณุชููุงู ุงูุญุงูู | 95 ูููููุงุท/ุณุงุนุฉ |
| **ุดุฑูุท ุงูุชูุฏู** | ๐ด 116% (ุชุฌุงูุฒ 13 ูููู) |
| **ูุฏููููุฉ ุงูุชุฌุงูุฒ** | 1,300 ุฑูุงู |
| ููุน ุงูุนุฏุงุฏ | ุชูููุฏู (ูุฑุญูุฉ ุงูุชูุงููุฉ) |

#### 1.6.5 APIs ุงููุฑุญูุฉ ุงูุงูุชูุงููุฉ
```
GET    /api/v1/subsidy/traditional-meters           - ูุงุฆูุฉ ุงูุนุฏุงุฏุงุช ุงูุชูููุฏูุฉ ุงููุฏุนููุฉ
GET    /api/v1/subsidy/traditional-meters/alerts    - ุชูุจููุงุช ุงูููุธููู
GET    /api/v1/subsidy/traditional-meters/exceeded  - ูุงุฆูุฉ ุงููุชุฌุงูุฒูู
POST   /api/v1/subsidy/reading                      - ุชุณุฌูู ูุฑุงุกุฉ ุนุฏุงุฏ ุชูููุฏู
```

#### 1.5.6 APIs ุฅุฏุงุฑุฉ ุงูุฏุนู
```
GET    /api/v1/subsidy/programs                    - ูุงุฆูุฉ ุจุฑุงูุฌ ุงูุฏุนู
POST   /api/v1/subsidy/programs                    - ุฅูุดุงุก ุจุฑูุงูุฌ ุฏุนู
GET    /api/v1/subsidy/beneficiaries               - ูุงุฆูุฉ ุงููุณุชููุฏูู
POST   /api/v1/subsidy/beneficiaries               - ุฅุถุงูุฉ ูุณุชููุฏ
GET    /api/v1/subsidy/quotas/:customer_id         - ุญุตุต ุงูุนููู
GET    /api/v1/subsidy/dashboard                   - ููุญุฉ ูุฑุงูุจุฉ ุงูุฏุนู
GET    /api/v1/subsidy/reports/:year/:month        - ุชูุฑูุฑ ุงูุฏุนู ุงูุดูุฑู
POST   /api/v1/subsidy/reports/:year/:month/export - ุชุตุฏูุฑ ุงูุชูุฑูุฑ
```

---

### 1.7 ูุนุงูุฌ ุชุฑููุฉ ุงูุงุดุชุฑุงู (Subscription Upgrade Wizard)

> **ุงูุบุฑุถ:** ุชุฑููุฉ ุนุฏุงุฏ ุนุงุฏู ุฅูู ุนุฏุงุฏ ุฏูุน ูุณุจู (STS) ูุน ุฅูุบุงุก ุงูุชุฃููู ูุชุทุจูู ุงูุณุนุฑ ุงูุตุญูุญ

#### 1.7.1 ุฎุทูุงุช ุงููุนุงูุฌ (Wizard Steps)

```
ุงูุฎุทูุฉ 1: ุชุญุฏูุฏ ุงูุนููู
         - ุงุฎุชูุงุฑ ุงูุนููู ุฃู ุงูุจุญุซ ุจุฑูู ุงูุนุฏุงุฏ
         - ุนุฑุถ ุจูุงูุงุช ุงูุนููู ูููุน ุงูุงุดุชุฑุงู ุงูุญุงูู
         โ
ุงูุฎุทูุฉ 2: ูุญุต ุงูุฃูููุฉ ูุชุญุฏูุฏ ุงูุณุนุฑ
         - ุงููุธุงู ููุญุต ุญุงูุฉ ุงูุนููู ุชููุงุฆูุงู
         - ูุดุท (< 6 ุฃุดูุฑ ุงููุทุงุน) โ ุณุนุฑ ุงูุชุฑููุฉ
         - ูููุทุน (> 6 ุฃุดูุฑ) โ ุณุนุฑ ุงุดุชุฑุงู ุฌุฏูุฏ
         โ
ุงูุฎุทูุฉ 3: ุฅูุบุงุก ุงูุชุฃููู ุงููุฏูู
         - ุนุฑุถ ุฑุตูุฏ ุงูุชุฃููู ุงูุญุงูู
         - ุฎูุงุฑุงุช ุงุณุชุฎุฏุงู ุงูุฑุตูุฏ
         - ุฅูุดุงุก ุณูุฏ ุฅูุบุงุก ุงูุชุฃููู
         โ
ุงูุฎุทูุฉ 4: ุฅูุดุงุก ุฃูุฑ ุนูู ุงูุชุฑููุฉ
         - ุฅูุดุงุก ูุงุชูุฑุฉ ุงูุชุฑููุฉ
         - ุฅูุดุงุก ุฃูุฑ ุนูู ููููู
         - ุชุญุฏูุฏ ุงูููุงุฏ (ุนุฏุงุฏ STS + ุดุงุดุฉ + ุฎุชูุ ุจุฏูู ูุงุทุน)
         โ
ุงูุฎุทูุฉ 5: ุงูุชุฃููุฏ ูุงูุฅุฑุณุงู
         - ูุฑุงุฌุนุฉ ุฌููุน ุงูุจูุงูุงุช
         - ุชุฃููุฏ ูุฅุฑุณุงู ููููู
```

#### 1.7.2 ุฌุฏูู ุฃุณุนุงุฑ ุงูุชุฑููุฉ: `upgrade_pricing`

```sql
CREATE TABLE upgrade_pricing (
    id UUID PRIMARY KEY,
    business_id UUID REFERENCES businesses(id),
    
    -- ููุน ุงูุชุฑููุฉ
    from_type VARCHAR(50), -- postpaid, traditional
    to_type VARCHAR(50), -- prepaid_sts
    
    -- ุงูุฃุณุนุงุฑ
    upgrade_price DECIMAL(15,2), -- ุณุนุฑ ุงูุชุฑููุฉ (ููุนููุงุก ุงููุดุทูู)
    new_subscription_price DECIMAL(15,2), -- ุณุนุฑ ุงุดุชุฑุงู ุฌุฏูุฏ (ูููููุทุนูู)
    
    -- ุดุฑูุท ุงูุฃูููุฉ
    max_disconnection_months INT DEFAULT 6, -- ุงูุญุฏ ุงูุฃูุตู ููุงููุทุงุน ููุชุฑููุฉ
    
    -- ุงูููุงุฏ ุงููุทููุจุฉ
    required_materials JSON, -- ["ุนุฏุงุฏ STS", "ุดุงุดุฉ ุนุฑุถ", "ุฎุชู"]
    excluded_materials JSON, -- ["ูุงุทุน"] - ูุฃู ุงููุงุทุน ุงููุฏูู ุณููุณุชุฎุฏู
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ุงูุฃุณุนุงุฑ ุงูุงูุชุฑุงุถูุฉ
INSERT INTO upgrade_pricing (
    from_type, to_type, upgrade_price, new_subscription_price,
    max_disconnection_months, required_materials, excluded_materials
) VALUES (
    'postpaid', 'prepaid_sts', 20000, 35000, 6,
    '["STS_METER", "STS_DISPLAY", "SEAL"]',
    '["CIRCUIT_BREAKER"]'
);
```

#### 1.7.3 ุฌุฏูู ุทูุจุงุช ุงูุชุฑููุฉ: `subscription_upgrades`

```sql
CREATE TABLE subscription_upgrades (
    id UUID PRIMARY KEY,
    business_id UUID REFERENCES businesses(id),
    upgrade_number VARCHAR(20) UNIQUE,
    
    -- ุจูุงูุงุช ุงูุนููู
    customer_id UUID REFERENCES customers(id),
    subscription_id UUID REFERENCES subscriptions(id),
    
    -- ููุน ุงูุชุฑููุฉ
    from_type VARCHAR(50), -- postpaid
    to_type VARCHAR(50), -- prepaid_sts
    
    -- ูุญุต ุงูุฃูููุฉ
    customer_status VARCHAR(50), -- active, disconnected
    disconnection_months INT, -- ุนุฏุฏ ุฃุดูุฑ ุงูุงููุทุงุน
    is_eligible_for_upgrade BOOLEAN, -- ูุคูู ูุณุนุฑ ุงูุชุฑููุฉ
    
    -- ุงูุชุณุนูุฑ
    applied_price DECIMAL(15,2), -- ุงูุณุนุฑ ุงููุทุจู
    price_type VARCHAR(50), -- upgrade, new_subscription
    
    -- ุฅูุบุงุก ุงูุชุฃููู
    old_deposit_amount DECIMAL(15,2), -- ุฑุตูุฏ ุงูุชุฃููู ุงููุฏูู
    deposit_usage VARCHAR(50), -- apply_to_upgrade, refund, apply_to_debt
    deposit_cancellation_voucher_id UUID, -- ุณูุฏ ุฅูุบุงุก ุงูุชุฃููู
    
    -- ุงููุจูุบ ุงูููุงุฆู
    net_amount_due DECIMAL(15,2), -- ุงููุจูุบ ุงููุณุชุญู ุจุนุฏ ุฎุตู ุงูุชุฃููู
    upgrade_invoice_id UUID, -- ูุงุชูุฑุฉ ุงูุชุฑููุฉ
    
    -- ุฃูุฑ ุงูุนูู
    work_order_id UUID REFERENCES work_orders(id),
    
    -- ุงูุนุฏุงุฏุงุช
    old_meter_serial VARCHAR(100),
    old_meter_status VARCHAR(50), -- ูุณุชุฎุฏู/ูุฑุชุฌุน
    new_meter_serial VARCHAR(100),
    new_display_serial VARCHAR(100),
    new_seal_number VARCHAR(100),
    
    -- ุงูุญุงูุฉ
    status VARCHAR(50) DEFAULT 'draft',
    -- draft, pending_payment, ready_for_installation, in_progress, completed, cancelled
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP
);
```

#### 1.7.4 ุฏุงูุฉ ูุญุต ุฃูููุฉ ุงูุชุฑููุฉ

```sql
CREATE OR REPLACE FUNCTION check_upgrade_eligibility(p_customer_id UUID)
RETURNS TABLE (
    is_eligible BOOLEAN,
    customer_status VARCHAR(50),
    disconnection_months INT,
    applied_price DECIMAL(15,2),
    price_type VARCHAR(50)
) AS $$
DECLARE
    v_last_active_date DATE;
    v_months_disconnected INT;
    v_max_months INT;
    v_upgrade_price DECIMAL(15,2);
    v_new_price DECIMAL(15,2);
BEGIN
    -- ุฌูุจ ุขุฎุฑ ุชุงุฑูุฎ ูุดุงุท
    SELECT last_payment_date INTO v_last_active_date
    FROM customers WHERE id = p_customer_id;
    
    -- ุญุณุงุจ ุฃุดูุฑ ุงูุงููุทุงุน
    v_months_disconnected := EXTRACT(MONTH FROM AGE(NOW(), v_last_active_date));
    
    -- ุฌูุจ ุงูุฃุณุนุงุฑ ูุงูุดุฑูุท
    SELECT max_disconnection_months, upgrade_price, new_subscription_price
    INTO v_max_months, v_upgrade_price, v_new_price
    FROM upgrade_pricing
    WHERE from_type = 'postpaid' AND to_type = 'prepaid_sts' AND is_active = true
    LIMIT 1;
    
    -- ุชุญุฏูุฏ ุงูุฃูููุฉ
    IF v_months_disconnected <= v_max_months THEN
        RETURN QUERY SELECT 
            true, 'active'::VARCHAR, v_months_disconnected, v_upgrade_price, 'upgrade'::VARCHAR;
    ELSE
        RETURN QUERY SELECT 
            false, 'disconnected'::VARCHAR, v_months_disconnected, v_new_price, 'new_subscription'::VARCHAR;
    END IF;
END;
$$ LANGUAGE plpgsql;
```

#### 1.7.5 ุฏุงูุฉ ุฅูุบุงุก ุงูุชุฃููู ูุฅูุดุงุก ุณูุฏ

```sql
CREATE OR REPLACE FUNCTION cancel_deposit_for_upgrade(
    p_customer_id UUID,
    p_usage VARCHAR(50), -- apply_to_upgrade, refund, apply_to_debt
    p_upgrade_id UUID,
    p_created_by UUID
) RETURNS UUID AS $$
DECLARE
    v_voucher_id UUID;
    v_deposit_amount DECIMAL(15,2);
    v_debt_amount DECIMAL(15,2);
    v_applied_amount DECIMAL(15,2);
BEGIN
    -- ุฌูุจ ุฑุตูุฏ ุงูุชุฃููู
    SELECT deposit_amount INTO v_deposit_amount
    FROM customers WHERE id = p_customer_id;
    
    IF v_deposit_amount <= 0 THEN
        RETURN NULL; -- ูุง ููุฌุฏ ุชุฃููู
    END IF;
    
    -- ุฅูุดุงุก ุณูุฏ ุฅูุบุงุก ุงูุชุฃููู
    INSERT INTO vouchers (
        id, voucher_type, customer_id, amount, description,
        reference_type, reference_id, created_by
    ) VALUES (
        gen_random_uuid(), 'deposit_cancellation', p_customer_id, v_deposit_amount,
        'ุฅูุบุงุก ุชุฃููู ุจุณุจุจ ุงูุชุฑููุฉ ูุนุฏุงุฏ STS',
        'subscription_upgrade', p_upgrade_id, p_created_by
    ) RETURNING id INTO v_voucher_id;
    
    -- ุชุทุจูู ุญุณุจ ุงูุฎูุงุฑ
    CASE p_usage
        WHEN 'apply_to_upgrade' THEN
            -- ุฎุตู ูู ูุงุชูุฑุฉ ุงูุชุฑููุฉ
            UPDATE subscription_upgrades
            SET net_amount_due = applied_price - v_deposit_amount
            WHERE id = p_upgrade_id;
            
        WHEN 'apply_to_debt' THEN
            -- ุชุณุฏูุฏ ุงูุฏููู ุงููุงุฆูุฉ
            SELECT COALESCE(SUM(remaining_amount), 0) INTO v_debt_amount
            FROM invoices
            WHERE customer_id = p_customer_id AND status = 'posted';
            
            v_applied_amount := LEAST(v_deposit_amount, v_debt_amount);
            -- ุชุทุจูู ุงูุฏูุน ุนูู ุงูููุงุชูุฑ
            PERFORM apply_payment_to_invoices(p_customer_id, v_applied_amount);
            
        WHEN 'refund' THEN
            -- ุฅูุดุงุก ุฃูุฑ ุตุฑู ููุฏู
            INSERT INTO refund_requests (customer_id, amount, reason, voucher_id)
            VALUES (p_customer_id, v_deposit_amount, 'ุงุณุชุฑุฏุงุฏ ุชุฃููู ุจุณุจุจ ุงูุชุฑููุฉ', v_voucher_id);
    END CASE;
    
    -- ุชุตููุฑ ุฑุตูุฏ ุงูุชุฃููู
    UPDATE customers SET deposit_amount = 0 WHERE id = p_customer_id;
    
    RETURN v_voucher_id;
END;
$$ LANGUAGE plpgsql;
```

#### 1.7.6 ุฃูุฑ ุนูู ุงูุชุฑููุฉ - ุงูููุงุฏ ุงููุทููุจุฉ

| ุงููุงุฏุฉ | ุงููููุฉ | ููุงุญุธุงุช |
|--------|--------|----------|
| ุนุฏุงุฏ STS | 1 | ุฌุฏูุฏ |
| ุดุงุดุฉ ุนุฑุถ STS | 1 | ุฌุฏูุฏุฉ |
| ุฎุชู | 1 | ุฌุฏูุฏ |
| **ูุงุทุน** | **0** | **ุงููุงุทุน ุงููุฏูู ุณููุณุชุฎุฏู** |

#### 1.7.7 ุชุญุฏูุซ ุงููุฎุฒูู ุจุนุฏ ุงูุชุฑููุฉ

| ุงููููู | ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ | ุงููููุน |
|--------|--------------|--------|
| ุนุฏุงุฏ STS ุงูุฌุฏูุฏ | ูุฑูุจ ูุฏู ุงูุนููู | - |
| ุดุงุดุฉ ุงูุนุฑุถ ุงูุฌุฏูุฏุฉ | ูุฑูุจุฉ ูุฏู ุงูุนููู | - |
| ุงูุฎุชู ุงูุฌุฏูุฏ | ูุฑูุจ ูุฏู ุงูุนููู | - |
| **ุงูุนุฏุงุฏ ุงูุนุงุฏู ุงููุฏูู** | **ูุณุชุฎุฏู/ูุฑุชุฌุน** | **ูุฎุฒู ุงููุญุทุฉ - ูุณุชุนูู** |

#### 1.7.8 APIs ูุนุงูุฌ ุงูุชุฑููุฉ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | /api/v1/upgrade-wizard/start | ุจุฏุก ูุนุงูุฌ ุชุฑููุฉ ุฌุฏูุฏ |
| GET | /api/v1/upgrade-wizard/:id/eligibility | ูุญุต ุฃูููุฉ ุงูุชุฑููุฉ |
| POST | /api/v1/upgrade-wizard/:id/cancel-deposit | ุฅูุบุงุก ุงูุชุฃููู |
| POST | /api/v1/upgrade-wizard/:id/create-invoice | ุฅูุดุงุก ูุงุชูุฑุฉ ุงูุชุฑููุฉ |
| POST | /api/v1/upgrade-wizard/:id/create-work-order | ุฅูุดุงุก ุฃูุฑ ุงูุนูู |
| POST | /api/v1/upgrade-wizard/:id/confirm | ุชุฃููุฏ ูุฅุฑุณุงู |
| GET | /api/v1/upgrades | ูุงุฆูุฉ ุทูุจุงุช ุงูุชุฑููุฉ |
| GET | /api/v1/upgrades/:id | ุชูุงุตูู ุทูุจ ุชุฑููุฉ |

---

### 2. ุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงูุงุช ูุงูุนุฏุงุฏุงุช

#### 2.1 ุฌุฏูู ุงูุงุดุชุฑุงูุงุช (subscriptions)
```sql
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY,
    subscription_number VARCHAR(20) UNIQUE NOT NULL,
    customer_id UUID REFERENCES customers(id),
    
    -- ููุน ุงูุงุดุชุฑุงู
    subscription_type VARCHAR(50), -- prepaid, postpaid
    service_type VARCHAR(50), -- electricity, solar
    
    -- ุงูุนุฏุงุฏ
    meter_id UUID REFERENCES meters(id),
    meter_number VARCHAR(50),
    
    -- ุงูุชุนุฑูุฉ
    tariff_id UUID REFERENCES tariffs(id),
    
    -- ุงูุญูู
    contracted_load DECIMAL(10,2), -- KW
    actual_load DECIMAL(10,2),
    
    -- ุงูุชูุงุฑูุฎ
    start_date DATE NOT NULL,
    end_date DATE,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'active', -- active, suspended, terminated
    
    -- ุงูุถูุงู
    deposit_amount DECIMAL(15,2) DEFAULT 0,
    deposit_paid BOOLEAN DEFAULT false,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 2.2 ุฌุฏูู ุงูุชุนุฑูุงุช (tariffs)
```sql
CREATE TABLE tariffs (
    id UUID PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    
    customer_type VARCHAR(50), -- residential, commercial, industrial
    
    -- ุงูุชุณุนูุฑ
    pricing_type VARCHAR(50), -- flat, tiered, time_of_use
    base_rate DECIMAL(10,4), -- ุณุนุฑ ุงููุญุฏุฉ ุงูุฃุณุงุณู
    
    -- ุงูุฑุณูู ุงูุซุงุจุชุฉ
    fixed_charge DECIMAL(15,2) DEFAULT 0,
    meter_rent DECIMAL(15,2) DEFAULT 0,
    
    -- ุงูุถุฑุงุฆุจ
    tax_rate DECIMAL(5,2) DEFAULT 0,
    
    -- ุงููุชุฑุฉ
    effective_from DATE NOT NULL,
    effective_to DATE,
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 2.3 ุฌุฏูู ุดุฑุงุฆุญ ุงูุชุนุฑูุฉ (tariff_tiers)
```sql
CREATE TABLE tariff_tiers (
    id UUID PRIMARY KEY,
    tariff_id UUID REFERENCES tariffs(id),
    
    tier_number INTEGER NOT NULL,
    from_units DECIMAL(15,3) NOT NULL,
    to_units DECIMAL(15,3),
    rate DECIMAL(10,4) NOT NULL,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 2.4 ุฌุฏูู ุฃุณุนุงุฑ ุงูุงุดุชุฑุงู ูุงูุชุฃููู (subscription_pricing)
```sql
CREATE TABLE subscription_pricing (
    id UUID PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    
    -- ููุน ุงูุงุดุชุฑุงู
    customer_type VARCHAR(50) NOT NULL, -- residential, commercial, industrial
    
    -- ุฑุณูู ุงูุงุดุชุฑุงู
    subscription_fee DECIMAL(15,2) NOT NULL, -- ุฑุณู ุงูุงุดุชุฑุงู ููุฑุฉ ูุงุญุฏุฉ
    connection_fee DECIMAL(15,2) DEFAULT 0, -- ุฑุณู ุงูุชูุตูู
    meter_cost DECIMAL(15,2) DEFAULT 0, -- ุชูููุฉ ุงูุนุฏุงุฏ (ุฅู ูุฌุฏ)
    
    -- ุงูุชุฃููู
    deposit_amount DECIMAL(15,2) NOT NULL, -- ูุจูุบ ุงูุชุฃููู ุงููุทููุจ
    deposit_refundable BOOLEAN DEFAULT true, -- ูุงุจู ููุงุณุชุฑุฏุงุฏ
    
    -- ุงูุฅุฌูุงูู
    total_required DECIMAL(15,2) GENERATED ALWAYS AS (
        subscription_fee + connection_fee + meter_cost + deposit_amount
    ) STORED,
    
    -- ุงููุชุฑุฉ
    effective_from DATE NOT NULL,
    effective_to DATE,
    
    is_active BOOLEAN DEFAULT true,
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ุงูุฃุณุนุงุฑ ุงูุงูุชุฑุงุถูุฉ
INSERT INTO subscription_pricing (code, name, customer_type, subscription_fee, deposit_amount, effective_from) VALUES
('RES_STD', 'ุงุดุชุฑุงู ุณููู ุนุงุฏู', 'residential', 5000, 10000, CURRENT_DATE),
('COM_STD', 'ุงุดุชุฑุงู ุชุฌุงุฑู ุนุงุฏู', 'commercial', 10000, 25000, CURRENT_DATE),
('IND_STD', 'ุงุดุชุฑุงู ุตูุงุนู ุนุงุฏู', 'industrial', 20000, 50000, CURRENT_DATE);
```

#### 2.5 ุญุณุงุจ ูุจุงูุบ ุงูุงุดุชุฑุงู ุงูุชููุงุฆู
```python
def calculate_subscription_amounts(customer_type: str) -> dict:
    """
    ุญุณุงุจ ูุจุงูุบ ุงูุงุดุชุฑุงู ูุงูุชุฃููู ุชููุงุฆูุงู ุญุณุจ ููุน ุงูุงุดุชุฑุงู
    """
    pricing = db.query("""
        SELECT * FROM subscription_pricing
        WHERE customer_type = :type
        AND is_active = true
        AND (effective_to IS NULL OR effective_to >= CURRENT_DATE)
        ORDER BY effective_from DESC
        LIMIT 1
    """, {'type': customer_type})
    
    if not pricing:
        raise ValueError(f"ูุง ุชูุฌุฏ ุฃุณุนุงุฑ ูููุน ุงูุงุดุชุฑุงู: {customer_type}")
    
    return {
        'subscription_fee': pricing.subscription_fee,
        'connection_fee': pricing.connection_fee,
        'meter_cost': pricing.meter_cost,
        'deposit_amount': pricing.deposit_amount,
        'total_required': pricing.total_required
    }
```

---

### 3. ูุฑุงุกุฉ ุงูุนุฏุงุฏุงุช ูุงูุงุณุชููุงู

#### 3.1 ุฌุฏูู ูุฑุงุกุงุช ุงูุนุฏุงุฏุงุช (meter_readings)
```sql
CREATE TABLE meter_readings (
    id UUID PRIMARY KEY,
    meter_id UUID REFERENCES meters(id),
    subscription_id UUID REFERENCES subscriptions(id),
    
    reading_date DATE NOT NULL,
    reading_type VARCHAR(50), -- scheduled, actual, estimated, adjustment
    
    previous_reading DECIMAL(15,3),
    current_reading DECIMAL(15,3) NOT NULL,
    consumption DECIMAL(15,3) GENERATED ALWAYS AS (current_reading - previous_reading) STORED,
    
    -- ููุนุฏุงุฏุงุช ุงูุฐููุฉ
    peak_consumption DECIMAL(15,3),
    off_peak_consumption DECIMAL(15,3),
    reactive_power DECIMAL(15,3),
    power_factor DECIMAL(5,3),
    
    -- ุงูุชุญูู
    is_verified BOOLEAN DEFAULT false,
    verification_notes TEXT,
    
    -- ุงููุฑุงุกุฉ
    read_by UUID REFERENCES users(id),
    reading_method VARCHAR(50), -- manual, automatic, remote
    
    -- ุงูุตูุฑ
    image_path VARCHAR(500),
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 3.2 ุฌุฏูู ุฏูุฑุงุช ุงูููุชุฑุฉ (billing_cycles)
```sql
CREATE TABLE billing_cycles (
    id UUID PRIMARY KEY,
    cycle_code VARCHAR(20) UNIQUE NOT NULL,
    cycle_name VARCHAR(100),
    
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    reading_start_date DATE,
    reading_end_date DATE,
    billing_date DATE,
    due_date DATE,
    
    status VARCHAR(20) DEFAULT 'open', -- open, reading, billing, closed
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 4. ุงูููุชุฑุฉ (ุงููููุฉ 0.3 + ุงููุธุงู 2)

#### 4.1 ุฌุฏูู ุงูููุงุชูุฑ (invoices)
```sql
CREATE TABLE invoices (
    id UUID PRIMARY KEY,
    invoice_number VARCHAR(50) UNIQUE NOT NULL,
    
    customer_id UUID REFERENCES customers(id),
    subscription_id UUID REFERENCES subscriptions(id),
    billing_cycle_id UUID REFERENCES billing_cycles(id),
    
    invoice_date DATE NOT NULL,
    due_date DATE NOT NULL,
    
    -- ูุชุฑุฉ ุงููุงุชูุฑุฉ
    period_from DATE,
    period_to DATE,
    
    -- ุงููุฑุงุกุงุช
    previous_reading DECIMAL(15,3),
    current_reading DECIMAL(15,3),
    consumption DECIMAL(15,3),
    
    -- ุงููุจุงูุบ
    energy_charges DECIMAL(15,2), -- ุฑุณูู ุงูุงุณุชููุงู
    fixed_charges DECIMAL(15,2), -- ุฑุณูู ุซุงุจุชุฉ
    meter_rent DECIMAL(15,2), -- ุฅูุฌุงุฑ ุงูุนุฏุงุฏ
    other_charges DECIMAL(15,2), -- ุฑุณูู ุฃุฎุฑู
    
    subtotal DECIMAL(15,2),
    tax_amount DECIMAL(15,2),
    discount_amount DECIMAL(15,2),
    
    previous_balance DECIMAL(15,2) DEFAULT 0, -- ุฑุตูุฏ ุณุงุจู
    total_amount DECIMAL(15,2),
    
    paid_amount DECIMAL(15,2) DEFAULT 0,
    remaining_amount DECIMAL(15,2),
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'draft', -- draft, issued, sent, partial, paid, overdue, cancelled
    
    -- ุงูุฅุฑุณุงู
    sent_date TIMESTAMP,
    sent_method VARCHAR(50), -- email, sms, print
    
    notes TEXT,
    
    created_by UUID REFERENCES users(id),
    issued_by UUID REFERENCES users(id),
    issued_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.2 ุฌุฏูู ุจููุฏ ุงููุงุชูุฑุฉ (invoice_items)
```sql
CREATE TABLE invoice_items (
    id UUID PRIMARY KEY,
    invoice_id UUID REFERENCES invoices(id),
    
    item_type VARCHAR(50), -- energy, fixed, meter_rent, penalty, adjustment, other
    description VARCHAR(200),
    
    quantity DECIMAL(15,3),
    unit_price DECIMAL(15,4),
    amount DECIMAL(15,2),
    
    tax_rate DECIMAL(5,2) DEFAULT 0,
    tax_amount DECIMAL(15,2) DEFAULT 0,
    
    discount_rate DECIMAL(5,2) DEFAULT 0,
    discount_amount DECIMAL(15,2) DEFAULT 0,
    
    net_amount DECIMAL(15,2),
    
    -- ููุดุฑุงุฆุญ
    tier_number INTEGER,
    from_units DECIMAL(15,3),
    to_units DECIMAL(15,3),
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.3 ุฌุฏูู ุงูููุงุชูุฑ ุงูุฏูุฑูุฉ (recurring_invoices) - ุงููููุฉ 4.1
```sql
CREATE TABLE recurring_invoices (
    id UUID PRIMARY KEY,
    template_name VARCHAR(100),
    
    customer_id UUID REFERENCES customers(id),
    subscription_id UUID REFERENCES subscriptions(id),
    
    frequency VARCHAR(20), -- monthly, quarterly, yearly
    day_of_month INTEGER,
    
    -- ุงููุจุงูุบ ุงูุซุงุจุชุฉ
    fixed_amount DECIMAL(15,2),
    
    start_date DATE NOT NULL,
    end_date DATE,
    next_invoice_date DATE,
    
    is_active BOOLEAN DEFAULT true,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.4 ุฌุฏูู ููุงูุจ ุงูููุงุชูุฑ (invoice_templates) - ุงููููุฉ 4.2
```sql
CREATE TABLE invoice_templates (
    id UUID PRIMARY KEY,
    template_code VARCHAR(20) UNIQUE NOT NULL,
    template_name VARCHAR(100),
    
    customer_type VARCHAR(50),
    
    -- ุงูุชุตููู
    header_text TEXT,
    footer_text TEXT,
    terms_text TEXT,
    
    logo_path VARCHAR(500),
    
    -- ุงูุฅุนุฏุงุฏุงุช
    show_consumption_chart BOOLEAN DEFAULT true,
    show_payment_history BOOLEAN DEFAULT true,
    show_comparison BOOLEAN DEFAULT false,
    
    is_default BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 5. ุงูุชุญุตูู ูุงููุฏููุนุงุช (ุงููููุฉ 0.3.2 + ุงููุธุงู 2)

#### 5.1 ุฌุฏูู ุงููุฏููุนุงุช (payments)
```sql
CREATE TABLE payments (
    id UUID PRIMARY KEY,
    payment_number VARCHAR(50) UNIQUE NOT NULL,
    
    customer_id UUID REFERENCES customers(id),
    
    payment_date DATE NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    
    payment_method VARCHAR(50), -- cash, bank_transfer, check, card, mobile_wallet, sts
    
    -- ุชูุงุตูู ุงูุฏูุน
    reference_number VARCHAR(100),
    bank_name VARCHAR(100),
    check_number VARCHAR(50),
    check_date DATE,
    card_last_four VARCHAR(4),
    
    -- ููุฏูุน ุงููุณุจู (STS)
    sts_token VARCHAR(50),
    sts_units DECIMAL(15,3),
    
    -- ุงูุชูุฒูุน
    allocated_amount DECIMAL(15,2) DEFAULT 0,
    unallocated_amount DECIMAL(15,2),
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending', -- pending, completed, bounced, cancelled
    
    -- ุงููููุน
    collection_point VARCHAR(100), -- office, field, online, bank
    collected_by UUID REFERENCES users(id),
    
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 5.2 ุฌุฏูู ุชูุฒูุน ุงููุฏููุนุงุช (payment_allocations)
```sql
CREATE TABLE payment_allocations (
    id UUID PRIMARY KEY,
    payment_id UUID REFERENCES payments(id),
    invoice_id UUID REFERENCES invoices(id),
    
    amount DECIMAL(15,2) NOT NULL,
    allocation_date DATE NOT NULL,
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 5.3 ุฌุฏูู ุทุฑู ุงูุฏูุน (payment_methods)
```sql
CREATE TABLE payment_methods (
    id UUID PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    
    method_type VARCHAR(50), -- cash, bank, card, digital
    
    -- ุงูุฅุนุฏุงุฏุงุช
    requires_reference BOOLEAN DEFAULT false,
    requires_approval BOOLEAN DEFAULT false,
    
    -- ุงูุฑุณูู
    fee_type VARCHAR(20), -- fixed, percentage
    fee_amount DECIMAL(15,2) DEFAULT 0,
    fee_percentage DECIMAL(5,2) DEFAULT 0,
    
    -- ุงูุฑุจุท ุงููุญุงุณุจู
    account_id UUID REFERENCES accounts(id),
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 6. ุงูุฏูุน ุงููุณุจู - STS (ุงููููุฉ 5.2)

#### 6.1 ุฌุฏูู ูุนุงููุงุช STS (sts_transactions)
```sql
CREATE TABLE sts_transactions (
    id UUID PRIMARY KEY,
    transaction_number VARCHAR(50) UNIQUE NOT NULL,
    
    customer_id UUID REFERENCES customers(id),
    meter_id UUID REFERENCES meters(id),
    
    transaction_date TIMESTAMP NOT NULL,
    
    -- ุงููุจูุบ ูุงููุญุฏุงุช
    amount DECIMAL(15,2) NOT NULL,
    units DECIMAL(15,3) NOT NULL,
    rate DECIMAL(10,4),
    
    -- ุงูุชููู
    token VARCHAR(50) NOT NULL,
    token_type VARCHAR(20), -- credit, clear_tamper, set_tariff
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'generated', -- generated, sent, applied, failed
    applied_at TIMESTAMP,
    
    -- ุงูุฏูุน
    payment_id UUID REFERENCES payments(id),
    
    -- ุงูุทุจุงุนุฉ
    is_printed BOOLEAN DEFAULT false,
    printed_at TIMESTAMP,
    printed_by UUID REFERENCES users(id),
    print_count INTEGER DEFAULT 0,
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 6.2 ุฌุฏูู ุฃุฑุตุฏุฉ ุงูุฏูุน ุงููุณุจู (prepaid_balances)
```sql
CREATE TABLE prepaid_balances (
    id UUID PRIMARY KEY,
    customer_id UUID REFERENCES customers(id),
    meter_id UUID REFERENCES meters(id),
    
    current_balance DECIMAL(15,3) DEFAULT 0, -- ุจุงููุญุฏุงุช
    monetary_balance DECIMAL(15,2) DEFAULT 0, -- ุจุงูุนููุฉ
    
    last_recharge_date TIMESTAMP,
    last_consumption_date TIMESTAMP,
    
    -- ุงูุชูุจููุงุช
    low_balance_threshold DECIMAL(15,3),
    emergency_credit DECIMAL(15,3) DEFAULT 0,
    emergency_credit_used BOOLEAN DEFAULT false,
    
    updated_at TIMESTAMP DEFAULT NOW()
);
```

---

### 7. ุฅุฏุงุฑุฉ ุงูุฏููู ูุงููุชุฃุฎุฑุงุช (ุงููููุฉ 6)

#### 7.1 ุฌุฏูู ุงูุฏููู (debts)
```sql
CREATE TABLE debts (
    id UUID PRIMARY KEY,
    customer_id UUID REFERENCES customers(id),
    
    debt_type VARCHAR(50), -- invoice, penalty, reconnection, other
    reference_id UUID, -- invoice_id or other
    
    original_amount DECIMAL(15,2) NOT NULL,
    paid_amount DECIMAL(15,2) DEFAULT 0,
    remaining_amount DECIMAL(15,2),
    
    due_date DATE,
    overdue_days INTEGER GENERATED ALWAYS AS (CURRENT_DATE - due_date) STORED,
    
    -- ุงูููุงุฆุฏ ูุงูุบุฑุงูุงุช
    penalty_amount DECIMAL(15,2) DEFAULT 0,
    interest_amount DECIMAL(15,2) DEFAULT 0,
    
    status VARCHAR(20) DEFAULT 'outstanding', -- outstanding, partial, paid, written_off, disputed
    
    -- ุฎุทุฉ ุงูุณุฏุงุฏ
    payment_plan_id UUID REFERENCES payment_plans(id),
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 7.2 ุฌุฏูู ุฎุทุท ุงูุณุฏุงุฏ (payment_plans) - ุงููููุฉ 6.2
```sql
CREATE TABLE payment_plans (
    id UUID PRIMARY KEY,
    plan_number VARCHAR(50) UNIQUE NOT NULL,
    
    customer_id UUID REFERENCES customers(id),
    
    total_amount DECIMAL(15,2) NOT NULL,
    down_payment DECIMAL(15,2) DEFAULT 0,
    remaining_amount DECIMAL(15,2),
    
    number_of_installments INTEGER NOT NULL,
    installment_amount DECIMAL(15,2),
    
    start_date DATE NOT NULL,
    end_date DATE,
    
    -- ุงูุดุฑูุท
    interest_rate DECIMAL(5,2) DEFAULT 0,
    penalty_on_late DECIMAL(15,2) DEFAULT 0,
    
    status VARCHAR(20) DEFAULT 'active', -- active, completed, defaulted, cancelled
    
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 7.3 ุฌุฏูู ุฃูุณุงุท ุฎุทุฉ ุงูุณุฏุงุฏ (payment_plan_installments)
```sql
CREATE TABLE payment_plan_installments (
    id UUID PRIMARY KEY,
    plan_id UUID REFERENCES payment_plans(id),
    
    installment_number INTEGER NOT NULL,
    due_date DATE NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    
    paid_amount DECIMAL(15,2) DEFAULT 0,
    paid_date DATE,
    payment_id UUID REFERENCES payments(id),
    
    status VARCHAR(20) DEFAULT 'pending', -- pending, paid, overdue, partial
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 8. ุงูุชุฐููุฑุงุช ูุงูุฅุดุนุงุฑุงุช (ุงููููุฉ 0.3.3 + ุงููููุฉ 6.3)

#### 8.1 ุฌุฏูู ููุงูุจ ุงูุฅุดุนุงุฑุงุช (notification_templates)

```sql
CREATE TABLE notification_templates (
    id UUID PRIMARY KEY,
    business_id UUID NOT NULL,
    
    template_code VARCHAR(50) UNIQUE NOT NULL, -- invoice_created, payment_reminder, payment_received
    template_name VARCHAR(100) NOT NULL,
    
    -- ุงูููุงุฉ
    channel VARCHAR(50) NOT NULL, -- sms, whatsapp, email, push
    
    -- ุงููุญุชูู
    subject VARCHAR(200), -- ููุจุฑูุฏ ุงูุฅููุชุฑููู
    body_template TEXT NOT NULL, -- ูุฏุนู ุงููุชุบูุฑุงุช {{customer_name}}, {{amount}}, {{due_date}}
    
    -- ุงููุชุบูุฑุงุช ุงููุชุงุญุฉ
    available_variables JSONB, -- ["ุงุณู_ุงูุนููู", "ุงููุจูุบ", "ุชุงุฑูุฎ_ุงูุงุณุชุญูุงู"]
    
    -- ุงูุฅุนุฏุงุฏุงุช
    is_active BOOLEAN DEFAULT true,
    is_system BOOLEAN DEFAULT false, -- ููุงูุจ ุงููุธุงู ูุง ูููู ุญุฐููุง
    
    -- ุงููุบุฉ
    language VARCHAR(10) DEFAULT 'ar', -- ar, en
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 8.2 ุงูููุงูุจ ุงูุงูุชุฑุงุถูุฉ

| ุงูููุฏ | ุงูุงุณู | ุงูููุงุฉ | ุงููุต |
|------|------|--------|------|
| `invoice_created` | ุฅุดุนุงุฑ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ | SMS | "ุนุฒูุฒู {{customer_name}}ุ ุชู ุฅุตุฏุงุฑ ูุงุชูุฑุฉ ุจูุจูุบ {{amount}} ุฑูุงู. ุงูุงุณุชุญูุงู: {{due_date}}" |
| `payment_reminder` | ุชุฐููุฑ ุจุงูุฏูุน | SMS | "ุชุฐููุฑ: ูุงุชูุฑุชู ุจูุจูุบ {{amount}} ุฑูุงู ูุณุชุญูุฉ ุจุชุงุฑูุฎ {{due_date}}. ููุฏูุน: {{payment_link}}" |
| `payment_received` | ุชุฃููุฏ ุงูุฏูุน | SMS | "ุดูุฑุงู {{customer_name}}ุ ุชู ุงุณุชูุงู ุฏูุนุชู ุจูุจูุบ {{amount}} ุฑูุงู. ุฑุตูุฏู ุงูุญุงูู: {{balance}}" |
| `overdue_notice` | ุฅุดุนุงุฑ ุชุฃุฎุฑ | SMS | "ุชูุจูู: ูุงุชูุฑุชู ุจูุจูุบ {{amount}} ุฑูุงู ูุชุฃุฎุฑุฉ {{days_overdue}} ููู. ูุฑุฌู ุงูุณุฏุงุฏ ูุชุฌูุจ ุงููุตู." |
| `disconnection_warning` | ุชุญุฐูุฑ ูุตู | SMS | "ุชุญุฐูุฑ: ุณูุชู ูุตู ุงูุฎุฏูุฉ ุฎูุงู {{days_remaining}} ููู ุฅุฐุง ูู ูุชู ุณุฏุงุฏ {{amount}} ุฑูุงู." |
| `sts_token` | ุฑูุฒ ุงูุดุญู | SMS | "ุฑูุฒ ุงูุดุญู ุงูุฎุงุต ุจู: {{token}}. ุงููุจูุบ: {{amount}} ุฑูุงู = {{kwh}} ูููููุงุช." |

#### 8.3 ๐ป ุดุงุดุฉ ุฅุฏุงุฑุฉ ููุงูุจ ุงูุฅุดุนุงุฑุงุช

**ุงูุบุฑุถ:** ุชุฎุตูุต ูุตูุต ุฑุณุงุฆู SMS ู WhatsApp ูุงูุจุฑูุฏ ุงูุฅููุชุฑููู.

**ุงูููููุงุช:**

| ุงูุนูุตุฑ | ุงููุตู |
|--------|------|
| ูุงุฆูุฉ ุงูููุงูุจ | ุนุฑุถ ุฌููุน ุงูููุงูุจ ูุน ุงูููุชุฑุฉ ุญุณุจ ุงูููุงุฉ |
| ูุญุฑุฑ ุงููุงูุจ | ุชุนุฏูู ุงููุต ูุน ุนุฑุถ ุงููุชุบูุฑุงุช ุงููุชุงุญุฉ |
| ูุนุงููุฉ | ุนุฑุถ ุงูุฑุณุงูุฉ ููุง ุณุชุธูุฑ ููุนููู |
| ุฅุฑุณุงู ุชุฌุฑูุจู | ุฅุฑุณุงู ุฑุณุงูุฉ ุงุฎุชุจุงุฑูุฉ ูุฑูู ูุญุฏุฏ |

**ุงููุชุบูุฑุงุช ุงููุชุงุญุฉ:**

| ุงููุชุบูุฑ | ุงููุตู |
|--------|------|
| `{{customer_name}}` | ุงุณู ุงูุนููู |
| `{{customer_number}}` | ุฑูู ุงูุนููู |
| `{{amount}}` | ุงููุจูุบ |
| `{{balance}}` | ุงูุฑุตูุฏ ุงูุญุงูู |
| `{{due_date}}` | ุชุงุฑูุฎ ุงูุงุณุชุญูุงู |
| `{{invoice_number}}` | ุฑูู ุงููุงุชูุฑุฉ |
| `{{payment_link}}` | ุฑุงุจุท ุงูุฏูุน |
| `{{token}}` | ุฑูุฒ STS |
| `{{kwh}}` | ุงููููููุงุช |
| `{{days_overdue}}` | ุฃูุงู ุงูุชุฃุฎูุฑ |
| `{{days_remaining}}` | ุงูุฃูุงู ุงููุชุจููุฉ |

#### 8.4 ุฌุฏูู ุงูุชุฐููุฑุงุช (reminders)
```sql
CREATE TABLE reminders (
    id UUID PRIMARY KEY,
    
    customer_id UUID REFERENCES customers(id),
    invoice_id UUID REFERENCES invoices(id),
    debt_id UUID REFERENCES debts(id),
    
    reminder_type VARCHAR(50), -- due_date, overdue, disconnection_warning, payment_confirmation
    reminder_level INTEGER DEFAULT 1, -- 1, 2, 3 (escalation)
    
    scheduled_date TIMESTAMP NOT NULL,
    sent_date TIMESTAMP,
    
    channel VARCHAR(50), -- sms, email, push, call
    
    message_template VARCHAR(100),
    message_content TEXT,
    
    status VARCHAR(20) DEFAULT 'pending', -- pending, sent, failed, cancelled
    failure_reason TEXT,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 8.2 ุฌุฏูู ุณุฌู ุงูุงุชุตุงูุงุช (communication_log)
```sql
CREATE TABLE communication_log (
    id UUID PRIMARY KEY,
    
    customer_id UUID REFERENCES customers(id),
    
    communication_type VARCHAR(50), -- sms, email, call, visit, letter
    direction VARCHAR(20), -- outbound, inbound
    
    subject VARCHAR(200),
    content TEXT,
    
    -- ููููุงููุงุช
    call_duration INTEGER, -- ุจุงูุซูุงูู
    call_outcome VARCHAR(50), -- answered, no_answer, busy, voicemail
    
    -- ููุฒูุงุฑุงุช
    visit_address TEXT,
    visit_outcome VARCHAR(50),
    
    handled_by UUID REFERENCES users(id),
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 9. ุฅุฌุฑุงุกุงุช ุงููุตู ูุงูุชูุตูู

#### 9.1 ุฌุฏูู ุฃูุงูุฑ ุงููุตู/ุงูุชูุตูู (disconnection_orders)
```sql
CREATE TABLE disconnection_orders (
    id UUID PRIMARY KEY,
    order_number VARCHAR(50) UNIQUE NOT NULL,
    
    customer_id UUID REFERENCES customers(id),
    subscription_id UUID REFERENCES subscriptions(id),
    
    order_type VARCHAR(50), -- disconnection, reconnection
    reason VARCHAR(100), -- non_payment, customer_request, violation, maintenance
    
    order_date DATE NOT NULL,
    scheduled_date DATE,
    executed_date DATE,
    
    -- ูููุตู
    outstanding_amount DECIMAL(15,2),
    warning_sent BOOLEAN DEFAULT false,
    warning_date DATE,
    
    -- ููุชูุตูู
    reconnection_fee DECIMAL(15,2),
    fee_paid BOOLEAN DEFAULT false,
    
    status VARCHAR(20) DEFAULT 'pending', -- pending, scheduled, executed, cancelled
    
    -- ุงูุชูููุฐ
    executed_by UUID REFERENCES users(id),
    field_operation_id UUID, -- ุฑุจุท ูุน ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ
    
    notes TEXT,
    
    created_by UUID REFERENCES users(id),
    approved_by UUID REFERENCES users(id),
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 10. ุงูุชูุงุฑูุฑ ูุงูุชุญูููุงุช (ุงููููุฉ 7 + 0.5)

#### 10.1 ุงูุชูุงุฑูุฑ ุงููุชุงุญุฉ
| ุงูุชูุฑูุฑ | ุงููุตู |
|---------|-------|
| ุชูุฑูุฑ ุงูููุงุชูุฑ | ููุงุชูุฑ ุงููุชุฑุฉ ุญุณุจ ุงูุญุงูุฉ |
| ุชูุฑูุฑ ุงูุชุญุตูู | ุงููุฏููุนุงุช ูุงูุชุญุตูู |
| ุชูุฑูุฑ ุงููุชุฃุฎุฑุงุช | ุงูุฏููู ูุงููุชุฃุฎุฑุงุช |
| ุชูุฑูุฑ ุฃุนูุงุฑ ุงูุฏููู | ุชุญููู ุนูุฑ ุงูุฏููู |
| ุชูุฑูุฑ ุงูุงุณุชููุงู | ุงุณุชููุงู ุงูุนููุงุก |
| ุชูุฑูุฑ ุงูุฅูุฑุงุฏุงุช | ุฅูุฑุงุฏุงุช ุงููุชุฑุฉ |
| ุชูุฑูุฑ ุงูุนููุงุก | ุฅุญุตุงุฆูุงุช ุงูุนููุงุก |
| ุชูุฑูุฑ ุงููุตู/ุงูุชูุตูู | ุญุงูุงุช ุงููุตู ูุงูุชูุตูู |

#### 10.2 ุฌุฏูู ููุฎุตุงุช ุงูุนููุงุก (customer_summaries)
```sql
CREATE TABLE customer_summaries (
    id UUID PRIMARY KEY,
    customer_id UUID REFERENCES customers(id),
    
    period_year INTEGER,
    period_month INTEGER,
    
    -- ุงูุงุณุชููุงู
    total_consumption DECIMAL(15,3),
    avg_daily_consumption DECIMAL(15,3),
    
    -- ุงููุงูู
    total_invoiced DECIMAL(15,2),
    total_paid DECIMAL(15,2),
    outstanding_balance DECIMAL(15,2),
    
    -- ุงูุณููู
    on_time_payments INTEGER,
    late_payments INTEGER,
    payment_score DECIMAL(5,2), -- 0-100
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 9. ูุธุงู ูุฑุงูุจุฉ ุงูุชุฃูููุงุช ูุงููุฏููููุงุช (Security Deposit Monitoring)

> **ุงูุบุฑุถ:** ูุฑุงูุจุฉ ุชุฌุงูุฒ ุงููุฏููููุฉ ููุจูุบ ุงูุชุฃููู ูุงุชุฎุงุฐ ุงูุฅุฌุฑุงุกุงุช ุงูููุงุณุจุฉ

#### 9.1 ุญุงูุฉ "ูุชุฌุงูุฒ ููุชุฃููู" (deposit_exceeded)

**ุญุงูุงุช ุงูุนููู ุงูููุณุนุฉ:**
| ุงูุญุงูุฉ | ุงููุตู | ุงูุฅุฌุฑุงุก |
|--------|-------|--------|
| active | ูุดุท | ุงูุฎุฏูุฉ ุทุจูุนูุฉ |
| **deposit_exceeded** | **ูุชุฌุงูุฒ ููุชุฃููู** | **ุชูุจูู + ููุน ุนูููุงุช** |
| suspended | ููููู | ุงูุฎุฏูุฉ ูููููุฉ ูุคูุชุงู |
| disconnected | ููุตูู | ุงูุฎุฏูุฉ ููุทูุนุฉ |
| inactive | ุบูุฑ ูุดุท | ุงูุญุณุงุจ ูุบูู |

#### 9.2 Scheduled Job: ูุฑุงูุจุฉ ุงููุฏููููุฉ ููุงุจู ุงูุชุฃููู

```python
# ุชุนูู ููููุงู ุงูุณุงุนุฉ 6 ุตุจุงุญุงู
@scheduled_job(cron="0 6 * * *")
def monitor_deposit_vs_debt():
    """
    ูุฑุงูุจุฉ ุชุฌุงูุฒ ุงููุฏููููุฉ ููุจูุบ ุงูุชุฃููู
    """
    # 1. ุฌูุจ ุฌููุน ุงูุนููุงุก ุงููุดุทูู ูุน ุฃุฑุตุฏุชูู
    customers = db.query("""
        SELECT 
            c.id,
            c.customer_number,
            c.name,
            c.mobile,
            c.status,
            c.meter_id,
            s.deposit_amount,
            COALESCE(SUM(d.remaining_amount), 0) as total_debt
        FROM customers c
        LEFT JOIN subscriptions s ON c.id = s.customer_id AND s.status = 'active'
        LEFT JOIN debts d ON c.id = d.customer_id AND d.status IN ('outstanding', 'partial')
        WHERE c.status IN ('active', 'deposit_exceeded')
        GROUP BY c.id, c.customer_number, c.name, c.mobile, c.status, c.meter_id, s.deposit_amount
    """)
    
    exceeded_count = 0
    resolved_count = 0
    
    for customer in customers:
        debt_exceeds_deposit = customer.total_debt > customer.deposit_amount
        
        if debt_exceeds_deposit and customer.status != 'deposit_exceeded':
            # ุงููุฏููููุฉ ุชุฌุงูุฒุช ุงูุชุฃููู - ุชุบููุฑ ุงูุญุงูุฉ
            handle_deposit_exceeded(customer)
            exceeded_count += 1
            
        elif not debt_exceeds_deposit and customer.status == 'deposit_exceeded':
            # ุงูุนููู ุณุฏุฏ ูุงููุฏููููุฉ ุฃุตุจุญุช ุฃูู ูู ุงูุชุฃููู
            resolve_deposit_exceeded(customer)
            resolved_count += 1
    
    log.info(f"ูุฑุงูุจุฉ ุงูุชุฃูููุงุช: {exceeded_count} ุชุฌุงูุฒ ุฌุฏูุฏ, {resolved_count} ุชูุช ุชุณููุชู")
```

#### 9.3 ูุนุงูุฌุฉ ุชุฌุงูุฒ ุงูุชุฃููู

```python
def handle_deposit_exceeded(customer):
    """
    ูุนุงูุฌุฉ ุญุงูุฉ ุชุฌุงูุฒ ุงููุฏููููุฉ ููุชุฃููู
    """
    # 1. ุชุบููุฑ ุญุงูุฉ ุงูุนููู
    Customer.update(
        id=customer.id,
        status='deposit_exceeded',
        suspension_reason=f'ุงููุฏููููุฉ ({customer.total_debt}) ุชุฌุงูุฒุช ุงูุชุฃููู ({customer.deposit_amount})'
    )
    
    # 2. ุฅุฑุณุงู ุชูุจูู ููุฅุฏุงุฑุฉ
    Alert.create(
        alert_type='deposit_exceeded',
        severity='high',
        title=f'ุชุฌุงูุฒ ุงูุชุฃููู - {customer.name}',
        message=f'''
            ุงูุนููู: {customer.name} ({customer.customer_number})
            ุงูุชุฃููู: {customer.deposit_amount} ุฑูุงู
            ุงููุฏููููุฉ: {customer.total_debt} ุฑูุงู
            ุงูุชุฌุงูุฒ: {customer.total_debt - customer.deposit_amount} ุฑูุงู
        ''',
        reference_type='customer',
        reference_id=customer.id
    )
    
    # 3. ุฅุฑุณุงู ุฅุดุนุงุฑ ููุนููู
    send_sms(
        to=customer.mobile,
        template='deposit_exceeded',
        variables={
            'customer_name': customer.name,
            'deposit_amount': customer.deposit_amount,
            'debt_amount': customer.total_debt
        }
    )
    
    # 4. ุชูุนูู ุงููุตู ุงูุชููุงุฆู (ููุนุฏุงุฏุงุช ุงูุฐููุฉ)
    if customer.meter_id:
        meter = Meter.get(customer.meter_id)
        if meter.meter_type == 'smart':
            AcrelAPI.disconnect_meter(meter.acrel_meter_id)
            log.info(f"ุชู ูุตู ุงูุนุฏุงุฏ ุงูุฐูู ููุนููู {customer.customer_number}")
    
    # 5. ุชุณุฌูู ุงูุญุฏุซ
    CustomerLog.create(
        customer_id=customer.id,
        action='deposit_exceeded',
        details={
            'deposit_amount': customer.deposit_amount,
            'total_debt': customer.total_debt
        }
    )
```

#### 9.4 Business Rule: ููุน ุงูุนูููุงุช ุนูุฏ ุชุฌุงูุฒ ุงูุชุฃููู

```sql
-- Trigger ูููุน ุงูุนูููุงุช ุนูู ุงูุนููุงุก ุงููุชุฌุงูุฒูู ููุชุฃููู
CREATE OR REPLACE FUNCTION check_deposit_status_before_operation()
RETURNS TRIGGER AS $$
DECLARE
    v_customer_status VARCHAR(50);
BEGIN
    -- ุฌูุจ ุญุงูุฉ ุงูุนููู
    SELECT status INTO v_customer_status
    FROM customers WHERE id = NEW.customer_id;
    
    -- ููุน ุงูุนูููุงุช ุฅุฐุง ูุงู ุงูุนููู ูุชุฌุงูุฒ ููุชุฃููู
    IF v_customer_status = 'deposit_exceeded' THEN
        -- ุงูุณูุงุญ ุจุนูููุงุช ุงูุฏูุน ููุท
        IF TG_TABLE_NAME != 'payments' THEN
            RAISE EXCEPTION 'ูุง ูููู ุฅุฌุฑุงุก ุนูููุงุช ุนูู ูุฐุง ุงูุนููู - ุงููุฏููููุฉ ุชุฌุงูุฒุช ุงูุชุฃููู. ูุฑุฌู ุงูุชุณููุฉ ุฃููุงู.';
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ุชุทุจูู ุนูู ุงูุฌุฏุงูู ุงููุนููุฉ
CREATE TRIGGER check_deposit_on_subscription
    BEFORE INSERT ON subscriptions
    FOR EACH ROW
    EXECUTE FUNCTION check_deposit_status_before_operation();

CREATE TRIGGER check_deposit_on_service_request
    BEFORE INSERT ON service_requests
    FOR EACH ROW
    EXECUTE FUNCTION check_deposit_status_before_operation();
```

#### 9.5 ุขููุฉ ูุถุงุนูุฉ ุงูุชุฃููู

```python
def request_deposit_increase(customer_id: UUID, reason: str = 'deposit_exceeded'):
    """
    ุทูุจ ูุถุงุนูุฉ ุงูุชุฃููู ูุดุฑุท ูุฅุนุงุฏุฉ ุงูุฎุฏูุฉ
    """
    customer = Customer.get(customer_id)
    subscription = Subscription.get_active(customer_id)
    
    # ุญุณุงุจ ุงูุชุฃููู ุงูุฌุฏูุฏ (ูุถุงุนู)
    current_deposit = subscription.deposit_amount
    new_deposit = current_deposit * 2
    additional_deposit = new_deposit - current_deposit
    
    # ุฅูุดุงุก ุทูุจ ุฒูุงุฏุฉ ุงูุชุฃููู
    request = DepositIncreaseRequest.create(
        customer_id=customer_id,
        subscription_id=subscription.id,
        current_deposit=current_deposit,
        requested_deposit=new_deposit,
        additional_amount=additional_deposit,
        reason=reason,
        status='pending'
    )
    
    # ุฅูุดุงุก ูุงุชูุฑุฉ ููุชุฃููู ุงูุฅุถุงูู
    invoice = Invoice.create(
        customer_id=customer_id,
        invoice_type='deposit_increase',
        total_amount=additional_deposit,
        items=[{
            'description': 'ุชุฃููู ุฅุถุงูู (ูุถุงุนูุฉ)',
            'amount': additional_deposit
        }],
        notes=f'ูุถุงุนูุฉ ุงูุชุฃููู ุจุณุจุจ: {reason}'
    )
    request.invoice_id = invoice.id
    request.save()
    
    return {
        'request_id': request.id,
        'invoice_id': invoice.id,
        'current_deposit': current_deposit,
        'new_deposit': new_deposit,
        'additional_amount': additional_deposit
    }

def confirm_deposit_increase(request_id: UUID, payment_data: dict):
    """
    ุชุฃููุฏ ุฏูุน ุงูุชุฃููู ุงูุฅุถุงูู ูุฅุนุงุฏุฉ ุชูุนูู ุงูุฎุฏูุฉ
    """
    request = DepositIncreaseRequest.get(request_id)
    customer = Customer.get(request.customer_id)
    subscription = Subscription.get(request.subscription_id)
    
    # 1. ุชุญุฏูุซ ูุจูุบ ุงูุชุฃููู
    subscription.deposit_amount = request.requested_deposit
    subscription.save()
    
    # 2. ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ
    request.status = 'completed'
    request.completed_at = datetime.now()
    request.save()
    
    # 3. ุฅุนุงุฏุฉ ุชูุนูู ุงูุนููู (ุฅุฐุง ูุงูุช ุงููุฏููููุฉ ุฃูู ูู ุงูุชุฃููู ุงูุฌุฏูุฏ)
    total_debt = get_customer_total_debt(customer.id)
    if total_debt <= request.requested_deposit:
        customer.status = 'active'
        customer.suspension_reason = None
        customer.save()
        
        # ุฅุนุงุฏุฉ ุชูุตูู ุงูุนุฏุงุฏ ุงูุฐูู
        if customer.meter_id:
            meter = Meter.get(customer.meter_id)
            if meter.meter_type == 'smart':
                AcrelAPI.reconnect_meter(meter.acrel_meter_id)
    
    # 4. ุชุณุฌูู ุงูููุฏ ุงููุญุงุณุจู
    create_journal_entry(
        debit_account='120',  # ุงูุตูุฏูู/ุงูุจูู
        credit_account='221',  # ุชุฃูููุงุช ุงูุนููุงุก
        amount=request.additional_amount,
        description=f'ุชุฃููู ุฅุถุงูู - {customer.name}'
    )
    
    return {'success': True, 'new_deposit': request.requested_deposit}
```

#### 9.6 ุฌุฏูู ุทูุจุงุช ุฒูุงุฏุฉ ุงูุชุฃููู (deposit_increase_requests)

```sql
CREATE TABLE deposit_increase_requests (
    id UUID PRIMARY KEY,
    customer_id UUID REFERENCES customers(id),
    subscription_id UUID REFERENCES subscriptions(id),
    
    -- ุงููุจุงูุบ
    current_deposit DECIMAL(15,2) NOT NULL,
    requested_deposit DECIMAL(15,2) NOT NULL,
    additional_amount DECIMAL(15,2) NOT NULL,
    
    -- ุงูุณุจุจ
    reason VARCHAR(100), -- deposit_exceeded, high_consumption, customer_request
    
    -- ุงููุงุชูุฑุฉ
    invoice_id UUID REFERENCES invoices(id),
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending', -- pending, paid, completed, cancelled
    
    -- ุงูุชูุงุฑูุฎ
    requested_at TIMESTAMP DEFAULT NOW(),
    paid_at TIMESTAMP,
    completed_at TIMESTAMP,
    
    created_by UUID REFERENCES users(id),
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 9.7 ูุงูุจ ุฑุณุงูุฉ ุชุฌุงูุฒ ุงูุชุฃููู

```sql
INSERT INTO notification_templates (template_code, template_name, channel, body_template) VALUES
('deposit_exceeded', 'ุฅุดุนุงุฑ ุชุฌุงูุฒ ุงูุชุฃููู', 'sms', 
 'ุชูุจูู: ุนุฒูุฒู {{customer_name}}ุ ูุฏููููุชู ({{debt_amount}} ุฑูุงู) ุชุฌุงูุฒุช ูุจูุบ ุงูุชุฃููู ({{deposit_amount}} ุฑูุงู). ูุฑุฌู ุงูุชุณุฏูุฏ ูุชุฌูุจ ูุตู ุงูุฎุฏูุฉ.');
```

#### 9.8 APIs ุฅุฏุงุฑุฉ ุงูุชุฃูููุงุช

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | /api/v1/deposits/exceeded | ูุงุฆูุฉ ุงูุนููุงุก ุงููุชุฌุงูุฒูู ููุชุฃููู |
| GET | /api/v1/customers/:id/deposit-status | ุญุงูุฉ ุงูุชุฃููู ููุนููู |
| POST | /api/v1/deposits/increase-request | ุทูุจ ูุถุงุนูุฉ ุงูุชุฃููู |
| POST | /api/v1/deposits/increase-confirm | ุชุฃููุฏ ุฏูุน ุงูุชุฃููู ุงูุฅุถุงูู |
| GET | /api/v1/deposits/report | ุชูุฑูุฑ ุงูุชุฃูููุงุช |

---

## ุงูุฑุจุท ุงููุญุงุณุจู

### ุงูุญุณุงุจุงุช ุงููุฑุชุจุทุฉ
| ุงูุญุณุงุจ | ุงูุฑูุฒ | ุงูุงุณุชุฎุฏุงู |
|--------|-------|-----------|
| ุฅูุฑุงุฏุงุช ุงูููุฑุจุงุก | 410 | ุฅูุฑุงุฏุงุช ุงูุงุณุชููุงู |
| ุฅูุฑุงุฏุงุช ุงูุฎุฏูุงุช | 411 | ุฑุณูู ุงูุชูุตูู ูุงููุตู |
| ุฐูู ุงูุนููุงุก | 120 | ุฃุฑุตุฏุฉ ุงูุนููุงุก ุงููุฏููุฉ |
| ุฅูุฑุงุฏุงุช ูุคุฌูุฉ | 220 | ุงูุฏูุน ุงููุณุจู |
| ูุฎุตุต ุฏููู ูุดููู ูููุง | 121 | ูุฎุตุต ุงูุฏููู |
| ุฏููู ูุนุฏููุฉ | 580 | ุดุทุจ ุงูุฏููู |

### ุงููููุฏ ุงููุญุงุณุจูุฉ

#### ุนูุฏ ุฅุตุฏุงุฑ ูุงุชูุฑุฉ:
```
ูู ุญู/ ุฐูู ุงูุนููุงุก (120)
    ุฅูู ุญู/ ุฅูุฑุงุฏุงุช ุงูููุฑุจุงุก (410)
    ุฅูู ุญู/ ุถุฑูุจุฉ ุงููุจูุนุงุช (230)
```

#### ุนูุฏ ุงุณุชูุงู ุฏูุนุฉ:
```
ูู ุญู/ ุงูุตูุฏูู/ุงูุจูู
    ุฅูู ุญู/ ุฐูู ุงูุนููุงุก (120)
```

#### ุนูุฏ ุดุญู ุฑุตูุฏ ูุณุจู:
```
ูู ุญู/ ุงูุตูุฏูู/ุงูุจูู
    ุฅูู ุญู/ ุฅูุฑุงุฏุงุช ูุคุฌูุฉ (220)
```

#### ุนูุฏ ุงุณุชููุงู ุงูุฑุตูุฏ ุงููุณุจู:
```
ูู ุญู/ ุฅูุฑุงุฏุงุช ูุคุฌูุฉ (220)
    ุฅูู ุญู/ ุฅูุฑุงุฏุงุช ุงูููุฑุจุงุก (410)
```

#### ุนูุฏ ุดุทุจ ุฏูู:
```
ูู ุญู/ ุฏููู ูุนุฏููุฉ (580)
    ุฅูู ุญู/ ุฐูู ุงูุนููุงุก (120)
```

#### ุนูุฏ ุฏูุน ุฑุณูู ุงุดุชุฑุงู ุฌุฏูุฏ (ุนุฏุงุฏ ุนุงุฏู):
```
ูู ุญู/ ุงูุตูุฏูู/ุงูุจูู (111)
    ุฅูู ุญู/ ุฅูุฑุงุฏุงุช ุงุดุชุฑุงูุงุช ุฌุฏูุฏุฉ (421) - ุจูููุฉ ุฑุณูู ุงูุงุดุชุฑุงู
    ุฅูู ุญู/ ุชุฃูููุงุช ูู ุงูุนููุงุก (212) - ุจูููุฉ ุงูุชุฃููู
```

#### ุนูุฏ ุชุฑููุฉ ุนุฏุงุฏ ุนุงุฏู ุฅูู STS (ููุฏุงู):

**ุงูููุฏ ุงูุฃูู - ุฅูุบุงุก ุงูุชุฃููู ุงููุฏูู:**
```
ูู ุญู/ ุชุฃูููุงุช ูู ุงูุนููุงุก (212)
    ุฅูู ุญู/ ุฐูู ุงูุนููุงุก (120) - ุชุฎููุถ ูุฏููููุฉ ุงูุนููู
```

**ุงูููุฏ ุงูุซุงูู - ุชุณุฌูู ุฑุณูู ุงูุชุฑููุฉ:**
```
ูู ุญู/ ุงูุตูุฏูู/ุงูุจูู (111) - ุจุงููุจูุบ ุงููุฏููุน ูุนูุงู
ูู ุญู/ ุฐูู ุงูุนููุงุก (120) - ุฅุฐุง ุชู ุงุณุชุฎุฏุงู ุฌุฒุก ูู ุงูุชุฃููู
    ุฅูู ุญู/ ุฅูุฑุงุฏุงุช ุชุฑููุฉ ุงุดุชุฑุงูุงุช (422) - ุจูุงูู ูุจูุบ ุงูุชุฑููุฉ
```

#### ุนูุฏ ุงุณุชูุงู ุฏูุนุฉ ูู ุตูุฏูู ุงูุฏุนู ุงูุญูููู:
```
ูู ุญู/ ุงูุจูู (1112)
    ุฅูู ุญู/ ุฐูู ุงูุนููุงุก (120) - ูุชุณููุฉ ููุงุชูุฑ ุงููุดุชุฑููู ุงููุฏุนูููู
```

> **ููุงุญุธุฉ:** ูููู ุงุณุชุฎุฏุงู ุญุณุงุจ ูุณูุท "ุญุณุงุจ ุตูุฏูู ุงูุฏุนู" ุฅุฐุง ูุงูุช ุงูุฏูุนุฉ ูุง ุชุฑุชุจุท ุจููุงุชูุฑ ูุญุฏุฏุฉ.

#### ุนูุฏ ุชุฑููุจ ุนุฏุงุฏ ุนูู ุญุณุงุจ ุงูุนููู (ููุฏุงู):

**ุงูููุฏ ุงูุฃูู - ุชุณุฌูู ุฅูุฑุงุฏ ุจูุน ุงูุนุฏุงุฏ:**
```
ูู ุญู/ ุฐูู ุงูุนููุงุก (120)
    ุฅูู ุญู/ ุฅูุฑุงุฏุงุช ุจูุน ุนุฏุงุฏุงุช (423)
```

**ุงูููุฏ ุงูุซุงูู - ุฅุฎุฑุงุฌ ุงูุนุฏุงุฏ ูู ุงููุฎุฒูู:**
```
ูู ุญู/ ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ (55)
    ุฅูู ุญู/ ุงููุฎุฒูู - ุนุฏุงุฏุงุช (1131)
```

#### ุนูุฏ ุงุณุชุจุฏุงู ุนุฏุงุฏ ุชุงูู ุนูู ุญุณุงุจ ุงูุนููู (ุฎุงุฑุฌ ุงูุถูุงู):
```
ูู ุญู/ ุฐูู ุงูุนููุงุก (120)
    ุฅูู ุญู/ ุฅูุฑุงุฏุงุช ุจูุน ุนุฏุงุฏุงุช (423) - ุจูุณุจุฉ ุงูุชุญููู (100% ุฃู 50%)
```

#### ุนูุฏ ุฅูุบุงุก ุงุดุชุฑุงู ูุฑุฏ ุงูุชุฃููู:
```
ูู ุญู/ ุชุฃูููุงุช ูู ุงูุนููุงุก (212)
    ุฅูู ุญู/ ุงูุตูุฏูู/ุงูุจูู (111) - ุฅุฐุง ุชู ุฑุฏ ุงูุชุฃููู ููุฏุงู
    ุฅูู ุญู/ ุฐูู ุงูุนููุงุก (120) - ุฅุฐุง ุชู ุฎุตูู ูู ุงููุฏููููุฉ
```

---

## ุงูู APIs

### ุฅุฏุงุฑุฉ ุงูุนููุงุก
| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | /api/v1/customers | ูุงุฆูุฉ ุงูุนููุงุก |
| GET | /api/v1/customers/:id | ุชูุงุตูู ุงูุนููู |
| POST | /api/v1/customers | ุฅูุดุงุก ุนููู |
| PUT | /api/v1/customers/:id | ุชุนุฏูู ุนููู |
| GET | /api/v1/customers/:id/invoices | ููุงุชูุฑ ุงูุนููู |
| GET | /api/v1/customers/:id/payments | ูุฏููุนุงุช ุงูุนููู |
| GET | /api/v1/customers/:id/balance | ุฑุตูุฏ ุงูุนููู |
| GET | /api/v1/customers/:id/statement | ูุดู ุญุณุงุจ |
| GET | /api/v1/customers/search | ุงูุจุญุซ ุนู ุนููู |

### ุงูููุชุฑุฉ
| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | /api/v1/invoices | ูุงุฆูุฉ ุงูููุงุชูุฑ |
| GET | /api/v1/invoices/:id | ุชูุงุตูู ุงููุงุชูุฑุฉ |
| POST | /api/v1/invoices | ุฅูุดุงุก ูุงุชูุฑุฉ |
| POST | /api/v1/invoices/generate-batch | ุชูููุฏ ููุงุชูุฑ ุฏูุนุฉ |
| POST | /api/v1/invoices/:id/issue | ุฅุตุฏุงุฑ ุงููุงุชูุฑุฉ |
| POST | /api/v1/invoices/:id/send | ุฅุฑุณุงู ุงููุงุชูุฑุฉ |
| POST | /api/v1/invoices/:id/print | ุทุจุงุนุฉ ุงููุงุชูุฑุฉ |
| POST | /api/v1/invoices/:id/cancel | ุฅูุบุงุก ุงููุงุชูุฑุฉ |

### ุงูุชุญุตูู
| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | /api/v1/payments | ูุงุฆูุฉ ุงููุฏููุนุงุช |
| POST | /api/v1/payments | ุชุณุฌูู ุฏูุนุฉ |
| POST | /api/v1/payments/:id/allocate | ุชูุฒูุน ุงูุฏูุนุฉ |
| GET | /api/v1/payments/outstanding | ุงูููุงุชูุฑ ุงููุณุชุญูุฉ |
| POST | /api/v1/sts/recharge | ุดุญู ุฑุตูุฏ STS |
| GET | /api/v1/sts/balance/:meter_id | ุฑุตูุฏ STS |

### ุงูุฏููู
| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | /api/v1/debts | ูุงุฆูุฉ ุงูุฏููู |
| GET | /api/v1/debts/aging | ุชูุฑูุฑ ุฃุนูุงุฑ ุงูุฏููู |
| POST | /api/v1/payment-plans | ุฅูุดุงุก ุฎุทุฉ ุณุฏุงุฏ |
| GET | /api/v1/payment-plans/:id | ุชูุงุตูู ุฎุทุฉ ุงูุณุฏุงุฏ |

### ุงููุตู/ุงูุชูุตูู
| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | /api/v1/disconnection-orders | ุฅูุดุงุก ุฃูุฑ ูุตู |
| POST | /api/v1/reconnection-orders | ุฅูุดุงุก ุฃูุฑ ุชูุตูู |
| PUT | /api/v1/orders/:id/execute | ุชูููุฐ ุงูุฃูุฑ |

---

## ุงูุดุงุดุงุช

### ุดุงุดุงุช ุงูุนููุงุก
1. ูุงุฆูุฉ ุงูุนููุงุก
2. ุจุทุงูุฉ ุงูุนููู (ุชูุงุตูู + ููุงุชูุฑ + ูุฏููุนุงุช)
3. ูููุฐุฌ ุฅุถุงูุฉ/ุชุนุฏูู ุนููู
4. ูุดู ุญุณุงุจ ุงูุนููู
5. ุงูุจุญุซ ุงููุชูุฏู

### ุดุงุดุงุช ุงูููุชุฑุฉ
6. ูุงุฆูุฉ ุงูููุงุชูุฑ
7. ูููุฐุฌ ุฅูุดุงุก ูุงุชูุฑุฉ
8. ุชูุงุตูู ุงููุงุชูุฑุฉ
9. ุทุจุงุนุฉ ุงููุงุชูุฑุฉ
10. ุชูููุฏ ุงูููุงุชูุฑ ุงูุฏูุฑูุฉ
11. ุฅุฏุงุฑุฉ ุงูููุงูุจ

### ุดุงุดุงุช ุงูุชุญุตูู
12. ุชุณุฌูู ุฏูุนุฉ
13. ูุงุฆูุฉ ุงููุฏููุนุงุช
14. ุชูุฒูุน ุงููุฏููุนุงุช
15. ุดุญู ุฑุตูุฏ STS
16. ุชูุฑูุฑ ุงูุชุญุตูู ุงููููู

### ุดุงุดุงุช ุงูุฏููู
17. ูุงุฆูุฉ ุงููุชุฃุฎุฑุงุช
18. ุชูุฑูุฑ ุฃุนูุงุฑ ุงูุฏููู
19. ุฅูุดุงุก ุฎุทุฉ ุณุฏุงุฏ
20. ูุชุงุจุนุฉ ุฎุทุท ุงูุณุฏุงุฏ

### ุดุงุดุงุช ุงููุตู/ุงูุชูุตูู
21. ูุงุฆูุฉ ุฃูุงูุฑ ุงููุตู
22. ูุงุฆูุฉ ุฃูุงูุฑ ุงูุชูุตูู
23. ูููุฐุฌ ุฃูุฑ ูุตู/ุชูุตูู

### ุดุงุดุงุช ุงูุชูุงุฑูุฑ
24. ุชูุฑูุฑ ุงูููุงุชูุฑ
25. ุชูุฑูุฑ ุงูุชุญุตูู
26. ุชูุฑูุฑ ุงูุฅูุฑุงุฏุงุช
27. ุชูุฑูุฑ ุงูุงุณุชููุงู
28. ููุญุฉ ุงููุคุดุฑุงุช (Dashboard)

---

## ๐ณ ููุทุฉ ุงูุจูุน / ูุงุฌูุฉ ุงููุงุดูุฑ (POS / Cashier Interface)

### ๐ฏ ุงูุบุฑุถ

ูุงุฌูุฉ ุจุณูุทุฉ ูุณุฑูุนุฉ ูููุธู ุงููุงุดูุฑ ูุชูููุฐ ุนูููุงุช ุงูุชุญุตูู ูุดุญู STS ุจุณุฑุนุฉ.

### ๐ป ุดุงุดุงุช ููุทุฉ ุงูุจูุน

| ุงูุดุงุดุฉ | ุงููุตู |
|--------|-------|
| **ุงูุจุญุซ ุงูุณุฑูุน** | ุจุญุซ ุจุฑูู ุงูุนุฏุงุฏ / ุฑูู ุงููุงุชู / ุงุณู ุงูุนููู |
| **ููุฎุต ุงูุนููู** | ุงูุงุณูุ ุงูุฑุตูุฏุ ุขุฎุฑ ูุงุชูุฑุฉุ ููุน ุงูุนุฏุงุฏ |
| **ุดุญู STS** | ุฅุฏุฎุงู ุงููุจูุบ โ ุชูููุฏ ุงูุชููู โ ุทุจุงุนุฉ |
| **ุฏูุน ูุงุชูุฑุฉ** | ุนุฑุถ ุงูููุงุชูุฑ ุงููุณุชุญูุฉ โ ุชุณุฌูู ุงูุฏูุน โ ุทุจุงุนุฉ ุงูุฅูุตุงู |
| **ุฅุบูุงู ุงูุตูุฏูู** | ููุฎุต ุงููููุ ุงูุชุณููู |

### ๐ ุณูุฑ ุงูุนูู - ุดุญู STS

```
1. ุงููุงุดูุฑ ูุฏุฎู ุฑูู ุงูุนุฏุงุฏ
2. ุงููุธุงู ูุนุฑุถ ุจูุงูุงุช ุงูุนููู
3. ุงููุงุดูุฑ ูุฏุฎู ุงููุจูุบ
4. ุงููุธุงู ูุชุตู ุจู STS API โ ูููุฏ ุงูุชููู (20 ุฑูู)
5. ุงููุธุงู ูุณุฌู ุงูููุฏ ุงููุญุงุณุจู
6. ุงููุงุดูุฑ ูุทุจุน ุงูุฅูุตุงู ููุนููู
```

### ๐จ๏ธ ุงูุทุจุงุนุฉ

**ุฅูุตุงู ุดุญู STS ูุญุชูู ุนูู:**
- ุงุณู ุงูุดุฑูุฉ/ุงููุญุทุฉ
- ุฑูู ุงููุนุงููุฉ
- ุงุณู ุงูุนููู
- ุฑูู ุงูุนุฏุงุฏ
- ุงููุจูุบ ุงููุฏููุน
- ุนุฏุฏ ุงููุญุฏุงุช (KWh)
- **ุฑูุฒ ุงูุดุญู (20 ุฑูู)** - ุจุฎุท ูุจูุฑ ููุงุถุญ
- ุงูุชุงุฑูุฎ ูุงูููุช
- ุงุณู ุงููุงุดูุฑ

**ุฅูุตุงู ุฏูุน ูุงุชูุฑุฉ ูุญุชูู ุนูู:**
- ุฑูู ุงูุฅูุตุงู
- ุฑูู ุงููุงุชูุฑุฉ
- ุงุณู ุงูุนููู
- ุงููุจูุบ ุงููุฏููุน
- ุงูุฑุตูุฏ ุงููุชุจูู
- ุงูุชุงุฑูุฎ ูุงูููุช

### ๐ฑ APIs ูููุทุฉ ุงูุจูุน

```
GET    /api/v1/pos/search?q=xxx           - ุจุญุซ ุณุฑูุน
GET    /api/v1/pos/customer/:meter_number - ุจูุงูุงุช ุงูุนููู
POST   /api/v1/pos/sts-recharge           - ุดุญู STS
POST   /api/v1/pos/pay-invoice            - ุฏูุน ูุงุชูุฑุฉ
GET    /api/v1/pos/receipt/:id            - ุทุจุงุนุฉ ุงูุฅูุตุงู
GET    /api/v1/pos/daily-summary          - ููุฎุต ุงูููู
POST   /api/v1/pos/close-shift            - ุฅุบูุงู ุงููุฑุฏูุฉ
```

### ๐จ๏ธ ุฏุนู ุงูุทุงุจุนุงุช

| ุงูููุน | ุงูุฏุนู |
|------|------|
| ุทุงุจุนุฉ ุญุฑุงุฑูุฉ (POS Printer) | โ ูุฏุนูู |
| ุทุงุจุนุฉ ุนุงุฏูุฉ (A4) | โ ูุฏุนูู |
| PDF ููุฅุฑุณุงู | โ ูุฏุนูู |

---

## ๐ ุจูุงุจุฉ ุงูุนููู ููุฏูุน ุงูุฐุงุชู (Customer Payment Portal)

### ๐ฏ ุงูุบุฑุถ

ุตูุญุฉ ููุจ ุจุณูุทุฉ ูุฏุฎููุง ุงูุนููู ูู ุฑุงุจุท SMS/WhatsApp ููุฏูุน ุงูุฅููุชุฑููู ุจุฏูู ุงูุญุงุฌุฉ ููุฐูุงุจ ููููุชุจ.

### ๐ฑ ุงูุดุงุดุงุช

#### 1. ุตูุญุฉ ุงูุฏูุน ุงูุณุฑูุน (Quick Pay Page)

**ุงูุฑุงุจุท:** `https://pay.station.com/invoice/{invoice_token}`

**ุงูููููุงุช:**

| ุงูุนูุตุฑ | ุงููุตู |
|--------|------|
| ุดุนุงุฑ ุงููุญุทุฉ | ุงููููุฉ ุงูุจุตุฑูุฉ |
| ุจูุงูุงุช ุงููุงุชูุฑุฉ | ุฑูู ุงููุงุชูุฑุฉุ ุงุณู ุงูุนูููุ ุงููุจูุบุ ุชุงุฑูุฎ ุงูุงุณุชุญูุงู |
| ุชูุงุตูู ุงูุงุณุชููุงู | ุงููุฑุงุกุฉ ุงูุณุงุจูุฉุ ุงูุญุงููุฉุ ุงููุฑู |
| ุทุฑู ุงูุฏูุน | ุจุทุงูุฉ ุงุฆุชูุงููุฉุ ูุญูุธุฉ ุฅููุชุฑูููุฉ (ูููุณูุ ุฌูุจ) |
| ุฒุฑ ุงูุฏูุน | "ุงุฏูุน ุงูุขู" |

#### 2. ุตูุญุฉ ุงูุชุฃููุฏ (Confirmation Page)

**ุงูููููุงุช:**

| ุงูุนูุตุฑ | ุงููุตู |
|--------|------|
| ุฑุณุงูุฉ ุงููุฌุงุญ | "ุชู ุงูุฏูุน ุจูุฌุงุญ" |
| ุฑูู ุงูุนูููุฉ | ูุฑุฌุน ุงูุฏูุน |
| ุงููุจูุบ ุงููุฏููุน | ุงููููุฉ |
| ุงูุฑุตูุฏ ุงูุฌุฏูุฏ | ุฑุตูุฏ ุงูุนููู ุจุนุฏ ุงูุฏูุน |
| ุชุญููู ุงูุฅูุตุงู | PDF |

#### 3. ุตูุญุฉ ุงุณุชุนูุงู ุงูุฑุตูุฏ (Balance Inquiry)

**ุงูุฑุงุจุท:** `https://pay.station.com/balance`

**ุงูููููุงุช:**

| ุงูุนูุตุฑ | ุงููุตู |
|--------|------|
| ุฅุฏุฎุงู ุฑูู ุงูุนุฏุงุฏ/ุงููุงุชู | ููุจุญุซ ุนู ุงูุญุณุงุจ |
| ุนุฑุถ ุงูุฑุตูุฏ | ุงููุณุชุญู/ุงููุชุฃุฎุฑ |
| ูุงุฆูุฉ ุงูููุงุชูุฑ ุงูููุชูุญุฉ | ูุน ุฒุฑ "ุงุฏูุน" ููู ูุงุชูุฑุฉ |

### ๐ ุงูุฃูุงู

| ุงูุนูุตุฑ | ุงููุตู |
|--------|------|
| ุฑุงุจุท ูุคูุช (Token) | ุตูุงุญูุฉ 24-72 ุณุงุนุฉ |
| HTTPS | ุชุดููุฑ ูุงูู |
| ุจุฏูู ุชุณุฌูู ุฏุฎูู | ุงูุฑุงุจุท ูู ุงููุตุงุฏูุฉ |
| PCI DSS | ุงูุฏูุน ุนุจุฑ ุจูุงุจุฉ ูุนุชูุฏุฉ |

### ๐ ุณูุฑ ุงูุนูู

```
1. ุงููุธุงู ููุดุฆ ูุงุชูุฑุฉ
   โ
2. ูููุฏ ุฑุงุจุท ุฏูุน ูุฑูุฏ (invoice_token)
   โ
3. ูุฑุณู SMS/WhatsApp ููุนููู ุจุงูุฑุงุจุท
   โ
4. ุงูุนููู ููุชุญ ุงูุฑุงุจุท ุนูู ุฌูุงูู
   โ
5. ูุฎุชุงุฑ ุทุฑููุฉ ุงูุฏูุน (ุจุทุงูุฉ/ูุญูุธุฉ)
   โ
6. ูุฏุฎู ุจูุงูุงุช ุงูุฏูุน
   โ
7. ุจูุงุจุฉ ุงูุฏูุน ุชุนุงูุฌ ุงูุนูููุฉ
   โ
8. ุงููุธุงู ูุณุชูุจู Webhook ูู ุจูุงุจุฉ ุงูุฏูุน
   โ
9. ุชุญุฏูุซ ุงููุงุชูุฑุฉ + ุงูุฑุตูุฏ + ุงูููุฏ ุงููุญุงุณุจู
   โ
10. ุนุฑุถ ุตูุญุฉ ุงูุชุฃููุฏ + ุฅุฑุณุงู SMS ุชุฃููุฏ
```

### ๐ ุฌุฏูู ุฑูุงุจุท ุงูุฏูุน (payment_links)

```sql
CREATE TABLE payment_links (
    id UUID PRIMARY KEY,
    invoice_id UUID REFERENCES invoices(id),
    customer_id UUID REFERENCES customers(id),
    
    -- ุงูุฑุงุจุท
    token VARCHAR(64) UNIQUE NOT NULL, -- ุฑูุฒ ูุฑูุฏ ููุฑุงุจุท
    short_url VARCHAR(100), -- ุฑุงุจุท ูุฎุชุตุฑ
    
    -- ุงูุตูุงุญูุฉ
    expires_at TIMESTAMP NOT NULL, -- 24-72 ุณุงุนุฉ
    is_used BOOLEAN DEFAULT false,
    used_at TIMESTAMP,
    
    -- ุงูุชุชุจุน
    views_count INTEGER DEFAULT 0,
    last_viewed_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### ๐ APIs

```
GET    /api/v1/pay/{token}              - ุฌูุจ ุจูุงูุงุช ุงููุงุชูุฑุฉ ููุนุฑุถ
POST   /api/v1/pay/{token}/process      - ูุนุงูุฌุฉ ุงูุฏูุน
GET    /api/v1/pay/{token}/receipt      - ุชุญููู ุงูุฅูุตุงู
POST   /api/v1/balance/inquiry          - ุงุณุชุนูุงู ุงูุฑุตูุฏ
POST   /api/v1/webhooks/payment-gateway - ุงุณุชูุจุงู ุฅุดุนุงุฑุงุช ุจูุงุจุฉ ุงูุฏูุน
```

---

## โก ุดุญู STS ุงูุฐุงุชู ููุนููู (Self-Service STS Recharge)

### ๐ฏ ุงูุบุฑุถ

ุชูููู ุงูุนููู ูู ุดุญู ุฑุตูุฏ ุงูููุฑุจุงุก (ุนุฏุงุฏ STS) ุจููุณู ูู ุฃู ููุงู ููู ุฃู ููุช (24/7) ุจุฏูู ุงูุญุงุฌุฉ ููุญุถูุฑ ููููุชุจ.

### ๐ฑ ุงูุดุงุดุงุช

#### 1. ุตูุญุฉ ุดุญู ุงูุฑุตูุฏ (STS Recharge Page)

**ุงูุฑุงุจุท:** `https://pay.station.com/sts-recharge`

**ุงูููููุงุช:**

| ุงูุนูุตุฑ | ุงููุตู |
|--------|------|
| ุฅุฏุฎุงู ุฑูู ุงูุนุฏุงุฏ | ุฑูู ุงูุนุฏุงุฏ ุงููููู ูู 11 ุฑูู |
| ุงูุชุญูู ูู ุงูุนุฏุงุฏ | ุนุฑุถ ุงุณู ุงูุนููู ููุชุฃููุฏ |
| ุฅุฏุฎุงู ุงููุจูุบ | ุงููุจูุบ ุงููุฑุงุฏ ุดุญูู (ุจุงูุฑูุงู) |
| ุนุฑุถ ุงููููููุงุช | ุญุณุงุจ ุชููุงุฆู ูููุญุฏุงุช ุจูุงุกู ุนูู ุงูุชุนุฑูุฉ |
| ูุจุงูุบ ุณุฑูุนุฉ | ุฃุฒุฑุงุฑ (50ุ 100ุ 200ุ 500 ุฑูุงู) |
| ุฒุฑ "ุงุดุญู ุงูุขู" | ุงูุงูุชูุงู ููุฏูุน |

#### 2. ุตูุญุฉ ุงูุฏูุน (Payment Page)

**ุงูููููุงุช:**

| ุงูุนูุตุฑ | ุงููุตู |
|--------|------|
| ููุฎุต ุงูุดุญู | ุฑูู ุงูุนุฏุงุฏุ ุงููุจูุบุ ุงููููููุงุช |
| ุทุฑู ุงูุฏูุน | ุจุทุงูุฉ ุงุฆุชูุงููุฉุ ูุญูุธุฉ (ูููุณูุ ุฌูุจ) |
| ุฒุฑ "ุฃููู ุงูุฏูุน" | ูุนุงูุฌุฉ ุงูุฏูุน |

#### 3. ุตูุญุฉ ุชุฃููุฏ ุงูุดุญู ูุนุฑุถ ุงูุชููู (Token Display Page)

**ุงูููููุงุช:**

| ุงูุนูุตุฑ | ุงููุตู |
|--------|------|
| โ ุฑุณุงูุฉ ุงููุฌุงุญ | "ุชู ุงูุดุญู ุจูุฌุงุญ!" |
| **ุฑูุฒ ุงูุดุญู (Token)** | ุนุฑุถ ุจุฎุท ูุจูุฑ ููุงุถุญ (20 ุฑูู) |
| ุฒุฑ "ูุณุฎ ุงูุฑูุฒ" | ูุณุฎ ููุญุงูุธุฉ |
| ุชูุงุตูู ุงูุนูููุฉ | ุงููุจูุบุ ุงููููููุงุชุ ุฑูู ุงูุนูููุฉ |
| ุชุนูููุงุช ุงูุฅุฏุฎุงู | "ุฃุฏุฎู ูุฐุง ุงูุฑูุฒ ูู ุดุงุดุฉ ุงูุนุฏุงุฏ" |
| ุฅุดุนุงุฑ SMS | "ุชู ุฅุฑุณุงู ุงูุฑูุฒ ุฅูู ุฌูุงูู" |
| ุชุญููู ุงูุฅูุตุงู | PDF |

#### 4. ุตูุญุฉ ุณุฌู ุงูุดุญูุงุช (Recharge History)

**ุงูุฑุงุจุท:** `https://pay.station.com/sts-history`

**ุงูููููุงุช:**

| ุงูุนูุตุฑ | ุงููุตู |
|--------|------|
| ุฅุฏุฎุงู ุฑูู ุงูุนุฏุงุฏ/ุงููุงุชู | ููุจุญุซ |
| ุฌุฏูู ุงูุดุญูุงุช | ุงูุชุงุฑูุฎุ ุงููุจูุบุ ุงููููููุงุชุ ุงูุชูููุ ุงูุญุงูุฉ |
| ุนุฑุถ ุงูุชููู | ุงูููุฑ ูุนุฑุถ ุงูุฑูุฒ ูุฑุฉ ุฃุฎุฑู |
| ุฅุนุงุฏุฉ ุฅุฑุณุงู SMS | ุฅุฑุณุงู ุงูุชููู ูุฑุฉ ุฃุฎุฑู |
| ุชุญููู ุงูุฅูุตุงู | PDF |

### ๐ ุณูุฑ ุงูุนูู ุงููุงูู

```
1. ุงูุนููู ูุฏุฎู ุตูุญุฉ ุดุญู STS
   โ
2. ูุฏุฎู ุฑูู ุงูุนุฏุงุฏ
   โ
3. ุงููุธุงู ูุชุญูู ูู ุงูุนุฏุงุฏ ููุนุฑุถ ุงุณู ุงูุนููู
   โ
4. ุงูุนููู ูุฏุฎู ุงููุจูุบ
   โ
5. ุงููุธุงู ูุญุณุจ ุงููููููุงุช ุชููุงุฆูุงู
   โ
6. ุงูุนููู ูููุฑ "ุงุดุญู ุงูุขู"
   โ
7. ููุชูู ูุตูุญุฉ ุงูุฏูุน ููุฎุชุงุฑ ุทุฑููุฉ ุงูุฏูุน
   โ
8. ุจูุงุจุฉ ุงูุฏูุน ุชุนุงูุฌ ุงูุนูููุฉ
   โ
9. ุนูุฏ ูุฌุงุญ ุงูุฏูุน:
   โโโ ุงููุธุงู ูุณุชุฏุนู STS API โ generateToken()
   โโโ ูุณุชูู ุงูุชููู (20 ุฑูู)
   โโโ ูุนุฑุถ ุงูุชููู ููุนููู ููุฑุงู
   โโโ ูุฑุณู SMS/WhatsApp ุจุงูุชููู
   โโโ ููุดุฆ ุงูููุฏ ุงููุญุงุณุจู ุชููุงุฆูุงู
   โ
10. ุงูุนููู ูุฏุฎู ุงูุชููู ูู ุดุงุดุฉ ุงูุนุฏุงุฏ
```

### ๐ ุงูุฃูุงู

| ุงูุนูุตุฑ | ุงููุตู |
|--------|------|
| ุงูุชุญูู ูู ุงูุนุฏุงุฏ | ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุนุฏุงุฏ ูุฃูู ููุน STS |
| ุนุฑุถ ุงุณู ุงูุนููู | ููุชุฃููุฏ ูุจู ุงูุฏูุน |
| ุญุฏ ุฃุฏูู/ุฃูุตู | ุชุญุฏูุฏ ูุจุงูุบ ุงูุดุญู ุงููุณููุญุฉ |
| Rate Limiting | ููุน ุงูุดุญู ุงููุชูุฑุฑ ุงููุดุจูู |

### ๐ APIs ุดุญู STS ุงูุฐุงุชู

```
GET    /api/v1/portal/sts/verify/:meter_number  - ุงูุชุญูู ูู ุงูุนุฏุงุฏ
GET    /api/v1/portal/sts/calculate             - ุญุณุงุจ ุงููููููุงุช
POST   /api/v1/portal/sts/recharge              - ุชูููุฐ ุงูุดุญู
GET    /api/v1/portal/sts/history               - ุณุฌู ุงูุดุญูุงุช
POST   /api/v1/portal/sts/resend-sms/:id        - ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูุชููู
GET    /api/v1/portal/sts/receipt/:id           - ุชุญููู ุงูุฅูุตุงู
```

---

## โ๏ธ ุดุงุดุฉ ุฅุนุฏุงุฏุงุช ุงูููุชุฑุฉ ุงูุฏูุฑูุฉ (Recurring Billing Settings)

### ๐ฏ ุงูุบุฑุถ

ุชุญุฏูุฏ ุฏูุฑุฉ ุงูููุชุฑุฉ ุงูุชููุงุฆูุฉ (ูู 10 ุฃูุงูุ ุดูุฑูุงูุ ุฑุจุน ุณูููุงู) ูุฅุนุฏุงุฏุงุช ุงููููุฉ ุงููุฌุฏููุฉ.

### ๐ป ููููุงุช ุงูุดุงุดุฉ

| ุงููุณู | ุงูุนูุงุตุฑ |
|-------|----------|
| **ุฏูุฑุฉ ุงูููุชุฑุฉ** | ุงูุชูุฑุงุฑ (ููููุ ุฃุณุจูุนูุ ูู 10 ุฃูุงูุ ุดูุฑู)ุ ููู ุงูุชูููุฐ |
| **ููุช ุงูุชูููุฐ** | ุงูุณุงุนุฉ ุงูุชู ุชุนูู ูููุง ุงููููุฉ (ูุซูุงู 6:00 ุตุจุงุญุงู) |
| **ูุทุงู ุงูุนููุงุก** | ุฌููุน ุงูุนููุงุก / ูุฆุฉ ูุญุฏุฏุฉ / ููุน ุนุฏุงุฏ |
| **ุงูุฅุดุนุงุฑุงุช** | ุฅุฑุณุงู SMS ุชููุงุฆูุ ุฅุฑุณุงู WhatsAppุ ุฅุฑุณุงู ุจุฑูุฏ |
| **ุงูุชุฐููุฑุงุช** | ุชุฐููุฑ ูุจู ุงูุงุณุชุญูุงู ุจู X ููู |
| **ุณุฌู ุงูุชูููุฐ** | ุขุฎุฑ 10 ุนูููุงุช ุชูููุฏ ููุงุชูุฑ |

### ๐ ุขููุฉ ุงููููุฉ ุงููุฌุฏููุฉ (Scheduled Job)

```
Cron Job: 0 6 */10 * * (ูู 10 ุฃูุงู ุงูุณุงุนุฉ 6 ุตุจุงุญุงู)
   โ
1. ุฌูุจ ุงูุนููุงุก ุงููุณุชุญููู ููููุชุฑุฉ
   โ
2. ููู ุนููู:
   โโโ ุฌูุจ ุขุฎุฑ ูุฑุงุกุฉ ููุนุฏุงุฏ
   โโโ ุญุณุงุจ ุงูุงุณุชููุงู
   โโโ ุชุทุจูู ุงูุชุนุฑูุฉ
   โโโ ุฅูุดุงุก ุงููุงุชูุฑุฉ
   โโโ ุชูููุฏ ุฑุงุจุท ุงูุฏูุน
   โโโ ุฅุฑุณุงู ุงูุฅุดุนุงุฑ
   โ
3. ุชุณุฌูู ูุชูุฌุฉ ุงูุชูููุฐ ูู ุงูุณุฌู
```

### ๐ ุฌุฏูู ุณุฌู ุงูููุงู ุงููุฌุฏููุฉ (scheduled_jobs_log)

```sql
CREATE TABLE scheduled_jobs_log (
    id UUID PRIMARY KEY,
    job_type VARCHAR(50) NOT NULL, -- recurring_billing, reminders, reports
    
    started_at TIMESTAMP NOT NULL,
    completed_at TIMESTAMP,
    
    status VARCHAR(20), -- running, completed, failed
    
    -- ุงูุฅุญุตุงุฆูุงุช
    total_records INTEGER,
    processed_records INTEGER,
    failed_records INTEGER,
    
    -- ุงูุชูุงุตูู
    details JSONB, -- {"ููุงุชูุฑ_ููุดุฃุฉ": 150, "ุฅุดุนุงุฑุงุช_ูุฑุณูุฉ": 148}
    error_log TEXT,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## ุงูุฌุฏูู ุงูุฒููู

| ุงููุฑุญูุฉ | ุงูููุงู | ุงูุณุงุนุงุช | ุงูุฃุณุงุจูุน |
|---------|--------|---------|----------|
| 1 | ุฅุฏุงุฑุฉ ุงูุนููุงุก ูุงูุงุดุชุฑุงูุงุช | 120 | 3 |
| 2 | ุงูุชุนุฑูุงุช ูุงููุฑุงุกุงุช | 80 | 2 |
| 3 | ุงูููุชุฑุฉ ุงูุฃุณุงุณูุฉ | 160 | 4 |
| 4 | ุงูููุชุฑุฉ ุงููุชูุฏูุฉ (ุฏูุฑูุฉุ ููุงูุจ) | 120 | 3 |
| 5 | ุงูุชุญุตูู ูุงููุฏููุนุงุช | 160 | 4 |
| 6 | ูุธุงู STS | 120 | 3 |
| 7 | ุฅุฏุงุฑุฉ ุงูุฏููู ูุฎุทุท ุงูุณุฏุงุฏ | 160 | 4 |
| 8 | ุงูุชุฐููุฑุงุช ูุงูุฅุดุนุงุฑุงุช | 80 | 2 |
| 9 | ุงููุตู ูุงูุชูุตูู | 80 | 2 |
| 10 | ุงูุชูุงุฑูุฑ ูุงูุชุญูููุงุช | 160 | 4 |
| 11 | ุงูุชูุงููุงุช ูุงูุงุฎุชุจุงุฑ | 120 | 3 |
| **ุงูุฅุฌูุงูู** | | **1,360** | **34** |

---

## ุงูุฑุจุท ูุน ุงูุฃูุธูุฉ ุงูุฃุฎุฑู

| ุงููุธุงู | ููุน ุงูุฑุจุท | ุงููุตู |
|--------|-----------|-------|
| ุงููุธุงู ุงูุฃู (01) | ูุญุงุณุจู | ุดุฌุฑุฉ ุงูุญุณุงุจุงุชุ ุงููููุฏ |
| ูุธุงู ุงูุฃุตูู (03) | ุจูุงูุงุช | ุงูุนุฏุงุฏุงุชุ ุงูุงุดุชุฑุงูุงุช |
| ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ (04) | ุชุดุบููู | ุงููุฑุงุกุงุชุ ุงููุตูุ ุงูุชูุตููุ ุงูุชุญุตูู ุงูููุฏุงูู |
| ูุธุงู ุงููุฑุงูุจุฉ ูุงูุชุญูู (06) | ุจูุงูุงุช | ูุฑุงุกุงุช ุงูุนุฏุงุฏุงุช ุงูุฐููุฉ |
| ูุธุงู ุงููุฎุฒูู (07) | ุชุดุบููู | ููุงุฏ ุงูุชุฑููุจ ูุงูุตูุงูุฉ |

---

## ๐ฆ ูุญุฏุฉ ุงูุชูุงูู ุงูุจููู (Banking Integration Module)

### ๐ฏ ุงูุบุฑุถ

ุฑุจุท ุงููุธุงู ูุจุงุดุฑุฉ ูุน ุงูุจููู ูุงููุญุงูุธ ุงูุฅููุชุฑูููุฉ ูุฃุชูุชุฉ ุนูููุฉ ุงูุชุญุตูู ูุงููุทุงุจูุฉ.

### ๐ ุขููุฉ ุงูุนูู

```
1. ุงูุนููู ููุฏุน ูู ุญุณุงุจ ุงููุญุทุฉ ุงูุจููู
2. ุงูุจูู ูุฑุณู ุฅุดุนุงุฑ (Webhook) ูููุธุงู
3. ุงููุธุงู ูุญุงูู ูุทุงุจูุฉ ุงูุฅูุฏุงุน ูุน ูุงุชูุฑุฉ ููุชูุญุฉ
4. ุนูุฏ ูุฌุงุญ ุงููุทุงุจูุฉ:
   - ุชุญุฏูุซ ุญุงูุฉ ุงููุงุชูุฑุฉ ุฅูู "ูุฏููุนุฉ"
   - ุชุญุฏูุซ ุฑุตูุฏ ุงููุดุชุฑู
   - ุฅูุดุงุก ููุฏ ูุญุงุณุจู ุชููุงุฆู
5. ุนูุฏ ูุดู ุงููุทุงุจูุฉ:
   - ุฅุถุงูุฉ ุงูุฅูุฏุงุน ููุงุฆูุฉ "ุบูุฑ ูุทุงุจู"
   - ุงููุญุงุณุจ ูุฑุงุฌุน ููุฑุจุท ูุฏููุงู
```

### ๐ ุฌุฏูู ุงูุญุณุงุจุงุช ุงูุจูููุฉ (bank_accounts)

```sql
CREATE TABLE bank_accounts (
    id UUID PRIMARY KEY,
    business_id UUID NOT NULL,
    
    bank_name VARCHAR(100) NOT NULL,
    account_number VARCHAR(50) NOT NULL,
    account_name VARCHAR(200),
    iban VARCHAR(50),
    swift_code VARCHAR(20),
    
    account_type VARCHAR(50), -- current, savings, wallet
    currency VARCHAR(10) DEFAULT 'YER',
    
    -- ุงูุชูุงูู
    has_api_integration BOOLEAN DEFAULT false,
    api_endpoint VARCHAR(500),
    api_key_encrypted TEXT,
    webhook_url VARCHAR(500),
    webhook_secret_encrypted TEXT,
    
    -- ุงูุฑุจุท ุงููุญุงุณุจู
    ledger_account_id UUID REFERENCES accounts(id),
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### ๐ ุฌุฏูู ุงูุฅูุฏุงุนุงุช ุงูุจูููุฉ (bank_deposits)

```sql
CREATE TABLE bank_deposits (
    id UUID PRIMARY KEY,
    business_id UUID NOT NULL,
    bank_account_id UUID REFERENCES bank_accounts(id),
    
    -- ุจูุงูุงุช ุงูุฅูุฏุงุน
    deposit_date TIMESTAMP NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    reference_number VARCHAR(100),
    depositor_name VARCHAR(200),
    depositor_phone VARCHAR(20),
    description TEXT,
    
    -- ุงููุตุฏุฑ
    source VARCHAR(50), -- api, webhook, manual
    raw_data JSONB, -- ุงูุจูุงูุงุช ุงูุฎุงู ูู ุงูุจูู
    
    -- ุงููุทุงุจูุฉ
    matching_status VARCHAR(50) DEFAULT 'pending', -- pending, auto_matched, manual_matched, unmatched
    matched_invoice_id UUID REFERENCES invoices(id),
    matched_customer_id UUID REFERENCES customers(id),
    matched_at TIMESTAMP,
    matched_by UUID REFERENCES users(id),
    matching_notes TEXT,
    
    -- ุงูููุฏ ุงููุญุงุณุจู
    payment_id UUID REFERENCES payments(id),
    journal_entry_id UUID,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### ๐ป ุดุงุดุฉ ูุทุงุจูุฉ ุงูุฅูุฏุงุนุงุช ุงูุจูููุฉ

**ุงูุบุฑุถ:** ูุงุฌูุฉ ูููุญุงุณุจ ููุฑุงุฌุนุฉ ุงูุฅูุฏุงุนุงุช ุงูุชู ูู ูุณุชุทุน ุงููุธุงู ูุทุงุจูุชูุง ุชููุงุฆูุงู.

**ุงูููููุงุช:**

| ุงููุณู | ุงููุญุชูู |
|-------|--------|
| **ุงูุฌุงูุจ ุงูุฃูุณุฑ** | ูุงุฆูุฉ ุงูุฅูุฏุงุนุงุช ุบูุฑ ุงููุทุงุจูุฉ (ุงูุชุงุฑูุฎุ ุงููุจูุบุ ุงุณู ุงูููุฏุน) |
| **ุงูุฌุงูุจ ุงูุฃููู** | ูุงุฆูุฉ ุงูููุงุชูุฑ ุงูููุชูุญุฉ (ุฑูู ุงููุงุชูุฑุฉุ ุงูุนูููุ ุงููุจูุบ) |
| **ุงูุฅุฌุฑุงุก** | ุณุญุจ ูุฅููุงุช (Drag & Drop) ููุฑุจุท |
| **ุงูููุงุชุฑ** | ุญุณุจ ุงูุจููุ ุงูุชุงุฑูุฎุ ุงููุจูุบ |

### ๐ฑ APIs ููุชูุงูู ุงูุจููู

```
-- ุงุณุชูุจุงู Webhooks
POST   /api/v1/webhooks/bank/:bank_code    - ุงุณุชูุจุงู ุฅุดุนุงุฑ ุฅูุฏุงุน ูู ุงูุจูู

-- ุฅุฏุงุฑุฉ ุงูุฅูุฏุงุนุงุช
GET    /api/v1/bank-deposits               - ูุงุฆูุฉ ุงูุฅูุฏุงุนุงุช
GET    /api/v1/bank-deposits/unmatched     - ุงูุฅูุฏุงุนุงุช ุบูุฑ ุงููุทุงุจูุฉ
POST   /api/v1/bank-deposits/:id/match     - ุฑุจุท ุฅูุฏุงุน ุจูุงุชูุฑุฉ ูุฏููุงู
POST   /api/v1/bank-deposits/sync          - ูุฒุงููุฉ ูุฏููุฉ ูุน ุงูุจูู

-- ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช ุงูุจูููุฉ
GET    /api/v1/bank-accounts               - ูุงุฆูุฉ ุงูุญุณุงุจุงุช
POST   /api/v1/bank-accounts               - ุฅุถุงูุฉ ุญุณุงุจ ุจููู
POST   /api/v1/bank-accounts/:id/test      - ุงุฎุชุจุงุฑ ุงูุงุชุตุงู
```

### ๐ ุงูููุฏ ุงููุญุงุณุจู ุงูุชููุงุฆู ุนูุฏ ุงููุทุงุจูุฉ

```
ูู ุญู/ ุงูุจูู (ุญุณุจ ุงูุญุณุงุจ ุงูุจููู)
    ุฅูู ุญู/ ุฐูู ุงูุนููุงุก (120)

ุงูููุงุญุธุงุช: ุฑูู ุงููุงุชูุฑุฉุ ุฑูู ุงูุนูููุ ูุฑุฌุน ุงูุฅูุฏุงุน ุงูุจููู
```

---

## ุงูุชูุงููุงุช ุงูุฎุงุฑุฌูุฉ

| ุงูุชูุงูู | ุงููุตู |
|---------|-------|
| **STS** | ูุธุงู ุงูุฏูุน ุงููุณุจู ููููุฑุจุงุก |
| **ุจูุงุจุงุช ุงูุฏูุน** | ููุฑูุ ูุงุดุ ุจุทุงูุงุช |
| **ุงูุจููู (API)** | ุงูุญูุดุจูุ ุงููุฑูููุ ูุงู - ูุงุณุชูุจุงู ุงูุฅูุฏุงุนุงุช |
| **ุงููุญุงูุธ ุงูุฅููุชุฑูููุฉ** | ูููุณูุ ุฌูุจ - ูุงุณุชูุจุงู ุงููุฏููุนุงุช |
| **SMS Gateway** | ุฅุฑุณุงู ุงูุฑุณุงุฆู ุงููุตูุฉ |
| **WhatsApp Business API** | ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช ุนุจุฑ ูุงุชุณุงุจ |
| **Email Service** | ุฅุฑุณุงู ุงูููุงุชูุฑ ุจุงูุจุฑูุฏ |
| **IoT/Smart Meters** | ูุฑุงุกุฉ ุงูุนุฏุงุฏุงุช ุงูุฐููุฉ |


---

## 12. ุฏุนู ูุดุฑูุน ุงูุชุฑุญูู ุฅูู IoT (Migration Support)

> **ุงูุบุฑุถ:** ุชูููุฑ ุงูุจูุงูุงุช ูุงูุชูุงุฑูุฑ ุงููุงุฒูุฉ ููุดุฑูุน ุชุฑุญูู ุงููุดุชุฑููู ูู ุงูุดุจูุฉ ุงูุชูููุฏูุฉ ุฅูู ุงูุดุจูุฉ ุงูุฐููุฉ.

### 12.1 ุญููู ุฅุถุงููุฉ ูู ููู ุงููุดุชุฑู

```sql
-- ุฅุถุงูุฉ ููุฌุฏูู customers (ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ)
ALTER TABLE customers ADD COLUMN IF NOT EXISTS
    -- ุจูุงูุงุช ุงูุฑุจุท ุจุงูุดุจูุฉ
    distribution_box_id UUID,  -- ุงูุทุจููู ุงูุญุงูู
    wire_length_meters DECIMAL(6, 2),  -- ุทูู ุงูุณูู ุงูุญุงูู
    
    -- ููุชุฑุญูู
    migration_status VARCHAR(20) DEFAULT 'not_started',  -- 'not_started', 'planned', 'invoiced', 'migrated'
    old_wire_length_meters DECIMAL(6, 2),  -- ุทูู ุงูุณูู ุงููุฏูู (ูุจู ุงูุชุฑุญูู)
    migration_date TIMESTAMP,
    migration_plan_id UUID;  -- ุฎุทุฉ ุงูุชุฑุญูู ุงููุฑุชุจุท ุจูุง
```

### 12.2 ุดุงุดุฉ ุชุณุฌูู ูููุน ุงููุดุชุฑู (GPS)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ ุชุณุฌูู ูููุน ุงููุดุชุฑู                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                     โ
โ  ุงููุดุชุฑู: ุฃุญูุฏ ูุญูุฏ ุนูู (#1234)                                     โ
โ  ุงูุนููุงู: ุญู ุงููุตุฑุ ุดุงุฑุน 15                                         โ
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                      ุงูุฎุฑูุทุฉ                                โ   โ
โ  โ                                                             โ   โ
โ  โ                    ๐ (ุงููููุน ุงูุญุงูู)                       โ   โ
โ  โ                                                             โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                     โ
โ  ุงูุฅุญุฏุงุซูุงุช: [15.354789    ] [44.208934    ]                       โ
โ  ุงูุฏูุฉ: 5 ูุชุฑ                                                       โ
โ                                                                     โ
โ  ุงูุทุจููู ุงููุฑุชุจุท: [ุทุจููู-001 โผ]                                     โ
โ  ุทูู ุงูุณูู: [45        ] ูุชุฑ                                        โ
โ                                                                     โ
โ  [๐ฑ ุชุญุฏูุฏ ูู GPS] [๐พ ุญูุธ ุงููููุน]                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 12.3 ุชูุฑูุฑ ุงููุดุชุฑููู ุงููุฏุนูููู ููุชุฑุญูู (ุตูุฏูู ุงูุฏุนู)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ ุชูุฑูุฑ ุงูุชุณููุฉ ูุน ุตูุฏูู ุฏุนู ูุชูููุฉ ุงูุญุฏูุฏุฉ                       โ
โ  ุงููุชุฑุฉ: [01/01/2025] ุฅูู [31/12/2025]              [ุฅูุดุงุก ุงูุชูุฑูุฑ] โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ุฅุฌูุงูู ุงููุดุชุฑููู ุงููุฏุนูููู:     2,200 ูุดุชุฑู                   โ โ
โ  โ ุชู ุชุฑุญูููู:                      450 ูุดุชุฑู (20%)              โ โ
โ  โ ุจุงูุชุธุงุฑ ุงูุชุฑุญูู:                 1,750 ูุดุชุฑู                  โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                     โ
โ  ููุฎุต ุงูุฃุณูุงู:                                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ุฅุฌูุงูู ุทูู ุงูุฃุณูุงู ุงููุฏููุฉ:   22,500 ูุชุฑ                       โ โ
โ  โ ุฅุฌูุงูู ุทูู ุงูุฃุณูุงู ุงูุฌุฏูุฏุฉ:   15,200 ูุชุฑ                       โ โ
โ  โ ุฅุฌูุงูู ุงูุชูููุฑ:               7,300 ูุชุฑ (32%)                  โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                     โ
โ  ุงูุนุฏุงุฏุงุช ุงููุฑุชุฌุนุฉ:                                                 โ
โ  โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ ุงูุฑูู ุงูุชุณูุณููโ ุงููุดุชุฑู      โ ุชุงุฑูุฎ ุงููู โ ุญุงูุฉ ุงูุชุณููู      โ  โ
โ  โโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโผโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโค  โ
โ  โ MTR-001234   โ ุฃุญูุฏ ูุญูุฏ    โ 15/03/2025 โ โ ุชู ุงูุชุณููู     โ  โ
โ  โ MTR-001235   โ ุนูู ุญุณู      โ 15/03/2025 โ โ ุชู ุงูุชุณููู     โ  โ
โ  โ MTR-001236   โ ูุญูุฏ ุณุนูุฏ    โ 20/03/2025 โ โณ ุจุงูุชุธุงุฑ        โ  โ
โ  โโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโดโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                     โ
โ  [ุชุตุฏูุฑ PDF] [ุชุตุฏูุฑ Excel] [ุทุจุงุนุฉ]                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 12.4 ูุงุชูุฑุฉ ุงูุชุฑุญูู (Migration Invoice)

```sql
-- ููุน ูุงุชูุฑุฉ ุฌุฏูุฏ
INSERT INTO invoice_types (code, name) VALUES ('migration', 'ูุงุชูุฑุฉ ุชุฑุญูู');

-- ุญููู ุฅุถุงููุฉ ูููุงุชูุฑุฉ
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS
    migration_plan_id UUID,  -- ุฎุทุฉ ุงูุชุฑุญูู
    migration_item_id UUID;  -- ุชูุงุตูู ุงูุชุฑุญูู ูููุดุชุฑู
```

### 12.5 APIs ุฏุนู ุงูุชุฑุญูู

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| PUT | `/api/v1/customers/:id/location` | ุชุญุฏูุซ ูููุน ุงููุดุชุฑู GPS |
| PUT | `/api/v1/customers/:id/distribution-box` | ุฑุจุท ุงููุดุชุฑู ุจุทุจููู |
| PUT | `/api/v1/customers/:id/wire-length` | ุชุญุฏูุซ ุทูู ุงูุณูู |
| GET | `/api/v1/customers/migration-status` | ูุงุฆูุฉ ุงููุดุชุฑููู ุญุณุจ ุญุงูุฉ ุงูุชุฑุญูู |
| GET | `/api/v1/customers/by-box/:box_id` | ุงููุดุชุฑููู ุงููุฑุชุจุทูู ุจุทุจููู |
| POST | `/api/v1/customers/:id/migration-invoice` | ุฅูุดุงุก ูุงุชูุฑุฉ ุชุฑุญูู |
| GET | `/api/v1/reports/fund-settlement` | ุชูุฑูุฑ ุงูุชุณููุฉ ูุน ุตูุฏูู ุงูุฏุนู |
| GET | `/api/v1/reports/returned-meters` | ูุงุฆูุฉ ุงูุนุฏุงุฏุงุช ุงููุฑุชุฌุนุฉ |
| GET | `/api/v1/reports/wire-savings` | ุชูุฑูุฑ ุชูููุฑ ุงูุฃุณูุงู |



---

# 15. ุฑุจุท ุงูุนููุงุก ุจุงููุดุงุฑูุน (Customer-Project Integration) - ููู 19

> **ุงูุบุฑุถ:** ุฑุจุท ุงูุนููุงุก ุงููุณุชูุฏููู ุจูุดุงุฑูุน ุงูุชุฑุญูู ูุญุฒู ุงูุนูู ูุชุชุจุน ุญุงูุฉ ูู ุนููู

## 15.1 ุฌุฏูู ุชุฑุญูู ุงูุนููุงุก (customer_migrations)

```sql
CREATE TABLE customer_migrations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL REFERENCES customers(id),
    project_id UUID NOT NULL REFERENCES projects(id),
    work_package_id UUID REFERENCES work_packages(id),
    
    -- ุญุงูุฉ ุงูุชุฑุญูู
    migration_status VARCHAR(30) DEFAULT 'pending',
    -- 'pending': ุจุงูุชุธุงุฑ ุงูุชุฑุญูู
    -- 'scheduled': ูุฌุฏูู
    -- 'in_progress': ููุฏ ุงูุชูููุฐ
    -- 'completed': ููุชูู
    -- 'failed': ูุดู
    -- 'cancelled': ููุบู
    
    -- ุงูุนุฏุงุฏ ุงููุฏูู
    old_meter_id UUID REFERENCES assets(id),
    old_meter_serial VARCHAR(50),
    old_meter_reading DECIMAL(12, 2),
    old_meter_reading_date TIMESTAMP,
    old_meter_condition VARCHAR(20),
    -- 'working': ูุนูู
    -- 'faulty': ูุนุทู
    -- 'damaged': ุชุงูู
    
    -- ุงูุนุฏุงุฏ ุงูุฌุฏูุฏ
    new_meter_id UUID REFERENCES assets(id),
    new_meter_serial VARCHAR(50),
    new_meter_reading DECIMAL(12, 2),
    new_meter_reading_date TIMESTAMP,
    
    -- ุงูุทุจููู
    old_box_id UUID,
    new_box_id UUID REFERENCES assets(id),
    
    -- ุงูุชูุตูู
    old_wire_length DECIMAL(6, 2),
    new_wire_length DECIMAL(6, 2),
    wire_savings DECIMAL(6, 2) GENERATED ALWAYS AS (old_wire_length - new_wire_length) STORED,
    
    -- ุงูุชูููุฐ
    scheduled_date DATE,
    executed_date DATE,
    executed_by UUID REFERENCES users(id),
    
    -- ุงูุชูุซูู
    photos_before JSONB,
    photos_after JSONB,
    customer_signature TEXT,
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_customer_migrations_customer ON customer_migrations(customer_id);
CREATE INDEX idx_customer_migrations_project ON customer_migrations(project_id);
CREATE INDEX idx_customer_migrations_status ON customer_migrations(migration_status);
CREATE INDEX idx_customer_migrations_work_package ON customer_migrations(work_package_id);
```

## 15.2 ุดุงุดุฉ ูุงุฆูุฉ ุงูุนููุงุก ุงููุณุชูุฏููู ููุชุฑุญูู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฅ ุนููุงุก ุงููุดุฑูุน: ุชุฑุญูู ุญู ุงูุณูุงู ุฅูู IoT                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโ ููุฎุต ุงูุชุฑุญูู โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ุฅุฌูุงูู ุงูุนููุงุก: 50 | ููุชูู: 35 (70%) | ุฌุงุฑู: 8 | ูุนูู: 7              โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                             โ
โ  ุงูุญุงูุฉ: [ุงููู โผ]  ุญุฒูุฉ ุงูุนูู: [ุงููู โผ]  [๐ ุจุญุซ]                         โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ # โ ุงูุนููู โ ุฑูู ุงูุญุณุงุจ โ ุงูุนุฏุงุฏ ุงููุฏูู โ ุงูุนุฏุงุฏ ุงูุฌุฏูุฏ โ ุงูุญุงูุฉ โ ุญุฒูุฉโโ
โ  โโโโโผโโโโโโโโโผโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโผโโโโโโโโโผโโโโโโโคโ
โ  โ 1 โ ุฃุญูุฏ   โ 1234       โ MTR-OLD-101   โ MTR-IOT-001   โ โ ููุชููโ ุญุฒูุฉ2โโ
โ  โ 2 โ ุนูู    โ 1235       โ MTR-OLD-102   โ MTR-IOT-002   โ โ ููุชููโ ุญุฒูุฉ2โโ
โ  โ 3 โ ูุญููุฏ  โ 1236       โ MTR-OLD-103   โ -             โ โณ ุฌุงุฑู โ ุญุฒูุฉ4โโ
โ  โ 4 โ ูุงุทูุฉ  โ 1237       โ MTR-OLD-104   โ -             โ ๐ฒ ูุนูู โ -    โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                             โ
โ  [ุชุตุฏูุฑ] [ุฅุถุงูุฉ ุนููุงุก ูููุดุฑูุน]                                             โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 15.3 ุดุงุดุฉ ุชูุงุตูู ุชุฑุญูู ุนููู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ค ุชูุงุตูู ุชุฑุญูู ุงูุนููู: ุฃุญูุฏ ูุญูุฏ ุนูู                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  ุฑูู ุงูุญุณุงุจ: 1234 | ุงููุดุฑูุน: ุชุฑุญูู ุญู ุงูุณูุงู | ุญุฒูุฉ ุงูุนูู: ุญุฒูุฉ 2         โ
โ                                                                             โ
โ  โโ ุงูุนุฏุงุฏ ุงููุฏูู โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ุงูุฑูู ุงูุชุณูุณูู: MTR-OLD-101                                           โ โ
โ  โ ุงููุฑุงุกุฉ ุงูุฃุฎูุฑุฉ: 45,230 ูููููุงุท (2025-01-15)                          โ โ
โ  โ ุงูุญุงูุฉ: ูุนูู                                                          โ โ
โ  โ ุทูู ุงูุณูู: 85 ูุชุฑ                                                     โ โ
โ  โ ุงูุทุจููู: TB-OLD-A                                                     โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                             โ
โ  โโ ุงูุนุฏุงุฏ ุงูุฌุฏูุฏ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ุงูุฑูู ุงูุชุณูุณูู: MTR-IOT-001                                           โ โ
โ  โ ุงููุฑุงุกุฉ ุงูุฃููู: 0 ูููููุงุท (2025-01-15)                                โ โ
โ  โ ุทูู ุงูุณูู: 25 ูุชุฑ                                                     โ โ
โ  โ ุงูุทุจููู: FB-003                                                       โ โ
โ  โ ููุฑ ุงูุณูู: 60 ูุชุฑ โ                                                  โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                             โ
โ  โโ ุงูุชูุซูู โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ุชุงุฑูุฎ ุงูุชูููุฐ: 2025-01-15                                             โ โ
โ  โ ุงูููู ุงููููุฐ: ุณุงูู ุฃุญูุฏ                                               โ โ
โ  โ ุตูุฑ ูุจู: [3 ุตูุฑ] | ุตูุฑ ุจุนุฏ: [4 ุตูุฑ]                                   โ โ
โ  โ ุชูููุน ุงูุนููู: โ ููุฌูุฏ                                                โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 15.4 ุชูุฑูุฑ ููุฑ ุงูุฃุณูุงู ูููุดุฑูุน

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ ุชูุฑูุฑ ููุฑ ุงูุฃุณูุงู: ุชุฑุญูู ุญู ุงูุณูุงู ุฅูู IoT                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโ ููุฎุต ุงูููุฑ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ุฅุฌูุงูู ุทูู ุงูุฃุณูุงู ุงููุฏููุฉ: 4,250 ูุชุฑ                                 โ โ
โ  โ ุฅุฌูุงูู ุทูู ุงูุฃุณูุงู ุงูุฌุฏูุฏุฉ: 1,275 ูุชุฑ                                 โ โ
โ  โ ุฅุฌูุงูู ุงูููุฑ: 2,975 ูุชุฑ (70%)                                         โ โ
โ  โ ูููุฉ ุงูููุฑ ุงูุชูุฏูุฑูุฉ: 74,375 ุฑูุงู                                     โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                             โ
โ  โโ ุงูุชูุงุตูู ุญุณุจ ุงูุทุจููู ุงูุฌุฏูุฏ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ุงูุทุจููู   โ ุนุฏุฏ ุงูุนููุงุก โ ุงูุฃุณูุงู ุงููุฏููุฉ โ ุงูุฃุณูุงู ุงูุฌุฏูุฏุฉ โ ุงูููุฑ   โ โ
โ  โ FB-001    โ 15          โ 1,275 ู         โ 375 ู           โ 900 ู   โ โ
โ  โ FB-002    โ 18          โ 1,530 ู         โ 450 ู           โ 1,080 ู โ โ
โ  โ FB-003    โ 17          โ 1,445 ู         โ 450 ู           โ 995 ู   โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                             โ
โ  [ุชุตุฏูุฑ ุงูุชูุฑูุฑ]                                                           โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 15.5 APIs ุฑุจุท ุงูุนููุงุก ุจุงููุดุงุฑูุน

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/projects/:id/customers` | ุนููุงุก ูุดุฑูุน ูุนูู |
| POST | `/api/v1/projects/:id/customers` | ุฅุถุงูุฉ ุนููุงุก ูููุดุฑูุน |
| GET | `/api/v1/projects/:id/customers/status` | ุญุงูุฉ ุชุฑุญูู ุงูุนููุงุก |
| GET | `/api/v1/customers/:id/migration` | ุชูุงุตูู ุชุฑุญูู ุนููู |
| PUT | `/api/v1/customer-migrations/:id` | ุชุญุฏูุซ ุญุงูุฉ ุงูุชุฑุญูู |
| GET | `/api/v1/projects/:id/wire-savings` | ุชูุฑูุฑ ููุฑ ุงูุฃุณูุงู |
| GET | `/api/v1/work-packages/:id/customers` | ุนููุงุก ุญุฒูุฉ ุนูู |


---

## ุงูุชูุงูู ูุน ูุธุงู ุงูุชุฎุทูุท ูุงููุดุงุฑูุน (10)

> **ููุชูุงุตูู ุงููุงููุฉ ุนู ุฑุจุท ุงูุนููุงุก ุจูุดุงุฑูุน ุงูุชุฑุญููุ ุฑุงุฌุน:** [ูุธุงู ุงูุชุฎุทูุท ูุงููุดุงุฑูุน (10)](./10_ูุธุงู_ุงูุชุฎุทูุท_ูุงููุดุงุฑูุน.md)

### ุงูุญููู ุงููุฑุชุจุทุฉ ูู ุฌุฏูู ุงูุนููุงุก

| ุงูุญูู | ุงููุตู |
|-------|-------|
| `migration_project_id` | ูุดุฑูุน ุงูุชุฑุญูู |
| `migration_work_package_id` | ุญุฒูุฉ ุนูู ุงูุชุฑุญูู |

---

# 15๏ธโฃ ุงูุชุญูู ุนู ุจูุนุฏ ุจุงูุนุฏุงุฏุงุช (Remote Meter Control)

> **ุงูุบุฑุถ:** ุชูููู ูุตู/ูุตู ุงูุฎุฏูุฉ ุนู ุจูุนุฏ ูู ุบุฑูุฉ ุงูุชุญูู ุงููุฑูุฒูุฉ

## 15.1 ุฌุฏูู ุฃูุงูุฑ ุงูุชุญูู ุจุงูุนุฏุงุฏุงุช (meter_control_commands)

```sql
CREATE TABLE meter_control_commands (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ุงูุนููู ูุงูุนุฏุงุฏ
    customer_id UUID REFERENCES customers(id),
    meter_id UUID REFERENCES meters(id),
    
    -- ููุน ุงูุฃูุฑ
    command_type VARCHAR(30) NOT NULL,  -- 'disconnect', 'reconnect', 'limit_power'
    
    -- ุงูุณุจุจ
    reason_type VARCHAR(50),            -- 'debt', 'maintenance', 'customer_request', 'violation', 'emergency'
    reason_details TEXT,
    
    -- ุญุฏูุฏ ุงูุทุงูุฉ (ููุฃูุฑ limit_power)
    power_limit_kw DECIMAL(10,2),
    
    -- ุงูุชูููุฐ
    status VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'sent', 'confirmed', 'failed'
    sent_at TIMESTAMP,
    confirmed_at TIMESTAMP,
    error_message TEXT,
    
    -- ุงุณุชุฌุงุจุฉ ุงูุนุฏุงุฏ
    meter_response JSONB,
    
    -- ุงูุชุชุจุน
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    
    -- ุงูููุงููุฉ
    requires_approval BOOLEAN DEFAULT FALSE,
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP
);

CREATE INDEX idx_meter_control_customer ON meter_control_commands(customer_id);
CREATE INDEX idx_meter_control_status ON meter_control_commands(status);
```

## 15.2 Function: ูุตู ุงูุนุฏุงุฏ ุนู ุจูุนุฏ

```sql
CREATE OR REPLACE FUNCTION remote_disconnect_meter(
    p_customer_id UUID,
    p_reason_type VARCHAR(50),
    p_reason_details TEXT,
    p_operator_id UUID
)
RETURNS JSONB AS $$
DECLARE
    v_command_id UUID;
    v_meter_id UUID;
    v_meter_serial VARCHAR(100);
    v_result JSONB;
BEGIN
    -- ุฌูุจ ูุนูููุงุช ุงูุนุฏุงุฏ
    SELECT m.id, m.serial_number INTO v_meter_id, v_meter_serial
    FROM customers c
    JOIN meters m ON m.id = c.meter_id
    WHERE c.id = p_customer_id;
    
    IF v_meter_id IS NULL THEN
        RETURN jsonb_build_object('success', FALSE, 'error', 'ูุง ููุฌุฏ ุนุฏุงุฏ ูุฑุชุจุท ุจุงูุนููู');
    END IF;
    
    -- ุฅูุดุงุก ุณุฌู ุงูุฃูุฑ
    INSERT INTO meter_control_commands (
        customer_id, meter_id, command_type, reason_type, reason_details, created_by
    ) VALUES (
        p_customer_id, v_meter_id, 'disconnect', p_reason_type, p_reason_details, p_operator_id
    ) RETURNING id INTO v_command_id;
    
    -- ุฅุฑุณุงู ุงูุฃูุฑ ููุนุฏุงุฏ ุนุจุฑ API (Acrel/STS)
    -- ูู ุงูุฅูุชุงุฌ: ุงุณุชุฏุนุงุก API ุญูููู
    v_result := jsonb_build_object(
        'success', TRUE,
        'command_id', v_command_id,
        'meter_serial', v_meter_serial,
        'action', 'disconnect',
        'executed_at', NOW()
    );
    
    -- ุชุญุฏูุซ ุญุงูุฉ ุงูุฃูุฑ
    UPDATE meter_control_commands 
    SET status = 'confirmed', 
        sent_at = NOW(),
        confirmed_at = NOW(),
        meter_response = v_result
    WHERE id = v_command_id;
    
    -- ุชุญุฏูุซ ุญุงูุฉ ุงูุนููู
    UPDATE customers 
    SET status = 'disconnected',
        disconnection_date = CURRENT_DATE
    WHERE id = p_customer_id;
    
    -- ุฅูุดุงุก ุฅุดุนุงุฑ ููุนููู
    INSERT INTO customer_notifications (customer_id, notification_type, message)
    VALUES (p_customer_id, 'service_disconnected', 'ุชู ูุตู ุงูุฎุฏูุฉ. ุงูุณุจุจ: ' || p_reason_details);
    
    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
```

## 15.3 Function: ูุตู ุงูุนุฏุงุฏ ุนู ุจูุนุฏ

```sql
CREATE OR REPLACE FUNCTION remote_reconnect_meter(
    p_customer_id UUID,
    p_reason_details TEXT,
    p_operator_id UUID
)
RETURNS JSONB AS $$
DECLARE
    v_command_id UUID;
    v_meter_id UUID;
    v_meter_serial VARCHAR(100);
    v_outstanding_balance DECIMAL(15,2);
    v_result JSONB;
BEGIN
    -- ุฌูุจ ูุนูููุงุช ุงูุนุฏุงุฏ
    SELECT m.id, m.serial_number INTO v_meter_id, v_meter_serial
    FROM customers c
    JOIN meters m ON m.id = c.meter_id
    WHERE c.id = p_customer_id;
    
    IF v_meter_id IS NULL THEN
        RETURN jsonb_build_object('success', FALSE, 'error', 'ูุง ููุฌุฏ ุนุฏุงุฏ ูุฑุชุจุท ุจุงูุนููู');
    END IF;
    
    -- ุงูุชุญูู ูู ุงูุฑุตูุฏ ุงููุณุชุญู
    SELECT COALESCE(SUM(remaining_amount), 0) INTO v_outstanding_balance
    FROM invoices WHERE customer_id = p_customer_id AND status IN ('unpaid', 'partial');
    
    -- ุฅูุดุงุก ุณุฌู ุงูุฃูุฑ
    INSERT INTO meter_control_commands (
        customer_id, meter_id, command_type, reason_type, reason_details, created_by
    ) VALUES (
        p_customer_id, v_meter_id, 'reconnect', 'payment_received', p_reason_details, p_operator_id
    ) RETURNING id INTO v_command_id;
    
    -- ุฅุฑุณุงู ุงูุฃูุฑ ููุนุฏุงุฏ
    v_result := jsonb_build_object(
        'success', TRUE,
        'command_id', v_command_id,
        'meter_serial', v_meter_serial,
        'action', 'reconnect',
        'outstanding_balance', v_outstanding_balance,
        'executed_at', NOW()
    );
    
    -- ุชุญุฏูุซ ุญุงูุฉ ุงูุฃูุฑ
    UPDATE meter_control_commands 
    SET status = 'confirmed', 
        sent_at = NOW(),
        confirmed_at = NOW(),
        meter_response = v_result
    WHERE id = v_command_id;
    
    -- ุชุญุฏูุซ ุญุงูุฉ ุงูุนููู
    UPDATE customers 
    SET status = 'active',
        disconnection_date = NULL
    WHERE id = p_customer_id;
    
    -- ุฅูุดุงุก ุฅุดุนุงุฑ ููุนููู
    INSERT INTO customer_notifications (customer_id, notification_type, message)
    VALUES (p_customer_id, 'service_reconnected', 'ุชู ุฅุนุงุฏุฉ ุชูุตูู ุงูุฎุฏูุฉ.');
    
    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
```

## 15.4 APIs ุงูุชุญูู ุนู ุจูุนุฏ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | `/api/v1/meters/:id/disconnect` | ูุตู ุงูุนุฏุงุฏ ุนู ุจูุนุฏ |
| POST | `/api/v1/meters/:id/reconnect` | ูุตู ุงูุนุฏุงุฏ ุนู ุจูุนุฏ |
| POST | `/api/v1/meters/:id/limit-power` | ุชุญุฏูุฏ ุงูุญุฏ ุงูุฃูุตู ููุทุงูุฉ |
| GET | `/api/v1/meters/:id/control-history` | ุณุฌู ุฃูุงูุฑ ุงูุชุญูู |
| GET | `/api/v1/customers/:id/connection-status` | ุญุงูุฉ ุงูุงุชุตุงู ุงูุญุงููุฉ |

---

> **ุงูุธุฑ ุฃูุถุงู:** `05_ูุธุงู_ุงููุฑุงูุจุฉ_ูุงูุชุญูู.md` - ุบุฑูุฉ ุงูุชุญูู ุงููุฑูุฒูุฉ

---

## 20. ูุญุฑู ุชุณุนูุฑ ุงูุงุดุชุฑุงูุงุช (Subscription Pricing Engine)

### 20.1 ุงููุจุฏุฃ ุงูุฃุณุงุณู

> **ุญุณุงุจ ุชููุงุฆู ููุฑุณูู ุจูุงุกู ุนูู ููุน ุงูุนุฏุงุฏ ูููุน ุงูุงุณุชุฎุฏุงู**

ูููุฑ ูุญุฑู ุงูุชุณุนูุฑ ูุฑููุฉ ุนุงููุฉ ููุฅุฏุงุฑุฉ ูุชุนุฏูู ุงูุฃุณุนุงุฑ ุฏูู ุงูุญุงุฌุฉ ูุชุบููุฑุงุช ุจุฑูุฌูุฉ.

### 20.2 ุฌุฏูู ุชุณุนูุฑ ุงูุงุดุชุฑุงูุงุช (subscription_pricing)

```sql
CREATE TABLE subscription_pricing (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    station_id UUID NOT NULL REFERENCES stations(id),
    
    -- ูุนุงููุฑ ุงูุชุณุนูุฑ
    meter_type ENUM('traditional', 'sts_prepaid', 'iot_smart') NOT NULL,
    usage_type ENUM('residential', 'commercial', 'industrial', 'agricultural', 'governmental') NOT NULL,
    
    -- ุงูุฑุณูู
    subscription_fee DECIMAL(15,2) NOT NULL,      -- ุฑุณูู ุงูุงุดุชุฑุงู
    deposit_amount DECIMAL(15,2) DEFAULT 0,       -- ูุจูุบ ุงูุชุฃููู
    connection_fee DECIMAL(15,2) DEFAULT 0,       -- ุฑุณูู ุงูุชูุตูู
    meter_cost DECIMAL(15,2) DEFAULT 0,           -- ุชูููุฉ ุงูุนุฏุงุฏ (ุฅู ูุฌุฏุช)
    
    -- ุฎูุงุฑุงุช ุงูุชูุณูุท
    installment_allowed BOOLEAN DEFAULT false,
    max_installments INTEGER DEFAULT 1,
    min_down_payment_percent DECIMAL(5,2) DEFAULT 100,
    
    -- ุงูุญุงูุฉ
    is_active BOOLEAN DEFAULT true,
    effective_from DATE NOT NULL,
    effective_to DATE,
    
    -- ุงูุชุชุจุน
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    -- ููุน ุงูุชูุฑุงุฑ
    UNIQUE(station_id, meter_type, usage_type, effective_from)
);

-- ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ
INSERT INTO subscription_pricing (
    station_id, meter_type, usage_type, 
    subscription_fee, deposit_amount, connection_fee,
    installment_allowed, max_installments, min_down_payment_percent,
    effective_from
) VALUES
-- ุงูุนุฏุงุฏุงุช ุงูุชูููุฏูุฉ
('station_uuid', 'traditional', 'residential', 5000, 35000, 0, true, 6, 30, '2024-01-01'),
('station_uuid', 'traditional', 'commercial', 10000, 50000, 0, true, 6, 30, '2024-01-01'),
('station_uuid', 'traditional', 'industrial', 15000, 100000, 5000, true, 12, 25, '2024-01-01'),

-- ุนุฏุงุฏุงุช STS (ุงูุฏูุน ุงููุณุจู) - ุจุฏูู ุชุฃููู
('station_uuid', 'sts_prepaid', 'residential', 7000, 0, 0, false, 1, 100, '2024-01-01'),
('station_uuid', 'sts_prepaid', 'commercial', 12000, 0, 0, false, 1, 100, '2024-01-01'),

-- ุนุฏุงุฏุงุช IoT ุงูุฐููุฉ
('station_uuid', 'iot_smart', 'residential', 6000, 30000, 0, true, 6, 30, '2024-01-01'),
('station_uuid', 'iot_smart', 'commercial', 11000, 45000, 0, true, 6, 30, '2024-01-01');
```

### 20.3 Function: ุญุณุงุจ ุชูููุฉ ุงูุงุดุชุฑุงู

```sql
CREATE OR REPLACE FUNCTION calculate_subscription_cost(
    p_station_id UUID,
    p_meter_type VARCHAR(50),
    p_usage_type VARCHAR(50),
    p_calculation_date DATE DEFAULT CURRENT_DATE
) RETURNS TABLE (
    subscription_fee DECIMAL(15,2),
    deposit_amount DECIMAL(15,2),
    connection_fee DECIMAL(15,2),
    meter_cost DECIMAL(15,2),
    total_amount DECIMAL(15,2),
    deposit_required BOOLEAN,
    installment_allowed BOOLEAN,
    max_installments INTEGER,
    min_down_payment_percent DECIMAL(5,2)
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        sp.subscription_fee,
        sp.deposit_amount,
        sp.connection_fee,
        sp.meter_cost,
        (sp.subscription_fee + sp.deposit_amount + sp.connection_fee + sp.meter_cost) AS total_amount,
        (sp.deposit_amount > 0) AS deposit_required,
        sp.installment_allowed,
        sp.max_installments,
        sp.min_down_payment_percent
    FROM subscription_pricing sp
    WHERE sp.station_id = p_station_id
      AND sp.meter_type = p_meter_type::meter_type_enum
      AND sp.usage_type = p_usage_type::usage_type_enum
      AND sp.is_active = true
      AND sp.effective_from <= p_calculation_date
      AND (sp.effective_to IS NULL OR sp.effective_to >= p_calculation_date)
    ORDER BY sp.effective_from DESC
    LIMIT 1;
END;
$$ LANGUAGE plpgsql;
```

### 20.4 ุดุงุดุฉ ุฅุฏุงุฑุฉ ุชุณุนูุฑ ุงูุงุดุชุฑุงูุงุช

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                          ุฅุฏุงุฑุฉ ุชุณุนูุฑ ุงูุงุดุชุฑุงูุงุช                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  [+ ุฅุถุงูุฉ ุชุณุนูุฑุฉ ุฌุฏูุฏุฉ]                    [๐ ุชูุฑูุฑ ุงูุฃุณุนุงุฑ]               โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                           ุฌุฏูู ุงูุฃุณุนุงุฑ ุงูุญุงูู                               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ููุน ุงูุนุฏุงุฏ  โ ููุน ุงูุงุณุชุฎุฏุงู โ ุงูุงุดุชุฑุงู โ ุงูุชุฃููู  โ ุงูุฅุฌูุงูู โ ุฅุฌุฑุงุก โ   โ
โ  โโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโ   โ
โ  โ ุชูููุฏู     โ ููุฒูู         โ 5,000    โ 35,000   โ 40,000   โ [โ๏ธ]  โ   โ
โ  โ ุชูููุฏู     โ ุชุฌุงุฑู         โ 10,000   โ 50,000   โ 60,000   โ [โ๏ธ]  โ   โ
โ  โ ุชูููุฏู     โ ุตูุงุนู         โ 15,000   โ 100,000  โ 115,000  โ [โ๏ธ]  โ   โ
โ  โโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโ   โ
โ  โ STS ูุณุจู   โ ููุฒูู         โ 7,000    โ 0 โ     โ 7,000    โ [โ๏ธ]  โ   โ
โ  โ STS ูุณุจู   โ ุชุฌุงุฑู         โ 12,000   โ 0 โ     โ 12,000   โ [โ๏ธ]  โ   โ
โ  โโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโ   โ
โ  โ IoT ุฐูู    โ ููุฒูู         โ 6,000    โ 30,000   โ 36,000   โ [โ๏ธ]  โ   โ
โ  โ IoT ุฐูู    โ ุชุฌุงุฑู         โ 11,000   โ 45,000   โ 56,000   โ [โ๏ธ]  โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ๐ก ููุงุญุธุฉ: ุนุฏุงุฏุงุช STS (ุงูุฏูุน ุงููุณุจู) ูุง ุชุชุทูุจ ุชุฃููู                        โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 20.5 ูููุฐุฌ ุทูุจ ุงูุงุดุชุฑุงู ุงูุฑููู (ูุญุฏุซ)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                           ุทูุจ ุงุดุชุฑุงู ุฌุฏูุฏ                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                           ุจูุงูุงุช ุงููุดุชุฑู                                    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ุงูุงุณู: [ุฃุญูุฏ ูุญูุฏ ุนูู_______________________]                             โ
โ  ุฑูู ุงููููุฉ: [1234567890_____]     ุงููุงุชู: [777123456____]                 โ
โ  ุงูุนููุงู: [ุญู ุงููุตุฑุ ุดุงุฑุน 14 ููููู___________________________]             โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                           ููุน ุงูุงุดุชุฑุงู                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ููุน ุงูุนุฏุงุฏ:    [STS - ุฏูุน ูุณุจู โผ]                                         โ
โ  ููุน ุงูุงุณุชุฎุฏุงู: [ููุฒูู โผ]                                                  โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                    ๐ฐ ุญุณุงุจ ุงูุชูููุฉ ุงูุชููุงุฆู                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุงูุจูุฏ                              โ ุงููุจูุบ (ุฑูุงู)                  โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุฑุณูู ุงูุงุดุชุฑุงู                       โ 7,000                          โ   โ
โ  โ ูุจูุบ ุงูุชุฃููู                        โ 0 (ุบูุฑ ูุทููุจ ูุนุฏุงุฏุงุช STS) โ   โ   โ
โ  โ ุฑุณูู ุงูุชูุตูู                        โ 0                              โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุงูุฅุฌูุงูู ุงููุทููุจ                    โ 7,000 ุฑูุงู                     โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โ๏ธ ุนุฏุงุฏุงุช ุงูุฏูุน ุงููุณุจู (STS) ูุง ุชุชุทูุจ ุชุฃููู - ุงูุฏูุน ุงููุงูู ููุฏูุงู        โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                           ุฎูุงุฑุงุช ุงูุฏูุน                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โ ุฏูุน ูุงูู (7,000 ุฑูุงู)                                                   โ
โ  โ ุงูุชูุณูุท ุบูุฑ ูุชุงุญ ููุฐุง ุงูููุน ูู ุงูุนุฏุงุฏุงุช                                 โ
โ                                                                             โ
โ            [โ ุฅูุบุงุก]                    [โ ุฅูุดุงุก ุงูุทูุจ ูุงููุงุชูุฑุฉ]          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 20.6 ุฌุฏูู ุทูุจุงุช ุงูุงุดุชุฑุงู (subscription_requests)

```sql
CREATE TABLE subscription_requests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    station_id UUID NOT NULL REFERENCES stations(id),
    request_number VARCHAR(50) UNIQUE NOT NULL,
    
    -- ุจูุงูุงุช ุงููุดุชุฑู
    customer_name VARCHAR(200) NOT NULL,
    national_id VARCHAR(50),
    phone VARCHAR(20) NOT NULL,
    address TEXT,
    
    -- ููุน ุงูุงุดุชุฑุงู
    meter_type ENUM('traditional', 'sts_prepaid', 'iot_smart') NOT NULL,
    usage_type ENUM('residential', 'commercial', 'industrial', 'agricultural', 'governmental') NOT NULL,
    
    -- ุงูุชูููุฉ ุงููุญุณูุจุฉ
    subscription_fee DECIMAL(15,2) NOT NULL,
    deposit_amount DECIMAL(15,2) DEFAULT 0,
    connection_fee DECIMAL(15,2) DEFAULT 0,
    total_amount DECIMAL(15,2) NOT NULL,
    
    -- ุงูุชูุณูุท
    payment_method ENUM('full', 'installment') DEFAULT 'full',
    installment_count INTEGER DEFAULT 1,
    down_payment DECIMAL(15,2),
    
    -- ุงูุญุงูุฉ
    request_status ENUM(
        'pending_payment',      -- ุจุงูุชุธุงุฑ ุงูุฏูุน
        'payment_received',     -- ุชู ุงุณุชูุงู ุงูุฏูุนุฉ
        'pending_installation', -- ุจุงูุชุธุงุฑ ุงูุชุฑููุจ
        'installed',            -- ุชู ุงูุชุฑููุจ
        'activated',            -- ููุนู
        'cancelled'             -- ููุบู
    ) DEFAULT 'pending_payment',
    
    -- ุงูุฑุจุท
    invoice_id UUID REFERENCES invoices(id),
    customer_id UUID REFERENCES customers(id),
    work_order_id UUID REFERENCES work_orders(id),
    
    -- ุงูุชุชุจุน
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 20.7 Trigger: ุญุณุงุจ ุงูุชูููุฉ ุชููุงุฆูุงู

```sql
CREATE OR REPLACE FUNCTION auto_calculate_subscription_cost()
RETURNS TRIGGER AS $$
DECLARE
    v_pricing RECORD;
BEGIN
    -- ุฌูุจ ุงูุชุณุนูุฑุฉ ุงูููุงุณุจุฉ
    SELECT * INTO v_pricing
    FROM calculate_subscription_cost(
        NEW.station_id,
        NEW.meter_type::VARCHAR,
        NEW.usage_type::VARCHAR
    );
    
    IF v_pricing IS NULL THEN
        RAISE EXCEPTION 'ูุง ุชูุฌุฏ ุชุณุนูุฑุฉ ููุฐุง ุงูููุน ูู ุงูุงุดุชุฑุงูุงุช';
    END IF;
    
    -- ุชุนููู ุงูููู ุงููุญุณูุจุฉ
    NEW.subscription_fee := v_pricing.subscription_fee;
    NEW.deposit_amount := v_pricing.deposit_amount;
    NEW.connection_fee := v_pricing.connection_fee;
    NEW.total_amount := v_pricing.total_amount;
    
    -- ุงูุชุญูู ูู ุงูุชูุณูุท
    IF NEW.payment_method = 'installment' AND NOT v_pricing.installment_allowed THEN
        RAISE EXCEPTION 'ุงูุชูุณูุท ุบูุฑ ูุชุงุญ ููุฐุง ุงูููุน ูู ุงูุงุดุชุฑุงูุงุช';
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_auto_calculate_subscription
BEFORE INSERT ON subscription_requests
FOR EACH ROW
EXECUTE FUNCTION auto_calculate_subscription_cost();
```

### 20.8 ุฅูุดุงุก ุงููุงุชูุฑุฉ ุงูุฃูููุฉ ุชููุงุฆูุงู

```sql
CREATE OR REPLACE FUNCTION create_subscription_invoice()
RETURNS TRIGGER AS $$
DECLARE
    v_invoice_id UUID;
BEGIN
    -- ุฅูุดุงุก ุงููุงุชูุฑุฉ
    INSERT INTO invoices (
        station_id,
        invoice_type,
        invoice_number,
        customer_name,
        total_amount,
        status,
        due_date,
        notes
    ) VALUES (
        NEW.station_id,
        'subscription',
        'INV-SUB-' || NEW.request_number,
        NEW.customer_name,
        CASE 
            WHEN NEW.payment_method = 'full' THEN NEW.total_amount
            ELSE NEW.down_payment
        END,
        'pending',
        CURRENT_DATE + INTERVAL '7 days',
        CASE 
            WHEN NEW.meter_type = 'sts_prepaid' THEN 'ุงุดุชุฑุงู ุนุฏุงุฏ ุฏูุน ูุณุจู STS - ุจุฏูู ุชุฃููู'
            ELSE 'ุงุดุชุฑุงู ุนุฏุงุฏ ' || NEW.meter_type || ' - ' || NEW.usage_type
        END
    ) RETURNING id INTO v_invoice_id;
    
    -- ุฅุถุงูุฉ ุจููุฏ ุงููุงุชูุฑุฉ
    INSERT INTO invoice_items (invoice_id, description, amount) VALUES
    (v_invoice_id, 'ุฑุณูู ุงูุงุดุชุฑุงู', NEW.subscription_fee);
    
    -- ุฅุถุงูุฉ ุงูุชุฃููู ููุท ุฅุฐุง ูุงู ูุทููุจุงู
    IF NEW.deposit_amount > 0 THEN
        INSERT INTO invoice_items (invoice_id, description, amount) VALUES
        (v_invoice_id, 'ูุจูุบ ุงูุชุฃููู (ูุณุชุฑุฏ)', NEW.deposit_amount);
    END IF;
    
    -- ุฅุถุงูุฉ ุฑุณูู ุงูุชูุตูู ุฅุฐุง ูุฌุฏุช
    IF NEW.connection_fee > 0 THEN
        INSERT INTO invoice_items (invoice_id, description, amount) VALUES
        (v_invoice_id, 'ุฑุณูู ุงูุชูุตูู', NEW.connection_fee);
    END IF;
    
    -- ุฑุจุท ุงููุงุชูุฑุฉ ุจุงูุทูุจ
    NEW.invoice_id := v_invoice_id;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_create_subscription_invoice
BEFORE INSERT ON subscription_requests
FOR EACH ROW
EXECUTE FUNCTION create_subscription_invoice();
```

### 20.9 View: ููุฎุต ุทูุจุงุช ุงูุงุดุชุฑุงู

```sql
CREATE OR REPLACE VIEW v_subscription_requests_summary AS
SELECT 
    sr.id,
    sr.request_number,
    sr.customer_name,
    sr.phone,
    CASE sr.meter_type
        WHEN 'traditional' THEN 'ุชูููุฏู'
        WHEN 'sts_prepaid' THEN 'STS ูุณุจู'
        WHEN 'iot_smart' THEN 'IoT ุฐูู'
    END AS meter_type_ar,
    CASE sr.usage_type
        WHEN 'residential' THEN 'ููุฒูู'
        WHEN 'commercial' THEN 'ุชุฌุงุฑู'
        WHEN 'industrial' THEN 'ุตูุงุนู'
    END AS usage_type_ar,
    sr.subscription_fee,
    sr.deposit_amount,
    sr.total_amount,
    CASE 
        WHEN sr.deposit_amount = 0 THEN 'ูุง ูุชุทูุจ ุชุฃููู โ'
        ELSE 'ูุชุทูุจ ุชุฃููู'
    END AS deposit_status,
    sr.request_status,
    sr.created_at
FROM subscription_requests sr
ORDER BY sr.created_at DESC;
```

### 20.10 APIs ูุญุฑู ุงูุชุณุนูุฑ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | /api/v1/pricing | ุฌูุจ ุฌููุน ุงูุชุณุนูุฑุงุช |
| GET | /api/v1/pricing/calculate | ุญุณุงุจ ุชูููุฉ ุงุดุชุฑุงู |
| POST | /api/v1/pricing | ุฅุถุงูุฉ ุชุณุนูุฑุฉ ุฌุฏูุฏุฉ |
| PUT | /api/v1/pricing/:id | ุชุนุฏูู ุชุณุนูุฑุฉ |
| POST | /api/v1/subscriptions/requests | ุฅูุดุงุก ุทูุจ ุงุดุชุฑุงู |
| GET | /api/v1/subscriptions/requests/:id | ุชูุงุตูู ุทูุจ ุงุดุชุฑุงู |


---

# 15. ุจูุงุจุฉ ุฎุฏูุฉ ุงูุนููุงุก ุงููุชูุงููุฉ (Customer Portal)

## 15.1 ูุธุฑุฉ ุนุงูุฉ

> **ุงูุบุฑุถ:** ุชูููุฑ ูุงุฌูุฉ ููุญุฏุฉ ููุนููุงุก ูููุตูู ุฅูู ุฌููุน ุงูุฎุฏูุงุช ูุงููุนูููุงุช ุงููุชุนููุฉ ุจุงุดุชุฑุงููู ุนุจุฑ ุชุทุจูู ุฌูุงู ุฃู ูููุน ููุจ.

## 15.2 ูุญุฏุฉ "ุญุณุงุจู" (My Account)

### 15.2.1 ุชุณุฌูู ุงูุฏุฎูู ุงูุขูู

```sql
CREATE TABLE customer_portal_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL REFERENCES customers(id),
    
    -- ุจูุงูุงุช ุงูุฏุฎูู
    phone_number VARCHAR(20) UNIQUE,
    subscription_number VARCHAR(50) UNIQUE,
    password_hash VARCHAR(255),
    
    -- ุงูุชุญูู
    is_verified BOOLEAN DEFAULT FALSE,
    verification_code VARCHAR(10),
    verification_expires_at TIMESTAMP,
    
    -- ุงูุฌูุณุงุช
    last_login_at TIMESTAMP,
    last_login_ip VARCHAR(50),
    failed_login_attempts INT DEFAULT 0,
    locked_until TIMESTAMP,
    
    -- ุงูุฅุนุฏุงุฏุงุช
    language VARCHAR(10) DEFAULT 'ar',
    notification_preferences JSONB DEFAULT '{"push": true, "sms": true, "email": true}',
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ุฌุฏูู ุฌูุณุงุช ุงูุนููุงุก
CREATE TABLE customer_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    portal_user_id UUID NOT NULL REFERENCES customer_portal_users(id),
    
    token VARCHAR(500) NOT NULL UNIQUE,
    device_info JSONB,
    ip_address VARCHAR(50),
    
    expires_at TIMESTAMP NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 15.2.2 ุดุงุดุฉ ุญุณุงุจู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                              ๐ค ุญุณุงุจู                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                    [ุตูุฑุฉ ุงูุนููู ุฃู ุฃููููุฉ]                          โ   โ
โ  โ                                                                     โ   โ
โ  โ                        ุฃุญูุฏ ูุญูุฏ ุนูู                                โ   โ
โ  โ                    ุฑูู ุงูุงุดุชุฑุงู: 12345678                           โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุชูุงุตูู ุงูุงุดุชุฑุงู                                    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ููุน ุงูุนุฏุงุฏ:        โโโโโโโโโโโโโโโโโโโโ                                   โ
โ                     โ โก ุนุฏุงุฏ ุฐูู IoT  โ                                   โ
โ                     โโโโโโโโโโโโโโโโโโโโ                                   โ
โ                                                                             โ
โ  ููุน ุงูุชุนุฑูุฉ:       ููุฒูู                                                  โ
โ  ุชุงุฑูุฎ ุงูุงุดุชุฑุงู:    2023/05/15                                             โ
โ  ุงูุนููุงู:           ุญู ุงูููุฑุ ุดุงุฑุน 15ุ ููุฒู 42                             โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุงููุนูููุงุช ุงููุงููุฉ                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ูุจูุบ ุงูุชุฃููู:      35,000 ุฑ.ุณ                                             โ
โ  ุญุงูุฉ ุงูุชุฃููู:      โ ูุฏููุน ุจุงููุงูู                                       โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  [๐ ุนุฑุถ ุงูุดุฑูุท ูุงูููุงุฆุญ]        [โ๏ธ ุชุนุฏูู ุงูุจูุงูุงุช]                       โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 15.3 ูุญุฏุฉ ุงูููุงุชูุฑ ูุงูุฏูุน ุงูุฅููุชุฑููู

### 15.3.1 ุฌุฏูู ูุนุงููุงุช ุงูุฏูุน

```sql
CREATE TABLE customer_payment_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL REFERENCES customers(id),
    
    -- ููุน ุงููุนุงููุฉ
    transaction_type ENUM(
        'bill_payment',     -- ุฏูุน ูุงุชูุฑุฉ
        'prepaid_recharge', -- ุดุญู ุฑุตูุฏ
        'deposit_payment',  -- ุฏูุน ุชุฃููู
        'refund'            -- ุงุณุชุฑุฏุงุฏ
    ) NOT NULL,
    
    -- ุงููุจูุบ
    amount DECIMAL(12, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'SDG',
    
    -- ุจูุงุจุฉ ุงูุฏูุน
    payment_gateway VARCHAR(50),
    gateway_transaction_id VARCHAR(100),
    gateway_response JSONB,
    
    -- ุงูุญุงูุฉ
    status ENUM(
        'pending',
        'processing',
        'completed',
        'failed',
        'cancelled',
        'refunded'
    ) DEFAULT 'pending',
    
    -- ุงููุฑุฌุน
    reference_type VARCHAR(50),
    reference_id UUID,
    
    -- ููุดุญู ุงููุณุจู
    sts_token VARCHAR(100),
    
    -- ุงูุชูููุช
    initiated_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 15.3.2 ุดุงุดุฉ ุงูููุงุชูุฑ ูุงูุฏูุน

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ๐ณ ุงูููุงุชูุฑ ูุงูุฏูุน                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                      ุงูุฑุตูุฏ ุงูุญุงูู (STS/IoT)                        โ   โ
โ  โ                                                                     โ   โ
โ  โ                         ๐ฐ 15,250 ุฑ.ุณ                               โ   โ
โ  โ                                                                     โ   โ
โ  โ                    [๐ ุดุญู ุงูุฑุตูุฏ ุงูุขู]                             โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุงูููุงุชูุฑ ุงููุณุชุญูุฉ                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุงูุดูุฑ      โ ุงููุจูุบ      โ ุงูุญุงูุฉ      โ ุงูุฅุฌุฑุงุก                    โ   โ
โ  โโโโโโโโโโโโโโผโโโโโโโโโโโโโโผโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ ุฏูุณูุจุฑ 24 โ 8,500 ุฑ.ุณ  โ ๐ด ูุณุชุญูุฉ  โ [๐ณ ุฏูุน] [๐ PDF]          โ   โ
โ  โ ููููุจุฑ 24 โ 7,200 ุฑ.ุณ  โ โ ูุฏููุนุฉ  โ [๐ PDF]                   โ   โ
โ  โ ุฃูุชูุจุฑ 24 โ 6,800 ุฑ.ุณ  โ โ ูุฏููุนุฉ  โ [๐ PDF]                   โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุณุฌู ุงููุฏููุนุงุช                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุงูุชุงุฑูุฎ    โ ุงูููุน       โ ุงููุจูุบ      โ ุงูุทุฑููุฉ                   โ   โ
โ  โโโโโโโโโโโโโโผโโโโโโโโโโโโโโผโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ 2024/12/05 โ ุดุญู ุฑุตูุฏ   โ 10,000 ุฑ.ุณ โ ุจุทุงูุฉ ุจูููุฉ              โ   โ
โ  โ 2024/11/28 โ ุฏูุน ูุงุชูุฑุฉ โ 7,200 ุฑ.ุณ  โ ุชุญููู ุจููู               โ   โ
โ  โ 2024/11/15 โ ุดุญู ุฑุตูุฏ   โ 5,000 ุฑ.ุณ  โ ูุญูุธุฉ ุฅููุชุฑูููุฉ          โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 15.3.3 ุดุงุดุฉ ุดุญู ุงูุฑุตูุฏ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ๐ ุดุญู ุงูุฑุตูุฏ                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  ุงูุฑุตูุฏ ุงูุญุงูู: 15,250 ุฑ.ุณ                                                 โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุงุฎุชุฑ ูุจูุบ ุงูุดุญู                                    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ                    โ
โ  โ 5,000    โ  โ 10,000   โ  โ 20,000   โ  โ 50,000   โ                    โ
โ  โ  ุฑ.ุณ    โ  โ  ุฑ.ุณ    โ  โ  ุฑ.ุณ    โ  โ  ุฑ.ุณ    โ                    โ
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ                    โ
โ                                                                             โ
โ  ุฃู ุฃุฏุฎู ูุจูุบ ูุฎุตุต: [____________] ุฑ.ุณ                                     โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โ ๐ณ ุจุทุงูุฉ ุจูููุฉ (Visa/Mastercard)                                        โ
โ  โ ๐ฆ ุชุญููู ุจููู                                                           โ
โ  โ ๐ฑ ูุญูุธุฉ ุฅููุชุฑูููุฉ                                                      โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ุงููุจูุบ: 10,000 ุฑ.ุณ                                                        โ
โ  ุฑุณูู ุงูุฎุฏูุฉ: 0 ุฑ.ุณ                                                        โ
โ  โโโโโโโโโโโโโโโโโ                                                         โ
โ  ุงูุฅุฌูุงูู: 10,000 ุฑ.ุณ                                                      โ
โ                                                                             โ
โ  [โ ุฅูุบุงุก]                                    [โ ูุชุงุจุนุฉ ููุฏูุน]            โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 15.4 ูุญุฏุฉ ูุฑุงูุจุฉ ุงูุงุณุชููุงู (IoT)

### 15.4.1 ุฌุฏูู ุชูุจููุงุช ุงูุนููู

```sql
CREATE TABLE customer_consumption_alerts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL REFERENCES customers(id),
    
    -- ููุน ุงูุชูุจูู
    alert_type ENUM(
        'low_balance',           -- ุงูุฎูุงุถ ุงูุฑุตูุฏ
        'daily_consumption',     -- ุชุฌุงูุฒ ุงูุงุณุชููุงู ุงููููู
        'monthly_consumption',   -- ุชุฌุงูุฒ ุงูุงุณุชููุงู ุงูุดูุฑู
        'unusual_consumption',   -- ุงุณุชููุงู ุบูุฑ ุนุงุฏู
        'power_outage',          -- ุงููุทุงุน ุงูููุฑุจุงุก
        'power_restored'         -- ุนูุฏุฉ ุงูููุฑุจุงุก
    ) NOT NULL,
    
    -- ุงูุญุฏูุฏ
    threshold_value DECIMAL(12, 2),
    threshold_unit VARCHAR(20),
    
    -- ุงูุญุงูุฉ
    is_active BOOLEAN DEFAULT TRUE,
    
    -- ูููุงุช ุงูุฅุดุนุงุฑ
    notify_push BOOLEAN DEFAULT TRUE,
    notify_sms BOOLEAN DEFAULT FALSE,
    notify_email BOOLEAN DEFAULT FALSE,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 15.4.2 ุดุงุดุฉ ูุฑุงูุจุฉ ุงูุงุณุชููุงู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ๐ ูุฑุงูุจุฉ ุงูุงุณุชููุงู                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                      ุงูุงุณุชููุงู ุงููุญุธู                               โ   โ
โ  โ                                                                     โ   โ
โ  โ                         โก 2.4 kW                                   โ   โ
โ  โ                                                                     โ   โ
โ  โ                    ุงูุฑุตูุฏ ุงููุชุจูู: 15,250 ุฑ.ุณ                       โ   โ
โ  โ                    ูููู ูู: ~12 ููู ุชูุฑูุจุงู                         โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุงุณุชููุงู ุงูููู                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  kWh                                                                โ   โ
โ  โ   3 โ      โโ                                                      โ   โ
โ  โ     โ   โโ โโ โโ                                    โโ            โ   โ
โ  โ   2 โโโ โโ โโ โโ โโ                              โโ โโ            โ   โ
โ  โ     โโโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ            โ   โ
โ  โ   1 โโโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ            โ   โ
โ  โ     โโโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ โโ            โ   โ
โ  โ   0 โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ   โ
โ  โ      6  7  8  9  10 11 12 13 14 15 16 17 18 19 20 21 ุงูุณุงุนุฉ      โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ุฅุฌูุงูู ุงูููู: 28.5 kWh    โ    ูุชูุณุท ุงูุดูุฑ: 25.2 kWh/ููู                 โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ููุงุฑูุฉ ุงูุงุณุชููุงู                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  [ูููู โผ]  [ุฃุณุจูุนู]  [ุดูุฑู]                                               โ
โ                                                                             โ
โ  ูุฐุง ุงูุดูุฑ: 756 kWh    โ    ุงูุดูุฑ ุงููุงุถู: 680 kWh    โ    +11.2%          โ
โ                                                                             โ
โ  [โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชูุจููุงุช]                                                    โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 15.4.3 ุดุงุดุฉ ุฅุนุฏุงุฏุงุช ุงูุชูุจููุงุช

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ๐ ุฅุนุฏุงุฏุงุช ุงูุชูุจููุงุช                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุชูุจููุงุช ุงูุฑุตูุฏ                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โ ุชูุจูู ุงูุฎูุงุถ ุงูุฑุตูุฏ                                                     โ
โ    ุนูุฏูุง ูุตู ุงูุฑุตูุฏ ุฅูู: [1,000    ] ุฑ.ุณ                                   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุชูุจููุงุช ุงูุงุณุชููุงู                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โ ุชูุจูู ุงูุงุณุชููุงู ุงููููู                                                  โ
โ    ุนูุฏูุง ูุชุฌุงูุฒ ุงูุงุณุชููุงู: [30       ] kWh/ููู                             โ
โ                                                                             โ
โ  โ ุชูุจูู ุงูุงุณุชููุงู ุบูุฑ ุงูุนุงุฏู                                              โ
โ    ุนูุฏูุง ูุชุฌุงูุฒ ุงูุงุณุชููุงู ุงููุชูุณุท ุจูุณุจุฉ: [50       ] %                      โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ูููุงุช ุงูุฅุดุนุงุฑ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โ ุฅุดุนุงุฑุงุช ุงูุชุทุจูู (Push)                                                  โ
โ  โ ุฑุณุงุฆู SMS                                                               โ
โ  โ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู                                                       โ
โ                                                                             โ
โ  [โ ุฅูุบุงุก]                                              [โ ุญูุธ]           โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 15.5 ูุญุฏุฉ ุงูุฏุนู ุงูููู ูุทูุจุงุช ุงูุฎุฏูุฉ

### 15.5.1 ุฌุฏูู ุทูุจุงุช ุงูุฏุนู

```sql
CREATE TABLE customer_support_requests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL REFERENCES customers(id),
    
    -- ุฑูู ุงูุทูุจ
    request_number VARCHAR(50) NOT NULL UNIQUE,
    
    -- ููุน ุงููุดููุฉ
    problem_type ENUM(
        'power_outage',        -- ุงููุทุงุน ููุฑุจุงุก
        'meter_not_working',   -- ุนุฏุงุฏ ูุง ูุนูู
        'billing_issue',       -- ูุดููุฉ ูู ุงููุงุชูุฑุฉ
        'recharge_failed',     -- ูุดู ุงูุดุญู
        'voltage_issue',       -- ูุดููุฉ ูู ุงูุฌูุฏ
        'other'                -- ุฃุฎุฑู
    ) NOT NULL,
    
    -- ุงูุชูุงุตูู
    description TEXT NOT NULL,
    attachments JSONB,
    
    -- ุงูุญุงูุฉ
    status ENUM(
        'submitted',           -- ุชู ุงูุชูุฏูู
        'received',            -- ุชู ุงูุงุณุชูุงู
        'assigned',            -- ุชู ุงูุฅุณูุงุฏ
        'in_progress',         -- ููุฏ ุงูุชูููุฐ
        'resolved',            -- ุชู ุงูุญู
        'closed',              -- ูุบูู
        'cancelled'            -- ููุบู
    ) DEFAULT 'submitted',
    
    -- ุงูุฑุจุท ุจุฃูุฑ ุงูุนูู
    work_order_id UUID REFERENCES work_orders(id),
    
    -- ุงูููู ุงููุณูุฏ
    assigned_technician_id UUID REFERENCES employees(id),
    assigned_at TIMESTAMP,
    
    -- ุงูุชูููู
    customer_rating INT CHECK (customer_rating BETWEEN 1 AND 5),
    customer_feedback TEXT,
    rated_at TIMESTAMP,
    
    -- ุงูุชูููุช
    submitted_at TIMESTAMP DEFAULT NOW(),
    resolved_at TIMESTAMP,
    closed_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ุฌุฏูู ุชุญุฏูุซุงุช ุญุงูุฉ ุงูุทูุจ
CREATE TABLE support_request_updates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    request_id UUID NOT NULL REFERENCES customer_support_requests(id),
    
    old_status VARCHAR(50),
    new_status VARCHAR(50) NOT NULL,
    
    update_message TEXT,
    updated_by UUID,
    is_customer_visible BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 15.5.2 ุดุงุดุฉ ุฅูุดุงุก ุทูุจ ุฏุนู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ๐๏ธ ุทูุจ ุฏุนู ููู ุฌุฏูุฏ                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ููุน ุงููุดููุฉ                                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โ โก ุงููุทุงุน ููุฑุจุงุก                                                        โ
โ  โ ๐ ุงูุนุฏุงุฏ ูุง ูุนูู                                                       โ
โ  โ ๐ฐ ูุดููุฉ ูู ุงููุงุชูุฑุฉ                                                    โ
โ  โ ๐ ูุดู ูู ุงูุดุญู                                                         โ
โ  โ โ๏ธ ูุดููุฉ ูู ุงูุฌูุฏ ุงูููุฑุจุงุฆู                                             โ
โ  โ โ ุฃุฎุฑู                                                                 โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ูุตู ุงููุดููุฉ                                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุงูุนุฏุงุฏ ุชููู ุนู ุงูุนูู ููุฐ ุตุจุงุญ ุงูููู. ุงูุดุงุดุฉ ูุง ุชุนุฑุถ ุฃู ูุฑุงุกุฉ      โ   โ
โ  โ ูุงูููุฑุจุงุก ูููุทุนุฉ ุนู ุงูููุฒู ุฑุบู ูุฌูุฏ ุฑุตูุฏ ูุงูู.                     โ   โ
โ  โ                                                                     โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุฅุฑูุงู ุตูุฑ (ุงุฎุชูุงุฑู)                               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  [๐ท ุฅุถุงูุฉ ุตูุฑุฉ]                                                           โ
โ                                                                             โ
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ                                                โ
โ  โ  ุตูุฑุฉ 1 โ  โ  ุตูุฑุฉ 2 โ                                                โ
โ  โ   [x]   โ  โ   [x]   โ                                                โ
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ                                                โ
โ                                                                             โ
โ  [โ ุฅูุบุงุก]                                        [โ ุฅุฑุณุงู ุงูุทูุจ]         โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 15.5.3 ุดุงุดุฉ ุชุชุจุน ุงูุทูุจ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ๐ ุชุชุจุน ุทูุจ ุงูุฏุนู                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  ุฑูู ุงูุทูุจ: SR-2024-00456                                                  โ
โ  ููุน ุงููุดููุฉ: ุงูุนุฏุงุฏ ูุง ูุนูู                                               โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุญุงูุฉ ุงูุทูุจ                                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โ ุชู ุงูุงุณุชูุงู โโโโโโโ โ ุชู ุงูุฅุณูุงุฏ โโโโโโโ ๐ ููุฏ ุงูุชูููุฐ โโโ โ ุชู ุงูุญู โ
โ     10:30 AM              11:15 AM              ุงูุขู                        โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุชูุงุตูู ุงูููู                                       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ุงูููู ุงููุณูุฏ: ุฃุญูุฏ ูุญูุฏ                                                   โ
โ  ุฑูู ุงููุงุชู: 0912345678                                                    โ
โ  ุงูุญุงูุฉ: ๐ ูู ุงูุทุฑูู ุฅููู                                                 โ
โ  ุงููุตูู ุงููุชููุน: ุฎูุงู 30 ุฏูููุฉ                                             โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ุณุฌู ุงูุชุญุฏูุซุงุช                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ๐ 12:00 PM โ ุงูููู ูู ุงูุทุฑูู ุฅูู ูููุนู                                   โ
โ  ๐ 11:15 AM โ ุชู ุฅุณูุงุฏ ุงูุทูุจ ููููู ุฃุญูุฏ ูุญูุฏ                              โ
โ  ๐ 10:35 AM โ ุชู ูุฑุงุฌุนุฉ ุงูุทูุจ ูุชุตูููู ูุฃููููุฉ ุนุงููุฉ                       โ
โ  ๐ 10:30 AM โ ุชู ุงุณุชูุงู ุทูุจู ุจูุฌุงุญ                                        โ
โ                                                                             โ
โ  [๐ ุงุชุตุงู ุจุงูููู]                              [โ ุฅูุบุงุก ุงูุทูุจ]            โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 15.5.4 ุดุงุดุฉ ุชูููู ุงูุฎุฏูุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         โญ ุชูููู ุงูุฎุฏูุฉ                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  ุฑูู ุงูุทูุจ: SR-2024-00456                                                  โ
โ  ุชู ุญู ุงููุดููุฉ ุจูุฌุงุญ โ                                                     โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ููู ูุงูุช ุชุฌุฑุจุชูุ                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ                    โญ โญ โญ โญ โ                                            โ
โ                       4 ูู 5                                               โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                          ููุงุญุธุงุชู (ุงุฎุชูุงุฑู)                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุงูููู ูุงู ูุญุชุฑูุงู ูุญู ุงููุดููุฉ ุจุณุฑุนุฉ. ุดูุฑุงู ููู.                    โ   โ
โ  โ                                                                     โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  [ุชุฎุทู]                                              [โ ุฅุฑุณุงู ุงูุชูููู]     โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 15.6 ูุญุฏุฉ ูุฑูุฒ ุงููุณุงุนุฏุฉ

### 15.6.1 ุฌุฏูู ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ

```sql
CREATE TABLE faq_articles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ุงูุชุตููู
    category VARCHAR(100) NOT NULL,
    
    -- ุงููุญุชูู
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    
    -- ุงูุชุฑุชูุจ
    display_order INT DEFAULT 0,
    
    -- ุงูุฅุญุตุงุฆูุงุช
    view_count INT DEFAULT 0,
    helpful_count INT DEFAULT 0,
    not_helpful_count INT DEFAULT 0,
    
    -- ุงูุญุงูุฉ
    is_published BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ุฌุฏูู ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช
CREATE TABLE customer_complaints (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID REFERENCES customers(id),
    
    -- ุงูููุน
    type ENUM('complaint', 'suggestion') NOT NULL,
    
    -- ุงููุญุชูู
    subject VARCHAR(200) NOT NULL,
    description TEXT NOT NULL,
    
    -- ุงูุญุงูุฉ
    status ENUM(
        'submitted',
        'under_review',
        'responded',
        'closed'
    ) DEFAULT 'submitted',
    
    -- ุงูุฑุฏ
    response TEXT,
    responded_by UUID REFERENCES employees(id),
    responded_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 15.6.2 ุฌุฏูู ุงูุฏุฑุฏุดุฉ ุงูุญูุฉ

```sql
CREATE TABLE live_chat_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL REFERENCES customers(id),
    
    -- ุงูุญุงูุฉ
    status ENUM(
        'waiting',      -- ูู ุงูุงูุชุธุงุฑ
        'active',       -- ูุดุทุฉ
        'closed'        -- ูุบููุฉ
    ) DEFAULT 'waiting',
    
    -- ุงูููุธู
    agent_id UUID REFERENCES employees(id),
    
    -- ุงููุดุงุฑููู ุงูุฅุถุงูููู (ูุดุฑูุ ููู)
    participants JSONB DEFAULT '[]',
    
    -- ุงูุชูููุช
    started_at TIMESTAMP DEFAULT NOW(),
    agent_joined_at TIMESTAMP,
    ended_at TIMESTAMP,
    
    -- ุงูุชูููู
    customer_rating INT CHECK (customer_rating BETWEEN 1 AND 5),
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE chat_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES live_chat_sessions(id),
    
    -- ุงููุฑุณู
    sender_type ENUM('customer', 'agent', 'system') NOT NULL,
    sender_id UUID,
    
    -- ุงููุญุชูู
    message_type ENUM('text', 'image', 'file', 'system') DEFAULT 'text',
    content TEXT NOT NULL,
    attachments JSONB,
    
    -- ุงููุฑุงุกุฉ
    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

## 15.7 ูุธุงู ุงูุฅุดุนุงุฑุงุช (Push Notifications)

### 15.7.1 ุฌุฏูู ุงูุฅุดุนุงุฑุงุช

```sql
CREATE TABLE customer_notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL REFERENCES customers(id),
    
    -- ููุน ุงูุฅุดุนุงุฑ
    notification_type ENUM(
        'new_bill',              -- ูุงุชูุฑุฉ ุฌุฏูุฏุฉ
        'payment_received',      -- ุชู ุงุณุชูุงู ุงูุฏูุนุฉ
        'low_balance',           -- ุงูุฎูุงุถ ุงูุฑุตูุฏ
        'recharge_success',      -- ูุฌุงุญ ุงูุดุญู
        'support_update',        -- ุชุญุฏูุซ ุทูุจ ุงูุฏุนู
        'maintenance_scheduled', -- ุตูุงูุฉ ูุฌุฏููุฉ
        'power_outage',          -- ุงููุทุงุน ููุฑุจุงุก
        'power_restored',        -- ุนูุฏุฉ ุงูููุฑุจุงุก
        'general'                -- ุฅุดุนุงุฑ ุนุงู
    ) NOT NULL,
    
    -- ุงููุญุชูู
    title VARCHAR(200) NOT NULL,
    body TEXT NOT NULL,
    
    -- ุงูุจูุงูุงุช ุงูุฅุถุงููุฉ
    data JSONB,
    
    -- ุงูุญุงูุฉ
    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMP,
    
    -- ุงูุฅุฑุณุงู
    sent_via JSONB DEFAULT '{"push": false, "sms": false, "email": false}',
    sent_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW()
);

-- Trigger ูุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช
CREATE OR REPLACE FUNCTION send_customer_notification()
RETURNS TRIGGER AS $$
BEGIN
    -- ุฅุฑุณุงู Push Notification
    IF (SELECT notification_preferences->>'push' FROM customer_portal_users WHERE customer_id = NEW.customer_id)::BOOLEAN THEN
        -- ุงุณุชุฏุนุงุก ุฎุฏูุฉ Push Notification
        PERFORM pg_notify('push_notification', json_build_object(
            'customer_id', NEW.customer_id,
            'title', NEW.title,
            'body', NEW.body,
            'data', NEW.data
        )::TEXT);
        
        NEW.sent_via = jsonb_set(NEW.sent_via, '{push}', 'true');
    END IF;
    
    NEW.sent_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_send_notification
BEFORE INSERT ON customer_notifications
FOR EACH ROW EXECUTE FUNCTION send_customer_notification();
```

## 15.8 APIs ุจูุงุจุฉ ุงูุนููุงุก

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | `/api/v1/portal/auth/login` | ุชุณุฌูู ุงูุฏุฎูู |
| POST | `/api/v1/portal/auth/verify-otp` | ุงูุชุญูู ูู OTP |
| GET | `/api/v1/portal/account` | ุจูุงูุงุช ุงูุญุณุงุจ |
| GET | `/api/v1/portal/bills` | ูุงุฆูุฉ ุงูููุงุชูุฑ |
| POST | `/api/v1/portal/payments` | ุฅูุดุงุก ูุนุงููุฉ ุฏูุน |
| POST | `/api/v1/portal/recharge` | ุดุญู ุงูุฑุตูุฏ |
| GET | `/api/v1/portal/consumption/realtime` | ุงูุงุณุชููุงู ุงููุญุธู |
| GET | `/api/v1/portal/consumption/history` | ุณุฌู ุงูุงุณุชููุงู |
| GET | `/api/v1/portal/alerts` | ุชูุจููุงุช ุงูุนููู |
| PUT | `/api/v1/portal/alerts/:id` | ุชุญุฏูุซ ุชูุจูู |
| POST | `/api/v1/portal/support-requests` | ุฅูุดุงุก ุทูุจ ุฏุนู |
| GET | `/api/v1/portal/support-requests/:id` | ุชูุงุตูู ุงูุทูุจ |
| POST | `/api/v1/portal/support-requests/:id/rate` | ุชูููู ุงูุฎุฏูุฉ |
| GET | `/api/v1/portal/faq` | ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ |
| POST | `/api/v1/portal/complaints` | ุชูุฏูู ุดููู/ุงูุชุฑุงุญ |
| POST | `/api/v1/portal/chat/start` | ุจุฏุก ูุญุงุฏุซุฉ |
| GET | `/api/v1/portal/notifications` | ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช |



---

## ๐ ููู 39: ุฏูุฑุฉ ุงูุฅูุฑุงุฏุงุช ุงููุชูุงููุฉ (Revenue Cycle)

---

### 16. ูุธุงู ููุงุท ุงูุจูุน (POS - Point of Sale)

#### 16.1 ุงููุฏู
ุชุญููู ุนูููุฉ ุงูุชุญุตูู ุงูููุฏู ูู ุนูููุฉ ูุฏููุฉ ูุนุฑุถุฉ ููุฃุฎุทุงุก ุฅูู ูุธุงู ุฅููุชุฑููู ุขูู ูููุซู.

#### 16.2 ุฌุฏูู ููุงุท ุงูุจูุน: `pos_terminals`

```sql
CREATE TABLE pos_terminals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    terminal_code VARCHAR(20) UNIQUE NOT NULL,
    terminal_name VARCHAR(100) NOT NULL,
    location_id UUID,
    location_name VARCHAR(100),
    
    -- ุงูุญุงูุฉ
    status ENUM('active', 'inactive', 'maintenance') DEFAULT 'active',
    
    -- ุงููุณุชุฎุฏู ุงููุณุคูู
    assigned_user_id UUID REFERENCES users(id),
    
    -- ุฅุนุฏุงุฏุงุช ุงูุทุงุจุนุฉ
    printer_type ENUM('thermal', 'laser', 'none') DEFAULT 'thermal',
    printer_ip VARCHAR(50),
    
    -- ุงูุตูุฏูู
    opening_balance DECIMAL(15,2) DEFAULT 0,
    current_balance DECIMAL(15,2) DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 16.3 ุฌุฏูู ุฌูุณุงุช ููุงุท ุงูุจูุน: `pos_sessions`

```sql
CREATE TABLE pos_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    terminal_id UUID NOT NULL REFERENCES pos_terminals(id),
    session_number VARCHAR(30) UNIQUE NOT NULL,
    
    -- ุงููุณุชุฎุฏู
    cashier_id UUID NOT NULL REFERENCES users(id),
    
    -- ุงูุชูููุช
    opened_at TIMESTAMP DEFAULT NOW(),
    closed_at TIMESTAMP,
    
    -- ุงูุฃุฑุตุฏุฉ
    opening_cash DECIMAL(15,2) NOT NULL DEFAULT 0,
    closing_cash DECIMAL(15,2),
    expected_cash DECIMAL(15,2),
    cash_difference DECIMAL(15,2),
    
    -- ููุฎุต ุงููุนุงููุงุช
    total_cash_received DECIMAL(15,2) DEFAULT 0,
    total_transactions INT DEFAULT 0,
    
    -- ุงูุญุงูุฉ
    status ENUM('open', 'closed', 'reconciled') DEFAULT 'open',
    
    -- ููุงุญุธุงุช
    opening_notes TEXT,
    closing_notes TEXT
);
```

#### 16.4 ุฌุฏูู ูุนุงููุงุช ููุงุท ุงูุจูุน: `pos_transactions`

```sql
CREATE TABLE pos_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES pos_sessions(id),
    transaction_number VARCHAR(30) UNIQUE NOT NULL,
    
    -- ุงูุนููู ูุงููุงุชูุฑุฉ
    customer_id UUID NOT NULL REFERENCES customers(id),
    invoice_id UUID REFERENCES invoices(id),
    
    -- ููุน ุงููุนุงููุฉ
    transaction_type ENUM(
        'invoice_payment',    -- ุณุฏุงุฏ ูุงุชูุฑุฉ
        'advance_payment',    -- ุฏูุนุฉ ููุฏูุฉ
        'deposit',            -- ุฅูุฏุงุน
        'refund',             -- ุงุณุชุฑุฏุงุฏ
        'adjustment'          -- ุชุณููุฉ
    ) NOT NULL,
    
    -- ุงููุจูุบ
    amount DECIMAL(15,2) NOT NULL,
    
    -- ุทุฑููุฉ ุงูุฏูุน
    payment_method ENUM('cash', 'card', 'check', 'mixed') DEFAULT 'cash',
    cash_amount DECIMAL(15,2) DEFAULT 0,
    card_amount DECIMAL(15,2) DEFAULT 0,
    check_amount DECIMAL(15,2) DEFAULT 0,
    
    -- ุชูุงุตูู ุงูุจุทุงูุฉ (ุฅู ูุฌุฏุช)
    card_last_four VARCHAR(4),
    card_approval_code VARCHAR(20),
    
    -- ุชูุงุตูู ุงูุดูู (ุฅู ูุฌุฏ)
    check_number VARCHAR(50),
    check_bank VARCHAR(100),
    check_date DATE,
    
    -- ุงูุจุงูู
    amount_tendered DECIMAL(15,2), -- ุงููุจูุบ ุงููุฏููุน
    change_given DECIMAL(15,2), -- ุงูุจุงูู
    
    -- ุณูุฏ ุงููุจุถ
    receipt_number VARCHAR(30),
    receipt_printed BOOLEAN DEFAULT FALSE,
    
    -- ุงูููุฏ ุงููุญุงุณุจู
    journal_entry_id UUID,
    
    -- ุงูุชูููุช
    transaction_time TIMESTAMP DEFAULT NOW(),
    
    -- ุงูุญุงูุฉ
    status ENUM('completed', 'voided', 'pending') DEFAULT 'completed',
    void_reason TEXT,
    voided_by UUID REFERENCES users(id),
    voided_at TIMESTAMP
);
```

#### 16.5 Trigger: ุฅูุดุงุก ููุฏ ูุญุงุณุจู ุนูุฏ ุงูุฏูุน ุงูููุฏู

```sql
CREATE OR REPLACE FUNCTION pos_create_journal_entry()
RETURNS TRIGGER AS $$
DECLARE
    v_journal_id UUID;
    v_customer_name VARCHAR(255);
BEGIN
    IF NEW.status = 'completed' AND NEW.transaction_type IN ('invoice_payment', 'advance_payment', 'deposit') THEN
        -- ุฌูุจ ุงุณู ุงูุนููู
        SELECT name INTO v_customer_name FROM customers WHERE id = NEW.customer_id;
        
        -- ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู
        INSERT INTO journal_entries (
            entry_date,
            description,
            source_system,
            source_document_type,
            source_document_id,
            created_by
        ) VALUES (
            CURRENT_DATE,
            'ุณุฏุงุฏ ููุฏู ูู ุงูุนููู: ' || v_customer_name || ' - ุณูุฏ ูุจุถ ุฑูู: ' || NEW.receipt_number,
            'pos',
            'pos_transaction',
            NEW.id,
            (SELECT cashier_id FROM pos_sessions WHERE id = NEW.session_id)
        )
        RETURNING id INTO v_journal_id;
        
        -- ุงูููุฏ: ูู ุญ/ ุงูุตูุฏูู (ููููุฏ)
        IF NEW.cash_amount > 0 THEN
            INSERT INTO journal_entry_lines (journal_entry_id, account_id, debit, credit, description)
            SELECT v_journal_id, id, NEW.cash_amount, 0, 'ุณุฏุงุฏ ููุฏู'
            FROM accounts WHERE account_code = '1101';
        END IF;
        
        -- ุงูููุฏ: ูู ุญ/ ุงูุจูู (ููุจุทุงูุงุช)
        IF NEW.card_amount > 0 THEN
            INSERT INTO journal_entry_lines (journal_entry_id, account_id, debit, credit, description)
            SELECT v_journal_id, id, NEW.card_amount, 0, 'ุณุฏุงุฏ ุจุจุทุงูุฉ'
            FROM accounts WHERE account_code = '1102';
        END IF;
        
        -- ุงูููุฏ: ุฅูู ุญ/ ุงูุนููุงุก
        INSERT INTO journal_entry_lines (journal_entry_id, account_id, debit, credit, description)
        SELECT v_journal_id, id, 0, NEW.amount, 'ุณุฏุงุฏ ุงูุนููู: ' || v_customer_name
        FROM accounts WHERE account_code = '1201';
        
        -- ุชุญุฏูุซ ุฑูู ุงูููุฏ ูู ุงููุนุงููุฉ
        NEW.journal_entry_id := v_journal_id;
        
        -- ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู
        UPDATE customers 
        SET current_balance = current_balance - NEW.amount,
            last_payment_date = CURRENT_DATE
        WHERE id = NEW.customer_id;
        
        -- ุชุญุฏูุซ ุญุงูุฉ ุงููุงุชูุฑุฉ ุฅุฐุง ุชู ุงูุณุฏุงุฏ ุงููุงูู
        IF NEW.invoice_id IS NOT NULL THEN
            UPDATE invoices 
            SET paid_amount = paid_amount + NEW.amount,
                status = CASE 
                    WHEN paid_amount + NEW.amount >= total_amount THEN 'paid'
                    WHEN paid_amount + NEW.amount > 0 THEN 'partial'
                    ELSE status
                END,
                payment_date = CASE 
                    WHEN paid_amount + NEW.amount >= total_amount THEN CURRENT_DATE
                    ELSE payment_date
                END
            WHERE id = NEW.invoice_id;
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_pos_create_journal_entry
BEFORE INSERT ON pos_transactions
FOR EACH ROW EXECUTE FUNCTION pos_create_journal_entry();
```

#### 16.6 ุดุงุดุฉ ููุทุฉ ุงูุจูุน ุงูุฑุฆูุณูุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ููุทุฉ ุงูุจูุน - ุงูููุชุจ ุงูุฑุฆูุณู                             โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ ุงูููุธู: ุฃุญูุฏ ูุญูุฏ | ุงูุฌูุณุฉ: POS-2025-001 | ููุชูุญุฉ     โ
โ                                                          โ
โ โโโโโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุจุญุซ ุนู ุงูุนููู:     โ โ ูุนูููุงุช ุงูุนููู:           โ  โ
โ โ [๐ ุฑูู ุงูุนุฏุงุฏ/ุงูุงุณู]โ โ ุงูุงุณู: ูุญูุฏ ุนูู ุฃุญูุฏ     โ  โ
โ โ                     โ โ ุฑูู ุงูุนุฏุงุฏ: 12345         โ  โ
โ โ ุฃู                  โ โ ุงูุฑุตูุฏ ุงููุณุชุญู: 5,500 ุฑ.ุณ โ  โ
โ โ [๐ท ูุณุญ ุงูุจุงุฑููุฏ]  โ โ ุขุฎุฑ ุฏูุนุฉ: 2025-11-15     โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุงูููุงุชูุฑ ุงููุณุชุญูุฉ:                                      โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ โ | ุฑูู ุงููุงุชูุฑุฉ | ุงูุชุงุฑูุฎ | ุงููุจูุบ | ุงููุชุจูู   โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ โ โ | INV-2025-100 | 10/12 | 2,000 | 2,000        โ  โ
โ โ โ | INV-2025-090 | 01/12 | 1,800 | 1,800        โ  โ
โ โ โ | INV-2025-080 | 20/11 | 1,700 | 1,700        โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุงููุจูุบ ุงููุญุฏุฏ ููุณุฏุงุฏ: [3,800] ุฑ.ุณ                      โ
โ                                                          โ
โ ุทุฑููุฉ ุงูุฏูุน:                                            โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ โ ููุฏุงู  โ ุจุทุงูุฉ  โ ุดูู  โ ูุฎุชูุท                โ  โ
โ โ                                                    โ  โ
โ โ ุงููุจูุบ ุงููุณุชูู: [4,000] ุฑ.ุณ                      โ  โ
โ โ ุงูุจุงูู: 200 ุฑ.ุณ                                  โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ [๐ฐ ุชูููุฐ ุงูุฏูุน] [๐งพ ุทุจุงุนุฉ ูุดู ุญุณุงุจ] [โ ุฅูุบุงุก]       โ
โ                                                          โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ ุฅุฌูุงูู ุงูุชุญุตูู ุงูููู: 45,000 ุฑ.ุณ | ุงููุนุงููุงุช: 23      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### 16.7 ุดุงุดุฉ ุฅุบูุงู ุงูุฌูุณุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุฅุบูุงู ุฌูุณุฉ ููุทุฉ ุงูุจูุน                                   โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                          โ
โ ููุฎุต ุงูุฌูุณุฉ:                                            โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุฑูู ุงูุฌูุณุฉ: POS-2025-001                         โ  โ
โ โ ููุช ุงููุชุญ: 08:00 ุตุจุงุญุงู                          โ  โ
โ โ ููุช ุงูุฅุบูุงู: 04:00 ูุณุงุกู                         โ  โ
โ โ                                                    โ  โ
โ โ ุงูุฑุตูุฏ ุงูุงูุชุชุงุญู: 500 ุฑ.ุณ                        โ  โ
โ โ ุฅุฌูุงูู ุงูุชุญุตูู ุงูููุฏู: 45,000 ุฑ.ุณ                โ  โ
โ โ ุฅุฌูุงูู ุงูุชุญุตูู ุจุงูุจุทุงูุงุช: 12,000 ุฑ.ุณ             โ  โ
โ โ ุนุฏุฏ ุงููุนุงููุงุช: 35                                โ  โ
โ โ                                                    โ  โ
โ โ ุงูุฑุตูุฏ ุงููุชููุน ูู ุงูุตูุฏูู: 45,500 ุฑ.ุณ            โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุงูุนุฏ ุงููุนูู ููุตูุฏูู:                                    โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ 500 ุฑ.ุณ  ร [  ] = [    ] ุฑ.ุณ                    โ  โ
โ โ 200 ุฑ.ุณ  ร [  ] = [    ] ุฑ.ุณ                    โ  โ
โ โ 100 ุฑ.ุณ  ร [  ] = [    ] ุฑ.ุณ                    โ  โ
โ โ 50 ุฑ.ุณ   ร [  ] = [    ] ุฑ.ุณ                    โ  โ
โ โ 20 ุฑ.ุณ   ร [  ] = [    ] ุฑ.ุณ                    โ  โ
โ โ 10 ุฑ.ุณ   ร [  ] = [    ] ุฑ.ุณ                    โ  โ
โ โ 5 ุฑ.ุณ    ร [  ] = [    ] ุฑ.ุณ                    โ  โ
โ โ 1 ุฑ.ุณ    ร [  ] = [    ] ุฑ.ุณ                    โ  โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุงูุฅุฌูุงูู ุงููุนูู: [45,480] ุฑ.ุณ                   โ  โ
โ โ ุงููุฑู: -20 ุฑ.ุณ (ุนุฌุฒ)                            โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ููุงุญุธุงุช: [                                    ]        โ
โ                                                          โ
โ [โ ุฅุบูุงู ุงูุฌูุณุฉ] [ุฅูุบุงุก]                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### 16.8 APIs ููุงุท ุงูุจูุน

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | `/api/v1/pos/sessions/open` | ูุชุญ ุฌูุณุฉ ุฌุฏูุฏุฉ |
| POST | `/api/v1/pos/sessions/{id}/close` | ุฅุบูุงู ุงูุฌูุณุฉ |
| GET | `/api/v1/pos/sessions/current` | ุงูุฌูุณุฉ ุงูุญุงููุฉ |
| POST | `/api/v1/pos/transactions` | ุชุณุฌูู ูุนุงููุฉ ุฏูุน |
| POST | `/api/v1/pos/transactions/{id}/void` | ุฅูุบุงุก ูุนุงููุฉ |
| GET | `/api/v1/pos/transactions/{id}/receipt` | ุทุจุงุนุฉ ุณูุฏ ุงููุจุถ |
| GET | `/api/v1/pos/customers/search` | ุจุญุซ ุนู ุนููู |
| GET | `/api/v1/pos/customers/{id}/invoices` | ููุงุชูุฑ ุงูุนููู ุงููุณุชุญูุฉ |
| GET | `/api/v1/pos/reports/daily` | ุชูุฑูุฑ ูููู |
| GET | `/api/v1/pos/reports/session/{id}` | ุชูุฑูุฑ ุงูุฌูุณุฉ |

---

### 17. ุจูุงุจุฉ ุงูุฏูุน ุงูุฅููุชุฑููู ุงูููุญุฏุฉ (Unified Payment Gateway)

#### 17.1 ุงููุฏู
ุชูุญูุฏ ุฌููุน ูููุงุช ุงูุฏูุน ุงูุฅููุชุฑููู ูู ุจูุงุจุฉ ูุงุญุฏุฉ ูุน ูุทุงุจูุฉ ุชููุงุฆูุฉ.

#### 17.2 ุฌุฏูู ุจูุงุจุงุช ุงูุฏูุน: `payment_gateways`

```sql
CREATE TABLE payment_gateways (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    gateway_code VARCHAR(20) UNIQUE NOT NULL,
    gateway_name VARCHAR(100) NOT NULL,
    gateway_type ENUM(
        'bank_transfer',      -- ุชุญููู ุจููู
        'mada',               -- ูุฏู
        'visa_master',        -- ููุฒุง/ูุงุณุชุฑูุงุฑุฏ
        'apple_pay',          -- Apple Pay
        'stc_pay',            -- STC Pay
        'sadad'               -- ุณุฏุงุฏ
    ) NOT NULL,
    
    -- ุฅุนุฏุงุฏุงุช ุงูุงุชุตุงู
    api_url VARCHAR(500),
    merchant_id VARCHAR(100),
    api_key_encrypted VARCHAR(500),
    api_secret_encrypted VARCHAR(500),
    
    -- ุงูุญุณุงุจ ุงูุจููู ุงููุฑุชุจุท
    bank_account_id UUID,
    
    -- ุงูุฑุณูู
    fee_type ENUM('percentage', 'fixed', 'mixed') DEFAULT 'percentage',
    fee_percentage DECIMAL(5,2) DEFAULT 0,
    fee_fixed DECIMAL(10,2) DEFAULT 0,
    
    -- ุงูุญุงูุฉ
    is_active BOOLEAN DEFAULT TRUE,
    is_test_mode BOOLEAN DEFAULT FALSE,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 17.3 ุฌุฏูู ูุนุงููุงุช ุงูุฏูุน ุงูุฅููุชุฑููู: `online_payments`

```sql
CREATE TABLE online_payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    payment_reference VARCHAR(50) UNIQUE NOT NULL,
    
    -- ุงูุจูุงุจุฉ
    gateway_id UUID NOT NULL REFERENCES payment_gateways(id),
    gateway_transaction_id VARCHAR(100),
    
    -- ุงูุนููู ูุงููุงุชูุฑุฉ
    customer_id UUID NOT NULL REFERENCES customers(id),
    invoice_id UUID REFERENCES invoices(id),
    
    -- ุงููุจูุบ
    amount DECIMAL(15,2) NOT NULL,
    gateway_fee DECIMAL(10,2) DEFAULT 0,
    net_amount DECIMAL(15,2) GENERATED ALWAYS AS (amount - gateway_fee) STORED,
    currency VARCHAR(3) DEFAULT 'YER',
    
    -- ุญุงูุฉ ุงูุฏูุน
    status ENUM(
        'initiated',      -- ุจุฏุฃุช
        'pending',        -- ูู ุงูุงูุชุธุงุฑ
        'processing',     -- ููุฏ ุงููุนุงูุฌุฉ
        'completed',      -- ููุชููุฉ
        'failed',         -- ูุดูุช
        'cancelled',      -- ููุบุงุฉ
        'refunded',       -- ูุณุชุฑุฏุฉ
        'partially_refunded' -- ูุณุชุฑุฏุฉ ุฌุฒุฆูุงู
    ) DEFAULT 'initiated',
    
    -- ุชูุงุตูู ุงูุฏูุน
    payment_method VARCHAR(50),
    card_brand VARCHAR(20),
    card_last_four VARCHAR(4),
    
    -- ุงููุทุงุจูุฉ
    is_matched BOOLEAN DEFAULT FALSE,
    matched_at TIMESTAMP,
    matched_by ENUM('auto', 'manual'),
    
    -- ุงูููุฏ ุงููุญุงุณุจู
    journal_entry_id UUID,
    
    -- ุงูุชูููุช
    initiated_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    
    -- ุฑุณุงุฆู ุงูุฎุทุฃ
    error_code VARCHAR(50),
    error_message TEXT,
    
    -- ุงูุจูุงูุงุช ุงูุฎุงู ูู ุงูุจูุงุจุฉ
    gateway_response JSONB
);
```

#### 17.4 ุฌุฏูู ุฅุดุนุงุฑุงุช ุงูุจูุงุจุฉ (Webhooks): `payment_webhooks`

```sql
CREATE TABLE payment_webhooks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    gateway_id UUID NOT NULL REFERENCES payment_gateways(id),
    webhook_type VARCHAR(50) NOT NULL,
    payload JSONB NOT NULL,
    
    -- ุงููุนุงูุฌุฉ
    is_processed BOOLEAN DEFAULT FALSE,
    processed_at TIMESTAMP,
    processing_result TEXT,
    
    -- ุงูุฑุจุท
    online_payment_id UUID REFERENCES online_payments(id),
    
    received_at TIMESTAMP DEFAULT NOW()
);
```

#### 17.5 Function: ุงููุทุงุจูุฉ ุงูุชููุงุฆูุฉ ููุฏูุนุงุช

```sql
CREATE OR REPLACE FUNCTION auto_match_payment(p_payment_id UUID)
RETURNS VARCHAR(50) AS $$
DECLARE
    v_customer_id UUID;
    v_amount DECIMAL(15,2);
    v_invoice_id UUID;
    v_result VARCHAR(50);
BEGIN
    -- ุฌูุจ ุจูุงูุงุช ุงูุฏูุนุฉ
    SELECT customer_id, amount INTO v_customer_id, v_amount
    FROM online_payments WHERE id = p_payment_id;
    
    -- ุงูุจุญุซ ุนู ูุงุชูุฑุฉ ูุทุงุจูุฉ (ููุณ ุงููุจูุบ ุจุงูุถุจุท)
    SELECT id INTO v_invoice_id
    FROM invoices
    WHERE customer_id = v_customer_id
      AND (total_amount - COALESCE(paid_amount, 0)) = v_amount
      AND status IN ('pending', 'partial', 'overdue')
    ORDER BY due_date ASC
    LIMIT 1;
    
    IF v_invoice_id IS NOT NULL THEN
        -- ุชุญุฏูุซ ุงูุฏูุนุฉ
        UPDATE online_payments 
        SET invoice_id = v_invoice_id,
            is_matched = TRUE,
            matched_at = NOW(),
            matched_by = 'auto'
        WHERE id = p_payment_id;
        
        v_result := 'matched';
    ELSE
        -- ูุญุงููุฉ ุงููุทุงุจูุฉ ุงูุฌุฒุฆูุฉ (ุฃูุฏู ูุงุชูุฑุฉ)
        SELECT id INTO v_invoice_id
        FROM invoices
        WHERE customer_id = v_customer_id
          AND status IN ('pending', 'partial', 'overdue')
        ORDER BY due_date ASC
        LIMIT 1;
        
        IF v_invoice_id IS NOT NULL THEN
            UPDATE online_payments 
            SET invoice_id = v_invoice_id,
                is_matched = TRUE,
                matched_at = NOW(),
                matched_by = 'auto'
            WHERE id = p_payment_id;
            
            v_result := 'partial_match';
        ELSE
            v_result := 'no_match';
        END IF;
    END IF;
    
    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
```

#### 17.6 Trigger: ูุนุงูุฌุฉ ุงูุฏูุน ุงูููุชูู

```sql
CREATE OR REPLACE FUNCTION process_completed_online_payment()
RETURNS TRIGGER AS $$
DECLARE
    v_journal_id UUID;
    v_customer_name VARCHAR(255);
    v_gateway_name VARCHAR(100);
BEGIN
    IF NEW.status = 'completed' AND OLD.status != 'completed' THEN
        -- ูุญุงููุฉ ุงููุทุงุจูุฉ ุงูุชููุงุฆูุฉ
        IF NEW.is_matched = FALSE THEN
            PERFORM auto_match_payment(NEW.id);
        END IF;
        
        -- ุฌูุจ ุงูุจูุงูุงุช
        SELECT name INTO v_customer_name FROM customers WHERE id = NEW.customer_id;
        SELECT gateway_name INTO v_gateway_name FROM payment_gateways WHERE id = NEW.gateway_id;
        
        -- ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู
        INSERT INTO journal_entries (
            entry_date,
            description,
            source_system,
            source_document_type,
            source_document_id
        ) VALUES (
            CURRENT_DATE,
            'ุฏูุน ุฅููุชุฑููู ูู ุงูุนููู: ' || v_customer_name || ' ุนุจุฑ ' || v_gateway_name,
            'payment_gateway',
            'online_payment',
            NEW.id
        )
        RETURNING id INTO v_journal_id;
        
        -- ุงูููุฏ: ูู ุญ/ ุงูุจูู (ุตุงูู ุงููุจูุบ)
        INSERT INTO journal_entry_lines (journal_entry_id, account_id, debit, credit, description)
        SELECT v_journal_id, id, NEW.net_amount, 0, 'ุฏูุน ุฅููุชุฑููู'
        FROM accounts WHERE account_code = '1102';
        
        -- ุงูููุฏ: ูู ุญ/ ุนูููุงุช ุงูุจูุงุจุฉ (ุฅู ูุฌุฏุช)
        IF NEW.gateway_fee > 0 THEN
            INSERT INTO journal_entry_lines (journal_entry_id, account_id, debit, credit, description)
            SELECT v_journal_id, id, NEW.gateway_fee, 0, 'ุนูููุฉ ุจูุงุจุฉ ุงูุฏูุน'
            FROM accounts WHERE account_code = '5301';
        END IF;
        
        -- ุงูููุฏ: ุฅูู ุญ/ ุงูุนููุงุก
        INSERT INTO journal_entry_lines (journal_entry_id, account_id, debit, credit, description)
        SELECT v_journal_id, id, 0, NEW.amount, 'ุณุฏุงุฏ ุงูุนููู: ' || v_customer_name
        FROM accounts WHERE account_code = '1201';
        
        -- ุชุญุฏูุซ ุงูููุฏ ูู ุงูุฏูุนุฉ
        UPDATE online_payments SET journal_entry_id = v_journal_id WHERE id = NEW.id;
        
        -- ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู
        UPDATE customers 
        SET current_balance = current_balance - NEW.amount,
            last_payment_date = CURRENT_DATE
        WHERE id = NEW.customer_id;
        
        -- ุชุญุฏูุซ ุงููุงุชูุฑุฉ ุฅุฐุง ุชู ุงูุฑุจุท
        IF NEW.invoice_id IS NOT NULL THEN
            UPDATE invoices 
            SET paid_amount = paid_amount + NEW.amount,
                status = CASE 
                    WHEN paid_amount + NEW.amount >= total_amount THEN 'paid'
                    WHEN paid_amount + NEW.amount > 0 THEN 'partial'
                    ELSE status
                END
            WHERE id = NEW.invoice_id;
        END IF;
        
        -- ุฅุฑุณุงู ุฅุดุนุงุฑ ููุนููู
        INSERT INTO customer_notifications (
            customer_id,
            notification_type,
            title,
            body,
            data
        ) VALUES (
            NEW.customer_id,
            'payment_received',
            'ุชู ุงุณุชูุงู ุงูุฏูุนุฉ ุจูุฌุงุญ',
            'ุชู ุงุณุชูุงู ุฏูุนุชู ุจูุจูุบ ' || NEW.amount || ' ุฑูุงู. ุดูุฑุงู ูู.',
            jsonb_build_object('payment_id', NEW.id, 'amount', NEW.amount)
        );
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_process_online_payment
AFTER UPDATE ON online_payments
FOR EACH ROW EXECUTE FUNCTION process_completed_online_payment();
```

#### 17.7 ุดุงุดุฉ ุจูุงุจุฉ ุงูุฏูุน ููุนููู (ุชุทุจูู/ููุจ)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุณุฏุงุฏ ุงูููุงุชูุฑ                                           โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                          โ
โ ูุฑุญุจุงู ูุญูุฏ ุนูู                                         โ
โ                                                          โ
โ ุงูููุงุชูุฑ ุงููุณุชุญูุฉ:                                      โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ โ ูุงุชูุฑุฉ ุฏูุณูุจุฑ 2025                             โ  โ
โ โ   ุงููุจูุบ: 2,000 ุฑ.ู | ูุณุชุญูุฉ: 15 ููุงูุฑ          โ  โ
โ โ                                                    โ  โ
โ โ โ ูุงุชูุฑุฉ ููููุจุฑ 2025                             โ  โ
โ โ   ุงููุจูุบ: 1,800 ุฑ.ู | ูุชุฃุฎุฑุฉ: 5 ุฃูุงู            โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุฅุฌูุงูู ุงููุจูุบ: 3,800 ุฑ.ู                               โ
โ                                                          โ
โ ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน:                                       โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ โโโโโโโโ โโโโโโโโ โโโโโโโโ โโโโโโโโ โโโโโโโโ   โ  โ
โ โ โ ูุงุด โ โ ูููุณูโ โ ุฌูุงููโ โ ูุฑูููโ โ ุชุญูููโ   โ  โ
โ โ โ      โ โ      โ โ      โ โ      โ โ ุจููู โ   โ  โ
โ โ โโโโโโโโ โโโโโโโโ โโโโโโโโ โโโโโโโโ โโโโโโโโ   โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ [๐ณ ุงุฏูุน ุงูุขู 3,800 ุฑ.ู]                               โ
โ                                                          โ
โ ๐ ุงูุฏูุน ุขูู ููุดูุฑ                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### 17.8 ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูุฏูุนุงุช ุงูุฅููุชุฑูููุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุฅุฏุงุฑุฉ ุงูุฏูุนุงุช ุงูุฅููุชุฑูููุฉ                               โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                          โ
โ [ุงูููู] [ูุฐุง ุงูุฃุณุจูุน] [ูุฐุง ุงูุดูุฑ] [ุชุฎุตูุต]             โ
โ                                                          โ
โ ููุฎุต:                                                   โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุฅุฌูุงูู ุงูุฏูุนุงุช: 125,000 ุฑ.ู                      โ  โ
โ โ ุนุฏุฏ ุงููุนุงููุงุช: 85                                โ  โ
โ โ ุงููุทุงุจูุฉ ุชููุงุฆูุงู: 78 (92%)                      โ  โ
โ โ ุชุญุชุงุฌ ูุทุงุจูุฉ ูุฏููุฉ: 7 (8%)                       โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุงูุฏูุนุงุช ุบูุฑ ุงููุทุงุจูุฉ:                                   โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ # | ุงููุฑุฌุน | ุงูุนููู | ุงููุจูุบ | ุงูุจูุงุจุฉ | ุงูุฅุฌุฑุงุก โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ โ 1 | PAY-001 | ุบูุฑ ูุนุฑูู | 500 | ูุงุด | [ูุทุงุจูุฉ] โ  โ
โ โ 2 | PAY-002 | ุฃุญูุฏ ุนูู | 1,200 | ูููุณู | [ูุทุงุจูุฉ]โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุขุฎุฑ ุงููุนุงููุงุช:                                          โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุงูููุช | ุงูุนููู | ุงููุจูุบ | ุงูุจูุงุจุฉ | ุงูุญุงูุฉ       โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ โ 14:30 | ูุญูุฏ ุนูู | 3,800 | ูุงุด | โ ููุชูู       โ  โ
โ โ 14:15 | ูุงุทูุฉ ุฃุญูุฏ | 2,500 | ูููุณู | โ ููุชูู    โ  โ
โ โ 14:00 | ุนูู ูุญูุฏ | 1,000 | ุฌูุงูู | โณ ูุนุงูุฌุฉ     โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### 17.9 APIs ุจูุงุจุฉ ุงูุฏูุน

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | `/api/v1/payments/initiate` | ุจุฏุก ุนูููุฉ ุฏูุน |
| GET | `/api/v1/payments/{ref}/status` | ุญุงูุฉ ุงูุฏูุน |
| POST | `/api/v1/payments/webhook/{gateway}` | ุงุณุชูุจุงู ุฅุดุนุงุฑุงุช ุงูุจูุงุจุฉ |
| GET | `/api/v1/payments/unmatched` | ุงูุฏูุนุงุช ุบูุฑ ุงููุทุงุจูุฉ |
| POST | `/api/v1/payments/{id}/match` | ูุทุงุจูุฉ ูุฏููุฉ |
| POST | `/api/v1/payments/{id}/refund` | ุงุณุชุฑุฏุงุฏ |
| GET | `/api/v1/payments/report` | ุชูุฑูุฑ ุงูุฏูุนุงุช |
| GET | `/api/v1/gateways` | ูุงุฆูุฉ ุงูุจูุงุจุงุช |
| GET | `/api/v1/gateways/{id}/transactions` | ูุนุงููุงุช ุจูุงุจุฉ |

---

### 18. ููุฎุต ุฏูุฑุฉ ุงูุฅูุฑุงุฏุงุช ุงููุชูุงููุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ุฏูุฑุฉ ุงูุฅูุฑุงุฏุงุช ุงููุชูุงููุฉ                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                 โ
โ  โโโโโโโโโโโโ    โโโโโโโโโโโโ    โโโโโโโโโโโโ    โโโโโโโโโโโโ โ
โ  โ ูุฑุงุกุฉ   โโโโโถโ ุฅุตุฏุงุฑ   โโโโโถโ ุฅุฑุณุงู   โโโโโถโ ุชุญุตูู   โ โ
โ  โ ุงูุนุฏุงุฏ  โ    โ ุงููุงุชูุฑุฉ โ    โ ุงูุฅุดุนุงุฑ โ    โ ุงูุฏูุนุฉ  โ โ
โ  โโโโโโโโโโโโ    โโโโโโโโโโโโ    โโโโโโโโโโโโ    โโโโโโโโโโโโ โ
โ       โ               โ               โ               โ        โ
โ       โผ               โผ               โผ               โผ        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ                   ุงููุธุงู ุงููุญุงุณุจู                        โ โ
โ  โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ         โ โ
โ  โ  โ ููุฏ ุขูู   โ  โ ุชุญุฏูุซ    โ  โ ุชูุงุฑูุฑ    โ         โ โ
โ  โ  โ ูููุงุชูุฑุฉ  โ  โ ุงูุฃุฑุตุฏุฉ  โ  โ ุญูุฉ       โ         โ โ
โ  โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ         โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                 โ
โ  ูููุงุช ุงูุชุญุตูู:                                                โ
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ      โ
โ  โ ููุงุท    โ  โ ุจูุงุจุฉ   โ  โ ุชุญููู   โ  โ ุชุทุจูู   โ      โ
โ  โ ุงูุจูุน   โ  โ ุงูุฏูุน   โ  โ ุจููู    โ  โ ุงูุฌูุงู  โ      โ
โ  โ (POS)   โ  โ ุงูููุญุฏุฉ โ  โ         โ  โ         โ      โ
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ      โ
โ       โ               โ               โ               โ        โ
โ       โโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโ        โ
โ                               โ                                 โ
โ                               โผ                                 โ
โ                    โโโโโโโโโโโโโโโโโโโโ                        โ
โ                    โ ูุทุงุจูุฉ ุชููุงุฆูุฉ  โ                        โ
โ                    โ + ููุฏ ูุญุงุณุจู    โ                        โ
โ                    โโโโโโโโโโโโโโโโโโโโ                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```



---

## ๐ ููู 39 (ุชูููุฉ): ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงูุญูุฉ ููุนููุงุก

---

### 19. ุชูุฑูุฑ ุฅุบูุงู ุงูุตูุฏูู ุงููููู

#### 19.1 View: ุชูุฑูุฑ ุงูุฅุบูุงู ุงููููู

```sql
CREATE OR REPLACE VIEW daily_cash_closing_report AS
SELECT 
    s.id AS session_id,
    s.session_number,
    t.terminal_name,
    u.name AS cashier_name,
    s.opened_at,
    s.closed_at,
    s.opening_cash,
    s.closing_cash,
    s.expected_cash,
    s.cash_difference,
    
    -- ููุฎุต ุงููุนุงููุงุช
    COUNT(pt.id) AS total_transactions,
    SUM(CASE WHEN pt.transaction_type = 'invoice_payment' THEN pt.amount ELSE 0 END) AS invoice_payments,
    SUM(CASE WHEN pt.transaction_type = 'advance_payment' THEN pt.amount ELSE 0 END) AS advance_payments,
    SUM(CASE WHEN pt.transaction_type = 'deposit' THEN pt.amount ELSE 0 END) AS deposits,
    SUM(CASE WHEN pt.transaction_type = 'refund' THEN pt.amount ELSE 0 END) AS refunds,
    
    -- ุญุณุจ ุทุฑููุฉ ุงูุฏูุน
    SUM(pt.cash_amount) AS total_cash,
    SUM(pt.card_amount) AS total_card,
    SUM(pt.check_amount) AS total_check,
    
    -- ุงูุฅุฌูุงูู
    SUM(pt.amount) AS total_collected,
    
    -- ุนุฏุฏ ุงูุนููุงุก
    COUNT(DISTINCT pt.customer_id) AS unique_customers
    
FROM pos_sessions s
JOIN pos_terminals t ON s.terminal_id = t.id
JOIN users u ON s.cashier_id = u.id
LEFT JOIN pos_transactions pt ON pt.session_id = s.id AND pt.status = 'completed'
GROUP BY s.id, s.session_number, t.terminal_name, u.name, 
         s.opened_at, s.closed_at, s.opening_cash, s.closing_cash, 
         s.expected_cash, s.cash_difference;
```

#### 19.2 Function: ุชูุฑูุฑ ุงูุฅุบูุงู ุงููููู ุงูุดุงูู

```sql
CREATE OR REPLACE FUNCTION get_daily_closing_report(p_date DATE DEFAULT CURRENT_DATE)
RETURNS JSONB AS $$
DECLARE
    v_result JSONB;
BEGIN
    SELECT jsonb_build_object(
        'date', p_date,
        'sessions', (
            SELECT jsonb_agg(jsonb_build_object(
                'session_number', session_number,
                'terminal', terminal_name,
                'cashier', cashier_name,
                'opened_at', opened_at,
                'closed_at', closed_at,
                'opening_cash', opening_cash,
                'closing_cash', closing_cash,
                'difference', cash_difference,
                'total_transactions', total_transactions,
                'total_collected', total_collected
            ))
            FROM daily_cash_closing_report
            WHERE DATE(opened_at) = p_date
        ),
        'summary', (
            SELECT jsonb_build_object(
                'total_sessions', COUNT(*),
                'total_transactions', SUM(total_transactions),
                'total_cash', SUM(total_cash),
                'total_card', SUM(total_card),
                'total_check', SUM(total_check),
                'grand_total', SUM(total_collected),
                'total_difference', SUM(cash_difference),
                'unique_customers', SUM(unique_customers)
            )
            FROM daily_cash_closing_report
            WHERE DATE(opened_at) = p_date
        ),
        'online_payments', (
            SELECT jsonb_build_object(
                'total_count', COUNT(*),
                'total_amount', COALESCE(SUM(amount), 0),
                'matched_count', COUNT(*) FILTER (WHERE is_matched = TRUE),
                'unmatched_count', COUNT(*) FILTER (WHERE is_matched = FALSE)
            )
            FROM online_payments
            WHERE DATE(completed_at) = p_date AND status = 'completed'
        )
    ) INTO v_result;
    
    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
```

#### 19.3 ุดุงุดุฉ ุชูุฑูุฑ ุงูุฅุบูุงู ุงููููู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุชูุฑูุฑ ุงูุฅุบูุงู ุงููููู - 18 ุฏูุณูุจุฑ 2025                  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                          โ
โ ููุฎุต ุงูููู:                                             โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุฅุฌูุงูู ุงูุชุญุตูู ุงูููุฏู: 125,000 ุฑ.ู               โ  โ
โ โ ุฅุฌูุงูู ุงูุชุญุตูู ุจุงูุจุทุงูุงุช: 45,000 ุฑ.ู             โ  โ
โ โ ุฅุฌูุงูู ุงูุชุญุตูู ุงูุฅููุชุฑููู: 80,000 ุฑ.ู            โ  โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ  โ
โ โ ุงูุฅุฌูุงูู ุงูููู: 250,000 ุฑ.ู                      โ  โ
โ โ                                                    โ  โ
โ โ ุนุฏุฏ ุงููุนุงููุงุช: 156                               โ  โ
โ โ ุนุฏุฏ ุงูุนููุงุก: 142                                 โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุฌูุณุงุช ููุงุท ุงูุจูุน:                                       โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุงูููุทุฉ | ุงูููุธู | ุงููุญุตู | ุงููุฑู | ุงูุญุงูุฉ       โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ โ ุงูููุชุจ ุงูุฑุฆูุณู | ุฃุญูุฏ | 85,000 | 0 | โ ูุทุงุจู   โ  โ
โ โ ูุฑุน ุงูุดูุงู | ูุญูุฏ | 40,000 | -50 | โ ุนุฌุฒ      โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุงูุฏูุนุงุช ุงูุฅููุชุฑูููุฉ:                                    โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุงูุจูุงุจุฉ | ุงูุนุฏุฏ | ุงููุจูุบ | ุงููุทุงุจู | ุบูุฑ ูุทุงุจู  โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ โ ูุงุด | 25 | 35,000 | 24 | 1                      โ  โ
โ โ ูููุณู | 18 | 28,000 | 18 | 0                    โ  โ
โ โ ุฌูุงูู | 12 | 17,000 | 12 | 0                    โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ [๐ ุทุจุงุนุฉ] [๐ ุชุตุฏูุฑ Excel] [๐ง ุฅุฑุณุงู ููุฅุฏุงุฑุฉ]        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### 20. ุชูุฑูุฑ ุฃุนูุงุฑ ุงูุฐูู ุงููุฏููุฉ (Accounts Receivable Aging)

#### 20.1 View: ุฃุนูุงุฑ ุงูุฐูู ุงููุฏููุฉ

```sql
CREATE OR REPLACE VIEW accounts_receivable_aging AS
SELECT 
    c.id AS customer_id,
    c.customer_number,
    c.name AS customer_name,
    c.customer_type,
    c.phone,
    
    -- ุงูุฑุตูุฏ ุงูุฅุฌูุงูู
    c.current_balance AS total_balance,
    
    -- ุชุตููู ุญุณุจ ุงูุนูุฑ
    COALESCE(SUM(CASE 
        WHEN i.due_date >= CURRENT_DATE THEN (i.total_amount - COALESCE(i.paid_amount, 0))
        ELSE 0 
    END), 0) AS current_due,
    
    COALESCE(SUM(CASE 
        WHEN i.due_date < CURRENT_DATE AND i.due_date >= CURRENT_DATE - INTERVAL '30 days' 
        THEN (i.total_amount - COALESCE(i.paid_amount, 0))
        ELSE 0 
    END), 0) AS days_1_30,
    
    COALESCE(SUM(CASE 
        WHEN i.due_date < CURRENT_DATE - INTERVAL '30 days' AND i.due_date >= CURRENT_DATE - INTERVAL '60 days' 
        THEN (i.total_amount - COALESCE(i.paid_amount, 0))
        ELSE 0 
    END), 0) AS days_31_60,
    
    COALESCE(SUM(CASE 
        WHEN i.due_date < CURRENT_DATE - INTERVAL '60 days' AND i.due_date >= CURRENT_DATE - INTERVAL '90 days' 
        THEN (i.total_amount - COALESCE(i.paid_amount, 0))
        ELSE 0 
    END), 0) AS days_61_90,
    
    COALESCE(SUM(CASE 
        WHEN i.due_date < CURRENT_DATE - INTERVAL '90 days' 
        THEN (i.total_amount - COALESCE(i.paid_amount, 0))
        ELSE 0 
    END), 0) AS over_90_days,
    
    -- ุฃูุฏู ูุงุชูุฑุฉ ูุชุฃุฎุฑุฉ
    MIN(CASE WHEN i.due_date < CURRENT_DATE THEN i.due_date END) AS oldest_overdue_date,
    
    -- ุนุฏุฏ ุงูููุงุชูุฑ ุงููุชุฃุฎุฑุฉ
    COUNT(CASE WHEN i.due_date < CURRENT_DATE AND i.status != 'paid' THEN 1 END) AS overdue_invoices_count
    
FROM customers c
LEFT JOIN invoices i ON i.customer_id = c.id AND i.status IN ('pending', 'partial', 'overdue')
WHERE c.current_balance > 0
GROUP BY c.id, c.customer_number, c.name, c.customer_type, c.phone, c.current_balance;
```

#### 20.2 Function: ููุฎุต ุฃุนูุงุฑ ุงูุฐูู

```sql
CREATE OR REPLACE FUNCTION get_ar_aging_summary()
RETURNS JSONB AS $$
BEGIN
    RETURN (
        SELECT jsonb_build_object(
            'total_receivables', SUM(total_balance),
            'current_due', SUM(current_due),
            'days_1_30', SUM(days_1_30),
            'days_31_60', SUM(days_31_60),
            'days_61_90', SUM(days_61_90),
            'over_90_days', SUM(over_90_days),
            'total_customers', COUNT(*),
            'overdue_customers', COUNT(*) FILTER (WHERE days_1_30 + days_31_60 + days_61_90 + over_90_days > 0),
            'percentages', jsonb_build_object(
                'current', ROUND(SUM(current_due) * 100.0 / NULLIF(SUM(total_balance), 0), 2),
                'days_1_30', ROUND(SUM(days_1_30) * 100.0 / NULLIF(SUM(total_balance), 0), 2),
                'days_31_60', ROUND(SUM(days_31_60) * 100.0 / NULLIF(SUM(total_balance), 0), 2),
                'days_61_90', ROUND(SUM(days_61_90) * 100.0 / NULLIF(SUM(total_balance), 0), 2),
                'over_90', ROUND(SUM(over_90_days) * 100.0 / NULLIF(SUM(total_balance), 0), 2)
            )
        )
        FROM accounts_receivable_aging
    );
END;
$$ LANGUAGE plpgsql;
```

#### 20.3 ุดุงุดุฉ ุฃุนูุงุฑ ุงูุฐูู ุงููุฏููุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุชูุฑูุฑ ุฃุนูุงุฑ ุงูุฐูู ุงููุฏููุฉ                               โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                          โ
โ ููุฎุต ุงูุฐูู:                                             โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุฅุฌูุงูู ุงูุฐูู ุงููุฏููุฉ: 2,500,000 ุฑ.ู              โ  โ
โ โ                                                    โ  โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ ุฌุงุฑู: 1,500,000   โ  โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ 1-30: 400,000     โ  โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ 31-60: 300,000    โ  โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ 61-90: 200,000    โ  โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ +90: 100,000      โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุชูุงุตูู ุงูุนููุงุก:                                         โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุงูุนููู | ุงูุฅุฌูุงูู | ุฌุงุฑู | 1-30 | 31-60 | +60   โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ โ ูุญูุฏ ุนูู | 50,000 | 30,000 | 15,000 | 5,000 | 0 โ  โ
โ โ ุฃุญูุฏ ูุญูุฏ | 35,000 | 20,000 | 10,000 | 5,000 | 0 โ  โ
โ โ ุดุฑูุฉ ABC | 120,000 | 80,000 | 20,000 | 10,000|10Kโ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ [๐ ููุชุฑุฉ] [๐ ุชุตุฏูุฑ] [๐ง ุฅุฑุณุงู ุชุฐููุฑุงุช]              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### 21. ูุดู ุญุณุงุจ ุงูุนููู ุงูุชูุตููู

#### 21.1 View: ูุดู ุญุณุงุจ ุงูุนููู

```sql
CREATE OR REPLACE VIEW customer_statement AS
SELECT 
    c.id AS customer_id,
    c.customer_number,
    c.name AS customer_name,
    t.transaction_date,
    t.transaction_type,
    t.reference_number,
    t.description,
    t.debit,
    t.credit,
    t.running_balance
FROM customers c
CROSS JOIN LATERAL (
    -- ุงูููุงุชูุฑ
    SELECT 
        i.invoice_date AS transaction_date,
        'invoice' AS transaction_type,
        i.invoice_number AS reference_number,
        'ูุงุชูุฑุฉ ุงุณุชููุงู' AS description,
        i.total_amount AS debit,
        0 AS credit,
        0 AS running_balance -- ุณูุชู ุญุณุงุจู ูุงุญูุงู
    FROM invoices i WHERE i.customer_id = c.id
    
    UNION ALL
    
    -- ุงูุฏูุนุงุช ุงูููุฏูุฉ
    SELECT 
        pt.transaction_time AS transaction_date,
        'payment' AS transaction_type,
        pt.receipt_number AS reference_number,
        'ุณุฏุงุฏ ููุฏู' AS description,
        0 AS debit,
        pt.amount AS credit,
        0 AS running_balance
    FROM pos_transactions pt WHERE pt.customer_id = c.id AND pt.status = 'completed'
    
    UNION ALL
    
    -- ุงูุฏูุนุงุช ุงูุฅููุชุฑูููุฉ
    SELECT 
        op.completed_at AS transaction_date,
        'online_payment' AS transaction_type,
        op.payment_reference AS reference_number,
        'ุณุฏุงุฏ ุฅููุชุฑููู' AS description,
        0 AS debit,
        op.amount AS credit,
        0 AS running_balance
    FROM online_payments op WHERE op.customer_id = c.id AND op.status = 'completed'
) t
ORDER BY c.id, t.transaction_date;
```

#### 21.2 Function: ูุดู ุญุณุงุจ ุงูุนููู ูุน ุงูุฑุตูุฏ ุงูุชุฑุงููู

```sql
CREATE OR REPLACE FUNCTION get_customer_statement(
    p_customer_id UUID,
    p_from_date DATE DEFAULT NULL,
    p_to_date DATE DEFAULT NULL
) RETURNS JSONB AS $$
DECLARE
    v_customer RECORD;
    v_opening_balance DECIMAL(15,2);
    v_transactions JSONB;
BEGIN
    -- ุฌูุจ ุจูุงูุงุช ุงูุนููู
    SELECT * INTO v_customer FROM customers WHERE id = p_customer_id;
    
    -- ุญุณุงุจ ุงูุฑุตูุฏ ุงูุงูุชุชุงุญู
    IF p_from_date IS NOT NULL THEN
        SELECT COALESCE(SUM(debit - credit), 0) INTO v_opening_balance
        FROM customer_statement
        WHERE customer_id = p_customer_id AND transaction_date < p_from_date;
    ELSE
        v_opening_balance := 0;
    END IF;
    
    -- ุฌูุจ ุงููุนุงููุงุช ูุน ุงูุฑุตูุฏ ุงูุชุฑุงููู
    SELECT jsonb_agg(
        jsonb_build_object(
            'date', transaction_date,
            'type', transaction_type,
            'reference', reference_number,
            'description', description,
            'debit', debit,
            'credit', credit,
            'balance', SUM(debit - credit) OVER (ORDER BY transaction_date, reference_number) + v_opening_balance
        ) ORDER BY transaction_date
    ) INTO v_transactions
    FROM customer_statement
    WHERE customer_id = p_customer_id
      AND (p_from_date IS NULL OR transaction_date >= p_from_date)
      AND (p_to_date IS NULL OR transaction_date <= p_to_date);
    
    RETURN jsonb_build_object(
        'customer', jsonb_build_object(
            'id', v_customer.id,
            'number', v_customer.customer_number,
            'name', v_customer.name,
            'phone', v_customer.phone,
            'current_balance', v_customer.current_balance
        ),
        'period', jsonb_build_object(
            'from', COALESCE(p_from_date, 'ุงูุจุฏุงูุฉ'),
            'to', COALESCE(p_to_date, CURRENT_DATE)
        ),
        'opening_balance', v_opening_balance,
        'transactions', COALESCE(v_transactions, '[]'::JSONB),
        'closing_balance', v_customer.current_balance,
        'summary', jsonb_build_object(
            'total_invoices', (SELECT COALESCE(SUM(debit), 0) FROM customer_statement WHERE customer_id = p_customer_id),
            'total_payments', (SELECT COALESCE(SUM(credit), 0) FROM customer_statement WHERE customer_id = p_customer_id)
        )
    );
END;
$$ LANGUAGE plpgsql;
```

#### 21.3 ุดุงุดุฉ ูุดู ุญุณุงุจ ุงูุนููู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ูุดู ุญุณุงุจ ุงูุนููู                                         โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                          โ
โ ุงูุนููู: ูุญูุฏ ุนูู ุฃุญูุฏ | ุฑูู ุงูุนุฏุงุฏ: 12345              โ
โ ุงููุชุฑุฉ: ูู 01/01/2025 ุฅูู 18/12/2025                  โ
โ                                                          โ
โ ููุฎุต ุงูุญุณุงุจ:                                            โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุงูุฑุตูุฏ ุงูุงูุชุชุงุญู: 10,000 ุฑ.ู (ูุฏูู)             โ  โ
โ โ ุฅุฌูุงูู ุงูููุงุชูุฑ: 45,000 ุฑ.ู                     โ  โ
โ โ ุฅุฌูุงูู ุงููุฏููุนุงุช: 48,000 ุฑ.ู                    โ  โ
โ โ ุงูุฑุตูุฏ ุงูุฎุชุงูู: 7,000 ุฑ.ู (ูุฏูู)               โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุชูุงุตูู ุงูุญุฑูุงุช:                                         โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุงูุชุงุฑูุฎ | ุงูุจูุงู | ูุฏูู | ุฏุงุฆู | ุงูุฑุตูุฏ         โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ โ 01/01 | ุฑุตูุฏ ุงูุชุชุงุญู | - | - | 10,000          โ  โ
โ โ 10/01 | ูุงุชูุฑุฉ INV-001 | 5,000 | - | 15,000    โ  โ
โ โ 15/01 | ุณุฏุงุฏ ููุฏู | - | 8,000 | 7,000          โ  โ
โ โ 10/02 | ูุงุชูุฑุฉ INV-002 | 5,500 | - | 12,500    โ  โ
โ โ 20/02 | ุณุฏุงุฏ ุฅููุชุฑููู | - | 10,000 | 2,500     โ  โ
โ โ ... | ... | ... | ... | ...                     โ  โ
โ โ 18/12 | ุงูุฑุตูุฏ ุงูุฎุชุงูู | - | - | 7,000         โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ [๐ ุทุจุงุนุฉ] [๐ ุชุตุฏูุฑ PDF] [๐ง ุฅุฑุณุงู ููุนููู]           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### 22. APIs ุงูุชูุงุฑูุฑ ุงููุงููุฉ ููุนููุงุก

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/reports/daily-closing` | ุชูุฑูุฑ ุงูุฅุบูุงู ุงููููู |
| GET | `/api/v1/reports/daily-closing/{date}` | ุชูุฑูุฑ ุฅุบูุงู ุชุงุฑูุฎ ูุญุฏุฏ |
| GET | `/api/v1/reports/ar-aging` | ุฃุนูุงุฑ ุงูุฐูู ุงููุฏููุฉ |
| GET | `/api/v1/reports/ar-aging/summary` | ููุฎุต ุฃุนูุงุฑ ุงูุฐูู |
| GET | `/api/v1/customers/{id}/statement` | ูุดู ุญุณุงุจ ุงูุนููู |
| GET | `/api/v1/customers/{id}/statement/pdf` | ูุดู ุญุณุงุจ PDF |
| POST | `/api/v1/customers/{id}/statement/send` | ุฅุฑุณุงู ูุดู ููุนููู |



---

# ๐ง ููู 40 (ุชูููุฉ): ุฅุดุนุงุฑุงุช ุงูุตูุงูุฉ ุงููุฌุฏููุฉ ููุนููุงุก

> **ุงูุบุฑุถ:** ุฅุจูุงุบ ุงูุนููุงุก ูุณุจูุงู ุจุฃู ุตูุงูุฉ ูุฌุฏููุฉ ูุฏ ุชุคุซุฑ ุนูู ุฎุฏูุชูู.

## 1. ุฌุฏูู ุฅุนูุงูุงุช ุงูุตูุงูุฉ ุงููุฌุฏููุฉ (scheduled_maintenance_announcements)

```sql
CREATE TABLE scheduled_maintenance_announcements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(200) NOT NULL,
    description TEXT,
    maintenance_type VARCHAR(50) NOT NULL, -- 'planned', 'emergency', 'upgrade'
    
    start_datetime TIMESTAMP NOT NULL,
    end_datetime TIMESTAMP NOT NULL,
    estimated_duration_hours DECIMAL(5,2),
    
    affected_area_type VARCHAR(50) NOT NULL, -- 'station', 'feeder', 'zone', 'all'
    affected_station_id UUID REFERENCES stations(id),
    affected_feeder_id UUID REFERENCES feeders(id),
    affected_zone VARCHAR(100),
    
    status VARCHAR(50) DEFAULT 'draft', -- 'draft', 'scheduled', 'sent', 'in_progress', 'completed', 'cancelled'
    notify_before_hours INTEGER DEFAULT 24,
    notification_sent_at TIMESTAMP,
    reminder_sent_at TIMESTAMP,
    
    affected_customers_count INTEGER DEFAULT 0,
    notifications_sent_count INTEGER DEFAULT 0,
    
    work_order_id UUID REFERENCES work_orders(id),
    pm_work_order_id UUID REFERENCES pm_work_orders(id),
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_sma_status ON scheduled_maintenance_announcements(status);
CREATE INDEX idx_sma_start ON scheduled_maintenance_announcements(start_datetime);
```

## 2. ุฌุฏูู ุฅุดุนุงุฑุงุช ุงูุตูุงูุฉ ููุนููุงุก (customer_maintenance_notifications)

```sql
CREATE TABLE customer_maintenance_notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    announcement_id UUID NOT NULL REFERENCES scheduled_maintenance_announcements(id),
    customer_id UUID NOT NULL REFERENCES customers(id),
    
    notification_type VARCHAR(50) NOT NULL, -- 'initial', 'reminder', 'start', 'end', 'cancelled'
    status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'sent', 'delivered', 'read', 'failed'
    
    sent_via_sms BOOLEAN DEFAULT FALSE,
    sent_via_push BOOLEAN DEFAULT FALSE,
    sent_via_app BOOLEAN DEFAULT FALSE,
    
    scheduled_send_at TIMESTAMP,
    sent_at TIMESTAMP,
    delivered_at TIMESTAMP,
    read_at TIMESTAMP,
    
    error_message TEXT,
    retry_count INTEGER DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_cmn_announcement ON customer_maintenance_notifications(announcement_id);
CREATE INDEX idx_cmn_customer ON customer_maintenance_notifications(customer_id);
```

## 3. Function ุชุญุฏูุฏ ุงูุนููุงุก ุงููุชุฃุซุฑูู

```sql
CREATE OR REPLACE FUNCTION get_affected_customers(p_announcement_id UUID)
RETURNS TABLE (customer_id UUID, customer_name VARCHAR, phone VARCHAR, subscription_number VARCHAR) AS $$
DECLARE
    v_announcement RECORD;
BEGIN
    SELECT * INTO v_announcement FROM scheduled_maintenance_announcements WHERE id = p_announcement_id;
    
    RETURN QUERY
    SELECT c.id, c.name, c.phone, c.subscription_number
    FROM customers c
    JOIN meters m ON c.id = m.customer_id
    WHERE c.status = 'active' AND (
        (v_announcement.affected_area_type = 'station' AND m.station_id = v_announcement.affected_station_id)
        OR (v_announcement.affected_area_type = 'feeder' AND m.feeder_id = v_announcement.affected_feeder_id)
        OR (v_announcement.affected_area_type = 'zone' AND c.zone = v_announcement.affected_zone)
        OR (v_announcement.affected_area_type = 'all')
    );
END;
$$ LANGUAGE plpgsql;
```

## 4. Function ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุงูุตูุงูุฉ

```sql
CREATE OR REPLACE FUNCTION send_maintenance_notifications(p_announcement_id UUID)
RETURNS INTEGER AS $$
DECLARE
    v_customer RECORD;
    v_count INTEGER := 0;
    v_announcement RECORD;
BEGIN
    SELECT * INTO v_announcement FROM scheduled_maintenance_announcements WHERE id = p_announcement_id;
    
    FOR v_customer IN SELECT * FROM get_affected_customers(p_announcement_id)
    LOOP
        INSERT INTO customer_maintenance_notifications (announcement_id, customer_id, notification_type, status, scheduled_send_at)
        VALUES (p_announcement_id, v_customer.customer_id, 'initial', 'pending',
                v_announcement.start_datetime - (v_announcement.notify_before_hours || ' hours')::INTERVAL);
        
        INSERT INTO customer_notifications (customer_id, notification_type, title, message, priority)
        VALUES (v_customer.customer_id, 'maintenance_scheduled', 'ุฅุดุนุงุฑ ุตูุงูุฉ ูุฌุฏููุฉ',
                'ุณูุชู ุฅุฌุฑุงุก ุตูุงูุฉ ูุฌุฏููุฉ ูู ููุทูุชู ุจุชุงุฑูุฎ ' || TO_CHAR(v_announcement.start_datetime, 'YYYY-MM-DD HH24:MI'),
                'high');
        
        v_count := v_count + 1;
    END LOOP;
    
    UPDATE scheduled_maintenance_announcements SET
        affected_customers_count = v_count, notifications_sent_count = v_count,
        notification_sent_at = NOW(), status = 'sent', updated_at = NOW()
    WHERE id = p_announcement_id;
    
    RETURN v_count;
END;
$$ LANGUAGE plpgsql;
```

## 5. Trigger ุฅุดุนุงุฑ ุงูุชูุงุก ุงูุตูุงูุฉ

```sql
CREATE OR REPLACE FUNCTION notify_maintenance_completed()
RETURNS TRIGGER AS $$
DECLARE v_customer RECORD;
BEGIN
    IF NEW.status = 'completed' AND OLD.status != 'completed' THEN
        FOR v_customer IN SELECT * FROM get_affected_customers(NEW.id)
        LOOP
            INSERT INTO customer_notifications (customer_id, notification_type, title, message, priority)
            VALUES (v_customer.customer_id, 'maintenance_completed', 'ุชู ุฅููุงู ุงูุตูุงูุฉ',
                    'ุชู ุฅููุงู ุฃุนูุงู ุงูุตูุงูุฉ ุงููุฌุฏููุฉ ุจูุฌุงุญ. ุดูุฑุงู ูุชููููู.', 'normal');
        END LOOP;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_maintenance_completed
AFTER UPDATE ON scheduled_maintenance_announcements
FOR EACH ROW EXECUTE FUNCTION notify_maintenance_completed();
```

## 6. ุดุงุดุฉ ุฅุฏุงุฑุฉ ุฅุนูุงูุงุช ุงูุตูุงูุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      ๐ข ุฅุฏุงุฑุฉ ุฅุนูุงูุงุช ุงูุตูุงูุฉ ุงููุฌุฏููุฉ                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  [+ ุฅุนูุงู ุฌุฏูุฏ]  [ููุชุฑ: ุงูุญุงูุฉ โผ]  [ููุชุฑ: ุงูููุทูุฉ โผ]  [๐ ุจุญุซ]             โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ๐ ุงูุฅุนูุงูุงุช ุงููุงุฏูุฉ                                                โ   โ
โ  โโโโโโโโโโโโฌโโโโโโโโโโโโโฌโโโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโค   โ
โ  โ ุงูุนููุงู  โ ุงูุชุงุฑูุฎ    โ ุงูููุทูุฉ    โ ุงูุนููุงุก  โ ุงูุญุงูุฉ   โ ุฅุฌุฑุงุก   โ   โ
โ  โโโโโโโโโโโโผโโโโโโโโโโโโโผโโโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโค   โ
โ  โ ุตูุงูุฉ    โ 2024-01-20 โ ูุญุทุฉ 1     โ 450      โ ูุฌุฏูู   โ [๐ค][โ๏ธ]โ   โ
โ  โ ุงููุญูู   โ 09:00-15:00โ            โ          โ          โ         โ   โ
โ  โโโโโโโโโโโโผโโโโโโโโโโโโโผโโโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโค   โ
โ  โ ุชุฑููุฉ    โ 2024-01-25 โ ูุบุฐู A3    โ 1,200    โ ูุณูุฏุฉ   โ [๐ค][โ๏ธ]โ   โ
โ  โ ุงูุดุจูุฉ   โ 22:00-06:00โ            โ          โ          โ         โ   โ
โ  โโโโโโโโโโโโดโโโโโโโโโโโโโดโโโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโ   โ
โ                                                                             โ
โ  [ูุนุงููุฉ ุงูุนููุงุก ุงููุชุฃุซุฑูู]  [๐ค ุฌุฏููุฉ ูุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช]                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 7. APIs ุฅุดุนุงุฑุงุช ุงูุตูุงูุฉ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/maintenance-announcements` | ูุงุฆูุฉ ุงูุฅุนูุงูุงุช |
| POST | `/api/v1/maintenance-announcements` | ุฅูุดุงุก ุฅุนูุงู ุฌุฏูุฏ |
| GET | `/api/v1/maintenance-announcements/:id` | ุชูุงุตูู ุฅุนูุงู |
| PUT | `/api/v1/maintenance-announcements/:id` | ุชุญุฏูุซ ุฅุนูุงู |
| GET | `/api/v1/maintenance-announcements/:id/affected-customers` | ุงูุนููุงุก ุงููุชุฃุซุฑูู |
| POST | `/api/v1/maintenance-announcements/:id/send` | ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช |
| PUT | `/api/v1/maintenance-announcements/:id/status` | ุชุญุฏูุซ ุงูุญุงูุฉ |
| GET | `/api/v1/portal/maintenance-schedule` | ุฌุฏูู ุงูุตูุงูุฉ ููุนููู |



---

# ๐ ุชุฑุญูู ุฃุฑุตุฏุฉ ุงูุนููุงุก ุงูุชุงุฑูุฎูุฉ

> **ุงูุบุฑุถ:** ุชุฑุญูู ุฃุฑุตุฏุฉ ุงูุนููุงุก ุงููุชุฑุงููุฉ ููุฐ ุจุฏุงูุฉ 2024 ุฅูู ุงููุธุงู ุงูุฌุฏูุฏ

---

## 1. ุฌุฏูู ุฃุฑุตุฏุฉ ุงูุนููุงุก ุงูุงูุชุชุงุญูุฉ (customer_opening_balances)

```sql
CREATE TABLE customer_opening_balances (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    migration_project_id UUID REFERENCES migration_projects(id),
    
    customer_id UUID REFERENCES customers(id),
    customer_code VARCHAR(50),
    customer_name VARCHAR(200),
    meter_number VARCHAR(50),
    
    source_balance DECIMAL(18,2) NOT NULL,
    source_balance_date DATE NOT NULL,
    source_system VARCHAR(100),
    source_reference VARCHAR(100),
    
    unpaid_invoices_count INTEGER DEFAULT 0,
    oldest_invoice_date DATE,
    last_payment_date DATE,
    last_payment_amount DECIMAL(18,2),
    
    is_verified BOOLEAN DEFAULT FALSE,
    verified_by UUID REFERENCES users(id),
    verified_at TIMESTAMP,
    verification_method VARCHAR(50),
    verification_notes TEXT,
    
    calculated_balance DECIMAL(18,2),
    variance DECIMAL(18,2) GENERATED ALWAYS AS (source_balance - COALESCE(calculated_balance, source_balance)) STORED,
    variance_reason TEXT,
    
    status VARCHAR(50) DEFAULT 'pending',
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_cob_project ON customer_opening_balances(migration_project_id);
CREATE INDEX idx_cob_customer ON customer_opening_balances(customer_id);
CREATE INDEX idx_cob_status ON customer_opening_balances(status);
```

## 2. Function ุชุฑุญูู ุฃุฑุตุฏุฉ ุงูุนููุงุก

```sql
CREATE OR REPLACE FUNCTION migrate_customer_balances(p_project_id UUID, p_opening_date DATE)
RETURNS TABLE (
    success BOOLEAN,
    customers_migrated INTEGER,
    total_balance DECIMAL,
    journal_entry_id UUID,
    message TEXT
) AS $$
DECLARE
    v_count INTEGER := 0;
    v_total DECIMAL := 0;
    v_journal_id UUID;
    v_receivables_account_id UUID;
BEGIN
    SELECT id INTO v_receivables_account_id FROM accounts WHERE system_account = 'accounts_receivable' LIMIT 1;
    
    IF v_receivables_account_id IS NULL THEN
        RETURN QUERY SELECT FALSE, 0, 0::DECIMAL, NULL::UUID, 'ูู ูุชู ุงูุนุซูุฑ ุนูู ุญุณุงุจ ุงูุฐูู ุงููุฏููุฉ';
        RETURN;
    END IF;
    
    SELECT COUNT(*), COALESCE(SUM(source_balance), 0)
    INTO v_count, v_total
    FROM customer_opening_balances
    WHERE migration_project_id = p_project_id AND status = 'verified';
    
    IF v_count = 0 THEN
        RETURN QUERY SELECT FALSE, 0, 0::DECIMAL, NULL::UUID, 'ูุง ุชูุฌุฏ ุฃุฑุตุฏุฉ ุนููุงุก ูุนุชูุฏุฉ ููุชุฑุญูู';
        RETURN;
    END IF;
    
    UPDATE customers c
    SET current_balance = cob.source_balance, updated_at = NOW()
    FROM customer_opening_balances cob
    WHERE c.id = cob.customer_id AND cob.migration_project_id = p_project_id AND cob.status = 'verified';
    
    INSERT INTO journal_entries (entry_number, entry_date, entry_type, description, total_debit, total_credit, status, source_system)
    VALUES ('COB-' || TO_CHAR(p_opening_date, 'YYYY') || '-001', p_opening_date, 'opening_balance',
            'ููุฏ ุงูุฃุฑุตุฏุฉ ุงูุงูุชุชุงุญูุฉ ููุนููุงุก', v_total, v_total, 'posted', 'migration')
    RETURNING id INTO v_journal_id;
    
    UPDATE customer_opening_balances SET status = 'posted', updated_at = NOW()
    WHERE migration_project_id = p_project_id AND status = 'verified';
    
    RETURN QUERY SELECT TRUE, v_count, v_total, v_journal_id, 'ุชู ุชุฑุญูู ุฃุฑุตุฏุฉ ' || v_count || ' ุนููู ุจุฅุฌูุงูู ' || v_total || ' ุฑูุงู';
END;
$$ LANGUAGE plpgsql;
```

## 3. APIs ุชุฑุญูู ุฃุฑุตุฏุฉ ุงูุนููุงุก

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | `/api/v1/migration/customers/import` | ุงุณุชูุฑุงุฏ ุฃุฑุตุฏุฉ ุงูุนููุงุก ูู Excel |
| GET | `/api/v1/migration/customers/balances` | ูุงุฆูุฉ ุฃุฑุตุฏุฉ ุงูุนููุงุก ููุชุฑุญูู |
| GET | `/api/v1/migration/customers/balances/:id` | ุชูุงุตูู ุฑุตูุฏ ุนููู |
| PUT | `/api/v1/migration/customers/balances/:id/verify` | ุงุนุชูุงุฏ ุฑุตูุฏ ุนููู |
| PUT | `/api/v1/migration/customers/balances/bulk-verify` | ุงุนุชูุงุฏ ูุฌููุนุฉ |
| POST | `/api/v1/migration/customers/migrate` | ุชูููุฐ ุงูุชุฑุญูู |
| GET | `/api/v1/migration/customers/variances` | ูุงุฆูุฉ ุงููุฑููุงุช |
| PUT | `/api/v1/migration/customers/variances/:id/resolve` | ุญู ูุฑู |


---

# ๐ ุงูุชูุงูู ูุน ูุธุงู ุงููุทูุฑ (02)

## ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุงูุนููุงุก ูุงูููุชุฑุฉ ูุชูุงูู ูุน ูุธุงู ุงููุทูุฑ ุนุจุฑ:
1. **APIs ุงูุฏุงุฎููุฉ** - ููุชูุงุตู ูุน ุงูุฃูุธูุฉ ุงูุฃุฎุฑู
2. **ูุธุงู ุงูุฃุญุฏุงุซ** - ููุดุฑ ุฃุญุฏุงุซ ุงูุนููุงุก ูุงูููุงุชูุฑ
3. **ุจูุงุจุงุช ุงูุฏูุน** - ููุฏูุน ุงูุฅููุชุฑููู
4. **ุงูุฅุดุนุงุฑุงุช** - SMS ูุงูุจุฑูุฏ ุงูุฅููุชุฑููู
5. **ุจูุงุจุฉ ุงูุนููุงุก** - ููุฎุฏูุฉ ุงูุฐุงุชูุฉ

---

## ๐ก APIs ุงููุณุฌูุฉ ูู ูุธุงู ุงููุทูุฑ

ุฌููุน APIs ูุธุงู ุงูุนููุงุก ูุงูููุชุฑุฉ ูุชุงุญุฉ ุนุจุฑ `/api/billing/*`:

| ุงููุฌููุนุฉ | Endpoint | ุงููุตู |
|----------|----------|-------|
| ุงูุนููุงุก | `/api/billing/customers` | ุฅุฏุงุฑุฉ ุงูุนููุงุก |
| ุงูููุงุชูุฑ | `/api/billing/invoices` | ุฅุฏุงุฑุฉ ุงูููุงุชูุฑ |
| ุงููุฏููุนุงุช | `/api/billing/payments` | ุฅุฏุงุฑุฉ ุงููุฏููุนุงุช |
| ุงููุฑุงุกุงุช | `/api/billing/readings` | ูุฑุงุกุงุช ุงูุนุฏุงุฏุงุช |
| ุงูุชุนุฑูุฉ | `/api/billing/tariffs` | ุฅุฏุงุฑุฉ ุงูุชุนุฑูุฉ |

---

## ๐ฏ ุงูุฃุญุฏุงุซ ุงูููุดูุฑุฉ

```
customer.created            - ุฅูุดุงุก ุนููู ุฌุฏูุฏ
customer.updated            - ุชุญุฏูุซ ุจูุงูุงุช ุนููู
customer.disconnection_requested - ุทูุจ ูุตู
customer.reconnection_requested  - ุทูุจ ุฅุนุงุฏุฉ ุชูุตูู

invoice.created             - ุฅูุดุงุก ูุงุชูุฑุฉ
invoice.sent                - ุฅุฑุณุงู ูุงุชูุฑุฉ
invoice.paid                - ุณุฏุงุฏ ูุงุชูุฑุฉ
invoice.overdue             - ุชุฃุฎุฑ ุณุฏุงุฏ ูุงุชูุฑุฉ
invoice.cancelled           - ุฅูุบุงุก ูุงุชูุฑุฉ

payment.received            - ุงุณุชูุงู ุฏูุนุฉ
payment.failed              - ูุดู ุฏูุนุฉ
payment.refunded            - ุงุณุชุฑุฏุงุฏ ุฏูุนุฉ

meter.reading               - ูุฑุงุกุฉ ุนุฏุงุฏ
meter.reading_required      - ุทูุจ ูุฑุงุกุฉ ุนุฏุงุฏ
```

---

## ๐ฅ ุงูุฃุญุฏุงุซ ุงููุณุชูุจูุฉ

| ุงูุญุฏุซ | ุงููุตุฏุฑ | ุงูุฅุฌุฑุงุก |
|-------|--------|---------|
| `work_order.completed` | ุงูุนูููุงุช ุงูููุฏุงููุฉ | ุชุญุฏูุซ ุญุงูุฉ ุงูุนููู |
| `asset.installed` | ุงูุฃุตูู ูุงูุตูุงูุฉ | ุฑุจุท ุงูุนุฏุงุฏ ุจุงูุนููู |
| `scada.reading` | ุงููุฑุงูุจุฉ ูุงูุชุญูู | ุชุญุฏูุซ ูุฑุงุกุฉ ุงูุนุฏุงุฏ |

---

## ๐ณ ุชูุงูู ุจูุงุจุงุช ุงูุฏูุน

### ุจูุงุจุงุช ุงูุฏูุน ุงููุฏุนููุฉ

| ุงูุจูุงุจุฉ | ุงูููุน | ุงูุญุงูุฉ |
|---------|-------|--------|
| ูููุณู | ูุญูู | ููุนู |
| ูุงุด | ูุญูู | ููุนู |
| Stripe | ุฏููู | ุงุฎุชูุงุฑู |

### Webhook ุงุณุชูุจุงู ุงูุฏูุนุงุช

```
POST /api/billing/payments/webhook/:gateway
```

### ูููู ุงูุจูุงูุงุช

```json
{
  "gateway": "flousi",
  "transaction_id": "TXN123456",
  "amount": 50000,
  "currency": "YER",
  "customer_reference": "CUST001",
  "invoice_reference": "INV202412001",
  "status": "success",
  "timestamp": "2024-12-15T10:00:00Z"
}
```

---

## ๐ฑ ุจูุงุจุฉ ุงูุนููุงุก

### APIs ุจูุงุจุฉ ุงูุนููุงุก (`/api/billing/portal/*`)

```
# === ุงููุตุงุฏูุฉ ===
POST   /api/billing/portal/auth/login       - ุชุณุฌูู ุงูุฏุฎูู
POST   /api/billing/portal/auth/register    - ุงูุชุณุฌูู
POST   /api/billing/portal/auth/forgot-password - ูุณูุช ูููุฉ ุงููุฑูุฑ

# === ุงูุญุณุงุจ ===
GET    /api/billing/portal/account          - ุจูุงูุงุช ุญุณุงุจู
PUT    /api/billing/portal/account          - ุชุญุฏูุซ ุจูุงูุงุชู

# === ุงูููุงุชูุฑ ===
GET    /api/billing/portal/invoices         - ููุงุชูุฑู
GET    /api/billing/portal/invoices/:id     - ุชูุงุตูู ูุงุชูุฑุฉ
GET    /api/billing/portal/invoices/:id/pdf - ุชุญููู PDF

# === ุงูุฏูุน ===
POST   /api/billing/portal/payments         - ุฏูุน ูุงุชูุฑุฉ
GET    /api/billing/portal/payments         - ุณุฌู ูุฏููุนุงุชู

# === ุงูุงุณุชููุงู ===
GET    /api/billing/portal/consumption      - ุงุณุชููุงูู
GET    /api/billing/portal/consumption/chart - ุฑุณู ุจูุงูู

# === ุงูุทูุจุงุช ===
POST   /api/billing/portal/requests         - ุชูุฏูู ุทูุจ
GET    /api/billing/portal/requests         - ุทูุจุงุชู
GET    /api/billing/portal/requests/:id     - ุชูุงุตูู ุทูุจ
```

---

## ๐จ ุชูุงูู ุงูุฅุดุนุงุฑุงุช

### ุฅุฑุณุงู SMS

```
POST /api/notifications/sms
{
  "to": "+967XXXXXXXXX",
  "template": "invoice_reminder",
  "params": {
    "customer_name": "ุฃุญูุฏ",
    "amount": "50,000",
    "due_date": "2024-12-20"
  }
}
```

### ุฅุฑุณุงู ุจุฑูุฏ ุฅููุชุฑููู

```
POST /api/notifications/email
{
  "to": "customer@example.com",
  "template": "invoice_created",
  "params": {...},
  "attachments": [
    {"type": "invoice_pdf", "id": "uuid"}
  ]
}
```

---

## ๐ ููุงููุณ ุงูุฃุฏุงุก ุงููุฑุณูุฉ ููุธุงู ุงููุทูุฑ

```sql
INSERT INTO performance_metrics (metric_name, metric_type, metric_value, labels)
VALUES
  ('billing.total_customers', 'gauge', 5000, '{}'),
  ('billing.active_customers', 'gauge', 4800, '{}'),
  ('billing.invoices_this_month', 'counter', 4500, '{}'),
  ('billing.collection_rate', 'gauge', 92.5, '{}'),
  ('billing.overdue_amount', 'gauge', 15000000, '{}');
```

---

## ๐ค ุชูุงูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู

### ุงูุชูุจุค ุจุงูุงุณุชููุงู

```
POST /api/ai/predict/customer-consumption
{
  "customer_id": "uuid",
  "forecast_months": 3
}
```

### ูุดู ุงูุงุญุชูุงู

```
POST /api/ai/detect/billing-fraud
{
  "customer_id": "uuid",
  "analysis_period_months": 6
}
```

### ุชุตููู ุงูุนููุงุก

```
GET /api/ai/analysis/customer-segments
{
  "segmentation_type": "payment_behavior"
}
```


---

## ๐๏ธ ุงูุจููุฉ ุงูุชูููุฉ ูููุธุงู

### ูุนูููุงุช ุงููุณุชูุฏุน

| ุงูุนูุตุฑ | ุงููููุฉ |
|--------|--------|
| **ุงุณู ุงููุณุชูุฏุน** | `billing-system` |
| **ุงููููุฐ API** | 3007 |
| **ุงููููุฐ Web** | 4207 |
| **ุจุงุฏุฆุฉ ุงูุฌุฏุงูู** | `bill_` |
| **ูุณุงุฑ API** | `/api/v1/billing` |

### Prisma Schema ุงูุฃุณุงุณู

```prisma
model bill_customers {
  id            String   @id @default(uuid()) @db.Uuid
  accountNumber String   @unique @map("account_number") @db.VarChar(20)
  name          String   @db.VarChar(200)
  type          String   @db.VarChar(20)
  idNumber      String?  @map("id_number") @db.VarChar(20)
  phone         String?  @db.VarChar(20)
  email         String?  @db.VarChar(255)
  address       String?  @db.Text
  stationId     String?  @map("station_id") @db.Uuid
  tariffId      String   @map("tariff_id") @db.Uuid
  status        String   @default("active") @db.VarChar(20)
  balance       Decimal  @default(0) @db.Decimal(15, 2)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  tariff        bill_tariffs @relation(fields: [tariffId], references: [id])
  meters        bill_meters[]
  invoices      bill_invoices[]
  payments      bill_payments[]
  
  @@index([stationId])
  @@index([status])
  @@map("bill_customers")
}

model bill_meters {
  id            String   @id @default(uuid()) @db.Uuid
  meterNumber   String   @unique @map("meter_number") @db.VarChar(50)
  customerId    String   @map("customer_id") @db.Uuid
  type          String   @db.VarChar(50)
  manufacturer  String?  @db.VarChar(100)
  model         String?  @db.VarChar(100)
  installDate   DateTime @map("install_date") @db.Date
  lastReadingDate DateTime? @map("last_reading_date")
  lastReading   Decimal  @default(0) @map("last_reading") @db.Decimal(15, 2)
  multiplier    Decimal  @default(1) @db.Decimal(10, 4)
  status        String   @default("active") @db.VarChar(20)
  latitude      Decimal? @db.Decimal(10, 8)
  longitude     Decimal? @db.Decimal(11, 8)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  customer      bill_customers @relation(fields: [customerId], references: [id])
  readings      bill_meter_readings[]
  
  @@map("bill_meters")
}

model bill_meter_readings {
  id            String   @id @default(uuid()) @db.Uuid
  meterId       String   @map("meter_id") @db.Uuid
  readingDate   DateTime @map("reading_date") @db.Date
  currentReading Decimal @map("current_reading") @db.Decimal(15, 2)
  previousReading Decimal @map("previous_reading") @db.Decimal(15, 2)
  consumption   Decimal  @db.Decimal(15, 2)
  readingType   String   @map("reading_type") @db.VarChar(20)
  readBy        String?  @map("read_by") @db.Uuid
  photo         String?  @db.VarChar(500)
  notes         String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  
  meter         bill_meters @relation(fields: [meterId], references: [id])
  
  @@index([meterId, readingDate])
  @@map("bill_meter_readings")
}

model bill_tariffs {
  id            String   @id @default(uuid()) @db.Uuid
  code          String   @unique @db.VarChar(20)
  name          String   @db.VarChar(100)
  type          String   @db.VarChar(50)
  fixedCharge   Decimal  @default(0) @map("fixed_charge") @db.Decimal(15, 2)
  isActive      Boolean  @default(true) @map("is_active")
  effectiveFrom DateTime @map("effective_from") @db.Date
  effectiveTo   DateTime? @map("effective_to") @db.Date
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  customers     bill_customers[]
  slabs         bill_tariff_slabs[]
  
  @@map("bill_tariffs")
}

model bill_tariff_slabs {
  id            String   @id @default(uuid()) @db.Uuid
  tariffId      String   @map("tariff_id") @db.Uuid
  fromUnit      Int      @map("from_unit")
  toUnit        Int?     @map("to_unit")
  rate          Decimal  @db.Decimal(10, 4)
  
  tariff        bill_tariffs @relation(fields: [tariffId], references: [id])
  
  @@map("bill_tariff_slabs")
}

model bill_invoices {
  id            String   @id @default(uuid()) @db.Uuid
  invoiceNumber String   @unique @map("invoice_number") @db.VarChar(50)
  customerId    String   @map("customer_id") @db.Uuid
  periodFrom    DateTime @map("period_from") @db.Date
  periodTo      DateTime @map("period_to") @db.Date
  consumption   Decimal  @db.Decimal(15, 2)
  energyCharge  Decimal  @map("energy_charge") @db.Decimal(15, 2)
  fixedCharge   Decimal  @map("fixed_charge") @db.Decimal(15, 2)
  taxAmount     Decimal  @default(0) @map("tax_amount") @db.Decimal(15, 2)
  totalAmount   Decimal  @map("total_amount") @db.Decimal(15, 2)
  paidAmount    Decimal  @default(0) @map("paid_amount") @db.Decimal(15, 2)
  balance       Decimal  @db.Decimal(15, 2)
  dueDate       DateTime @map("due_date") @db.Date
  status        String   @default("pending") @db.VarChar(20)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  customer      bill_customers @relation(fields: [customerId], references: [id])
  payments      bill_invoice_payments[]
  
  @@index([customerId])
  @@index([status])
  @@map("bill_invoices")
}

model bill_payments {
  id            String   @id @default(uuid()) @db.Uuid
  receiptNumber String   @unique @map("receipt_number") @db.VarChar(50)
  customerId    String   @map("customer_id") @db.Uuid
  amount        Decimal  @db.Decimal(15, 2)
  paymentMethod String   @map("payment_method") @db.VarChar(50)
  paymentDate   DateTime @map("payment_date") @db.Date
  referenceNumber String? @map("reference_number") @db.VarChar(100)
  status        String   @default("completed") @db.VarChar(20)
  receivedBy    String?  @map("received_by") @db.Uuid
  notes         String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  
  customer      bill_customers @relation(fields: [customerId], references: [id])
  invoicePayments bill_invoice_payments[]
  
  @@index([customerId])
  @@map("bill_payments")
}

model bill_invoice_payments {
  id          String   @id @default(uuid()) @db.Uuid
  invoiceId   String   @map("invoice_id") @db.Uuid
  paymentId   String   @map("payment_id") @db.Uuid
  amount      Decimal  @db.Decimal(15, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  
  invoice     bill_invoices @relation(fields: [invoiceId], references: [id])
  payment     bill_payments @relation(fields: [paymentId], references: [id])
  
  @@map("bill_invoice_payments")
}
```

### Environment Variables

```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/electricity_management"
JWT_SECRET="billing-system-secret-key"
API_PORT=3007
CORE_API_URL="http://localhost:3001/api/v1"
FIELD_OPS_API_URL="http://localhost:3004/api/v1"
```
