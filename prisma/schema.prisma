// Prisma Schema for Billing System (07)
// نظام العملاء والفوترة والتحصيل

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== تصنيفات العملاء ====================
model BillCustomerCategory {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(20)
  name        String   @db.VarChar(100)
  nameEn      String?  @map("name_en") @db.VarChar(100)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  customers BillCustomer[]
  tariffs   BillTariff[]

  @@map("bill_customer_categories")
}

// ==================== العملاء ====================
model BillCustomer {
  id             String    @id @default(uuid()) @db.Uuid
  accountNo      String    @unique @map("account_no") @db.VarChar(20)
  name           String    @db.VarChar(200)
  nameEn         String?   @map("name_en") @db.VarChar(200)
  categoryId     String    @map("category_id") @db.Uuid
  idType         String    @map("id_type") @db.VarChar(50) // national_id, iqama, cr, passport
  idNumber       String    @map("id_number") @db.VarChar(50)
  idCardImage    String?   @map("id_card_image") @db.VarChar(500) // صورة البطاقة الشخصية
  taxNumber      String?   @map("tax_number") @db.VarChar(50) // الرقم الضريبي
  phone          String    @db.VarChar(20)
  mobile         String?   @db.VarChar(20)
  email          String?   @db.VarChar(100)
  address        String    @db.Text
  city           String?   @db.VarChar(100)
  district       String?   @db.VarChar(100)
  building       String?   @db.VarChar(100)
  floor          String?   @db.VarChar(20)
  latitude       Decimal?  @db.Decimal(10, 8)
  longitude      Decimal?  @db.Decimal(11, 8)
  stationId      String?   @map("station_id") @db.Uuid
  transformerId  String?   @map("transformer_id") @db.Uuid
  creditLimit    Decimal   @default(0) @map("credit_limit") @db.Decimal(15, 2)
  paymentTerms   String    @default("postpaid") @map("payment_terms") @db.VarChar(20) // prepaid, postpaid
  billingCycle   String    @default("monthly") @map("billing_cycle") @db.VarChar(20) // monthly, quarterly
  accountId      String?   @map("account_id") @db.Uuid // الربط المحاسبي
  status         String    @default("active") @db.VarChar(20) // active, inactive, suspended, disconnected, closed
  suspensionReason String? @map("suspension_reason") @db.Text
  disconnectionDate DateTime? @map("disconnection_date")
  connectionDate DateTime? @map("connection_date")
  
  // بيانات الدعم الحكومي
  isSubsidized         Boolean   @default(false) @map("is_subsidized")
  subsidyProgramId     String?   @map("subsidy_program_id") @db.Uuid
  subsidyReferenceNo   String?   @map("subsidy_reference_no") @db.VarChar(50)
  subsidyStartDate     DateTime? @map("subsidy_start_date")
  subsidyEndDate       DateTime? @map("subsidy_end_date")
  
  // جهة الاتصال الرئيسية
  contactPerson  String?   @map("contact_person") @db.VarChar(100)
  contactPhone   String?   @map("contact_phone") @db.VarChar(20)
  
  notes          String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  category    BillCustomerCategory @relation(fields: [categoryId], references: [id])
  contracts   BillContract[]
  meters      BillMeter[]
  invoices    BillInvoice[]
  payments    BillPayment[]
  complaints  BillComplaint[]
  addresses   BillCustomerAddress[]
  contacts    BillCustomerContact[]
  components  BillCustomerComponent[]
  componentHistory BillComponentHistory[]
  installmentPlans BillInstallmentPlan[]
  disconnectionOrders BillDisconnectionOrder[]
  prepaidTokens BillPrepaidToken[]
  serviceRequests BillServiceRequest[]

  @@index([categoryId])
  @@index([status])
  @@index([isSubsidized])
  @@map("bill_customers")
}

// ==================== عناوين العملاء ====================
model BillCustomerAddress {
  id          String   @id @default(uuid()) @db.Uuid
  customerId  String   @map("customer_id") @db.Uuid
  addressType String   @map("address_type") @db.VarChar(50) // billing, service, mailing
  address     String   @db.Text
  city        String?  @db.VarChar(100)
  district    String?  @db.VarChar(100)
  postalCode  String?  @map("postal_code") @db.VarChar(20)
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")

  customer BillCustomer @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@map("bill_customer_addresses")
}

// ==================== جهات اتصال العملاء ====================
model BillCustomerContact {
  id         String   @id @default(uuid()) @db.Uuid
  customerId String   @map("customer_id") @db.Uuid
  name       String   @db.VarChar(100)
  position   String?  @db.VarChar(100)
  phone      String?  @db.VarChar(20)
  mobile     String?  @db.VarChar(20)
  email      String?  @db.VarChar(100)
  isPrimary  Boolean  @default(false) @map("is_primary")
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  customer BillCustomer @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@map("bill_customer_contacts")
}

// ==================== العقود ====================
model BillContract {
  id                String    @id @default(uuid()) @db.Uuid
  contractNo        String    @unique @map("contract_no") @db.VarChar(30)
  customerId        String    @map("customer_id") @db.Uuid
  startDate         DateTime  @map("start_date")
  endDate           DateTime? @map("end_date")
  contractType      String    @default("permanent") @map("contract_type") @db.VarChar(50) // permanent, temporary
  loadKw            Decimal   @default(0) @map("load_kw") @db.Decimal(10, 2)
  depositAmount     Decimal   @default(0) @map("deposit_amount") @db.Decimal(15, 2)
  guaranteeAmount   Decimal   @default(0) @map("guarantee_amount") @db.Decimal(15, 2)
  status            String    @default("active") @db.VarChar(20) // draft, active, suspended, terminated, expired
  terms             String?   @db.Text
  notes             String?   @db.Text
  terminatedAt      DateTime? @map("terminated_at")
  terminationReason String?   @map("termination_reason") @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  customer BillCustomer @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([status])
  @@map("bill_contracts")
}

// ==================== أنواع العدادات ====================
model BillMeterType {
  id           String   @id @default(uuid()) @db.Uuid
  code         String   @unique @db.VarChar(20)
  name         String   @db.VarChar(100)
  nameEn       String?  @map("name_en") @db.VarChar(100)
  description  String?  @db.Text
  phases       Int      @default(1) // 1 = single phase, 3 = three phase
  category     String   @default("postpaid") @db.VarChar(20) // postpaid, prepaid
  isSmartMeter Boolean  @default(false) @map("is_smart_meter")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  meters BillMeter[]

  @@map("bill_meter_types")
}

// ==================== العدادات ====================
model BillMeter {
  id            String    @id @default(uuid()) @db.Uuid
  meterNo       String    @unique @map("meter_no") @db.VarChar(50)
  customerId    String?   @map("customer_id") @db.Uuid
  meterTypeId   String    @map("meter_type_id") @db.Uuid
  manufacturer  String?   @db.VarChar(100)
  model         String?   @db.VarChar(100)
  serialNumber  String?   @map("serial_number") @db.VarChar(100)
  installDate   DateTime? @map("install_date")
  lastReadDate  DateTime? @map("last_read_date")
  lastReading   Decimal   @default(0) @map("last_reading") @db.Decimal(15, 2)
  multiplier    Decimal   @default(1) @db.Decimal(5, 2)
  status        String    @default("active") @db.VarChar(20) // active, faulty, replaced, removed, in_stock
  location      String?   @db.Text
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  customer   BillCustomer?      @relation(fields: [customerId], references: [id])
  meterType  BillMeterType      @relation(fields: [meterTypeId], references: [id])
  readings   BillMeterReading[]
  complaints BillComplaint[]
  disconnectionOrders BillDisconnectionOrder[]
  prepaidTokens BillPrepaidToken[]

  @@index([customerId])
  @@index([meterTypeId])
  @@index([status])
  @@map("bill_meters")
}

// ==================== قراءات العدادات ====================
model BillMeterReading {
  id              String   @id @default(uuid()) @db.Uuid
  meterId         String   @map("meter_id") @db.Uuid
  readingDate     DateTime @map("reading_date")
  reading         Decimal  @db.Decimal(15, 2)
  previousReading Decimal  @map("previous_reading") @db.Decimal(15, 2)
  consumption     Decimal  @db.Decimal(15, 2)
  readingType     String   @map("reading_type") @db.VarChar(30) // normal, estimated, final, initial
  readerId        String?  @map("reader_id") @db.Uuid
  imageUrl        String?  @map("image_url") @db.VarChar(500)
  notes           String?  @db.Text
  billingPeriod   String   @map("billing_period") @db.VarChar(7) // YYYY-MM
  isProcessed     Boolean  @default(false) @map("is_processed")
  createdAt       DateTime @default(now()) @map("created_at")

  meter BillMeter @relation(fields: [meterId], references: [id])

  @@index([meterId])
  @@index([billingPeriod])
  @@index([readingDate])
  @@map("bill_meter_readings")
}

// ==================== شرائح التعرفة ====================
model BillTariff {
  id            String    @id @default(uuid()) @db.Uuid
  categoryId    String    @map("category_id") @db.Uuid
  name          String    @db.VarChar(100)
  nameEn        String?   @map("name_en") @db.VarChar(100)
  sliceOrder    Int       @map("slice_order") // ترتيب الشريحة
  fromKwh       Decimal   @map("from_kwh") @db.Decimal(15, 2)
  toKwh         Decimal?  @map("to_kwh") @db.Decimal(15, 2)
  ratePerKwh    Decimal   @map("rate_per_kwh") @db.Decimal(10, 4)
  fixedCharge   Decimal   @default(0) @map("fixed_charge") @db.Decimal(15, 2)
  effectiveFrom DateTime  @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  category BillCustomerCategory @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([isActive])
  @@map("bill_tariffs")
}

// ==================== الفواتير ====================
model BillInvoice {
  id                String    @id @default(uuid()) @db.Uuid
  invoiceNo         String    @unique @map("invoice_no") @db.VarChar(30)
  customerId        String    @map("customer_id") @db.Uuid
  billingPeriod     String    @map("billing_period") @db.VarChar(7) // YYYY-MM
  fromDate          DateTime  @map("from_date")
  toDate            DateTime  @map("to_date")
  previousReading   Decimal   @map("previous_reading") @db.Decimal(15, 2)
  currentReading    Decimal   @map("current_reading") @db.Decimal(15, 2)
  consumption       Decimal   @db.Decimal(15, 2)
  consumptionAmount Decimal   @map("consumption_amount") @db.Decimal(15, 2)
  fixedCharges      Decimal   @default(0) @map("fixed_charges") @db.Decimal(15, 2)
  otherCharges      Decimal   @default(0) @map("other_charges") @db.Decimal(15, 2)
  subtotal          Decimal   @db.Decimal(15, 2)
  vatRate           Decimal   @default(15) @map("vat_rate") @db.Decimal(5, 2)
  vatAmount         Decimal   @map("vat_amount") @db.Decimal(15, 2)
  totalAmount       Decimal   @map("total_amount") @db.Decimal(15, 2)
  dueDate           DateTime  @map("due_date")
  status            String    @default("issued") @db.VarChar(20) // draft, issued, paid, partial, overdue, cancelled
  paidAmount        Decimal   @default(0) @map("paid_amount") @db.Decimal(15, 2)
  balance           Decimal   @db.Decimal(15, 2)
  issuedAt          DateTime  @default(now()) @map("issued_at")
  paidAt            DateTime? @map("paid_at")
  cancelledAt       DateTime? @map("cancelled_at")
  deletedAt         DateTime? @map("deleted_at")
  cancelReason      String?   @map("cancel_reason") @db.Text
  notes             String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  installmentPlanId String?   @map("installment_plan_id") @db.Uuid

  customer   BillCustomer      @relation(fields: [customerId], references: [id])
  items      BillInvoiceItem[]
  payments   BillPayment[]
  complaints BillComplaint[]
  installmentPlan BillInstallmentPlan? @relation("InstallmentPlanInvoices", fields: [installmentPlanId], references: [id])

  @@index([customerId])
  @@index([billingPeriod])
  @@index([status])
  @@index([dueDate])
  @@index([installmentPlanId])
  @@map("bill_invoices")
}

// ==================== تفاصيل الفاتورة ====================
model BillInvoiceItem {
  id          String   @id @default(uuid()) @db.Uuid
  invoiceId   String   @map("invoice_id") @db.Uuid
  description String   @db.VarChar(200)
  itemType    String   @map("item_type") @db.VarChar(50) // consumption, fixed_charge, other
  fromKwh     Decimal? @map("from_kwh") @db.Decimal(15, 2)
  toKwh       Decimal? @map("to_kwh") @db.Decimal(15, 2)
  quantity    Decimal  @db.Decimal(15, 2)
  rate        Decimal  @db.Decimal(10, 4)
  amount      Decimal  @db.Decimal(15, 2)
  createdAt   DateTime @default(now()) @map("created_at")

  invoice BillInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("bill_invoice_items")
}

// ==================== المدفوعات ====================
model BillPayment {
  id            String    @id @default(uuid()) @db.Uuid
  paymentNo     String    @unique @map("payment_no") @db.VarChar(30)
  customerId    String    @map("customer_id") @db.Uuid
  invoiceId     String?   @map("invoice_id") @db.Uuid
  paymentDate   DateTime  @default(now()) @map("payment_date")
  amount        Decimal   @db.Decimal(15, 2)
  paymentMethod String    @map("payment_method") @db.VarChar(30) // cash, bank, card, online
  referenceNo   String?   @map("reference_no") @db.VarChar(100)
  bankId        String?   @map("bank_id") @db.Uuid
  status        String    @default("confirmed") @db.VarChar(20) // pending, confirmed, cancelled
  receivedBy    String?   @map("received_by") @db.Uuid
  cancelledAt   DateTime? @map("cancelled_at")
  cancelReason  String?   @map("cancel_reason") @db.Text
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  customer BillCustomer @relation(fields: [customerId], references: [id])
  invoice  BillInvoice? @relation(fields: [invoiceId], references: [id])

  @@index([customerId])
  @@index([invoiceId])
  @@index([paymentDate])
  @@index([status])
  @@map("bill_payments")
}

// ==================== الشكاوى ====================
model BillComplaint {
  id               String    @id @default(uuid()) @db.Uuid
  complaintNo      String    @unique @map("complaint_no") @db.VarChar(30)
  customerId       String    @map("customer_id") @db.Uuid
  type             String    @db.VarChar(50) // billing, meter, service, technical, other
  subject          String    @db.VarChar(200)
  description      String    @db.Text
  priority         String    @default("medium") @db.VarChar(20) // low, medium, high, urgent
  status           String    @default("open") @db.VarChar(20) // open, in_progress, resolved, closed
  relatedInvoiceId String?   @map("related_invoice_id") @db.Uuid
  relatedMeterId   String?   @map("related_meter_id") @db.Uuid
  assignedTo       String?   @map("assigned_to") @db.Uuid
  response         String?   @db.Text
  resolution       String?   @db.Text
  internalNotes    String?   @map("internal_notes") @db.Text
  resolvedAt       DateTime? @map("resolved_at")
  closedAt         DateTime? @map("closed_at")
  attachments      String[]  @default([])
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  customer       BillCustomer  @relation(fields: [customerId], references: [id])
  relatedInvoice BillInvoice?  @relation(fields: [relatedInvoiceId], references: [id])
  relatedMeter   BillMeter?    @relation(fields: [relatedMeterId], references: [id])

  @@index([customerId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@map("bill_complaints")
}

// ==================== طلبات الاشتراك ====================
model BillSubscriptionRequest {
  id                 String    @id @default(uuid()) @db.Uuid
  requestNo          String    @unique @map("request_no") @db.VarChar(30)
  customerName       String    @map("customer_name") @db.VarChar(200)
  customerType       String    @map("customer_type") @db.VarChar(50)
  idType             String?   @map("id_type") @db.VarChar(50)
  idNumber           String?   @map("id_number") @db.VarChar(50)
  phone              String?   @db.VarChar(20)
  mobile             String    @db.VarChar(20)
  email              String?   @db.VarChar(100)
  address            String?   @db.Text
  city               String?   @db.VarChar(100)
  district           String?   @db.VarChar(100)
  latitude           Decimal?  @db.Decimal(10, 8)
  longitude          Decimal?  @db.Decimal(11, 8)
  subscriptionFee    Decimal?  @map("subscription_fee") @db.Decimal(15, 2)
  connectionFee      Decimal?  @map("connection_fee") @db.Decimal(15, 2)
  depositAmount      Decimal?  @map("deposit_amount") @db.Decimal(15, 2)
  totalAmount        Decimal?  @map("total_amount") @db.Decimal(15, 2)
  paymentStatus      String    @default("pending") @map("payment_status") @db.VarChar(20)
  paidAmount         Decimal   @default(0) @map("paid_amount") @db.Decimal(15, 2)
  paymentDate        DateTime? @map("payment_date")
  paymentReference   String?   @map("payment_reference") @db.VarChar(100)
  status             String    @default("pending_review") @db.VarChar(30)
  customerId         String?   @map("customer_id") @db.Uuid
  assignedTechnician String?   @map("assigned_technician") @db.Uuid
  meterSerialNumber  String?   @map("meter_serial_number") @db.VarChar(100)
  requestDate        DateTime  @default(now()) @map("request_date")
  approvalDate       DateTime? @map("approval_date")
  installationDate   DateTime? @map("installation_date")
  completionDate     DateTime? @map("completion_date")
  approvedBy         String?   @map("approved_by") @db.Uuid
  rejectionReason    String?   @map("rejection_reason") @db.Text
  notes              String?   @db.Text
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@index([status])
  @@index([paymentStatus])
  @@map("bill_subscription_requests")
}

// ==================== سجل التدقيق ====================
model BillAuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  tableName  String   @map("table_name") @db.VarChar(100)
  recordId   String   @map("record_id") @db.Uuid
  action     String   @db.VarChar(20) // create, update, delete
  oldData    Json?    @map("old_data")
  newData    Json?    @map("new_data")
  userId     String?  @map("user_id") @db.Uuid
  ipAddress  String?  @map("ip_address") @db.VarChar(50)
  userAgent  String?  @map("user_agent") @db.VarChar(500)
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([tableName])
  @@index([recordId])
  @@index([userId])
  @@index([createdAt])
  @@map("bill_audit_logs")
}

// ==================== إعدادات النظام ====================
model BillSystemSetting {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100)
  value       String   @db.Text
  description String?  @db.Text
  dataType    String   @map("data_type") @db.VarChar(20) // string, number, boolean, json
  isEditable  Boolean  @default(true) @map("is_editable")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("bill_system_settings")
}

// ==================== تسلسل الأرقام ====================
model BillSequence {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(50)
  prefix      String   @db.VarChar(10)
  currentNo   Int      @default(0) @map("current_no")
  padLength   Int      @default(6) @map("pad_length")
  resetPeriod String?  @map("reset_period") @db.VarChar(20) // yearly, monthly, never
  lastReset   DateTime? @map("last_reset")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("bill_sequences")
}


// ==================== مكونات العميل ====================
model BillCustomerComponent {
  id                     String    @id @default(uuid()) @db.Uuid
  customerId             String    @map("customer_id") @db.Uuid
  
  // بيانات العداد
  meterSerialNumber      String?   @map("meter_serial_number") @db.VarChar(100)
  meterType              String?   @map("meter_type") @db.VarChar(50) // smart, traditional
  meterModel             String?   @map("meter_model") @db.VarChar(100)
  meterInstallationDate  DateTime? @map("meter_installation_date")
  meterWarrantyEnd       DateTime? @map("meter_warranty_end")
  
  // بيانات القاطع
  breakerSerialNumber    String?   @map("breaker_serial_number") @db.VarChar(100)
  breakerType            String?   @map("breaker_type") @db.VarChar(50)
  breakerCapacity        String?   @map("breaker_capacity") @db.VarChar(20) // أمبير
  breakerBrand           String?   @map("breaker_brand") @db.VarChar(50)
  breakerInstallationDate DateTime? @map("breaker_installation_date")
  breakerWarrantyEnd     DateTime? @map("breaker_warranty_end")
  
  // بيانات الختم
  sealNumber             String?   @map("seal_number") @db.VarChar(50)
  sealColor              String?   @map("seal_color") @db.VarChar(30)
  sealType               String?   @map("seal_type") @db.VarChar(50)
  sealInstallationDate   DateTime? @map("seal_installation_date")
  
  lastUpdatedAt          DateTime  @default(now()) @map("last_updated_at")
  lastUpdatedBy          String?   @map("last_updated_by") @db.Uuid
  createdAt              DateTime  @default(now()) @map("created_at")

  customer BillCustomer @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([meterSerialNumber])
  @@map("bill_customer_components")
}

// ==================== تاريخ المكونات ====================
model BillComponentHistory {
  id              String    @id @default(uuid()) @db.Uuid
  customerId      String    @map("customer_id") @db.Uuid
  
  // نوع المكون
  componentType   String    @map("component_type") @db.VarChar(50) // meter, breaker, seal, cable
  
  // بيانات المكون
  serialNumber    String?   @map("serial_number") @db.VarChar(100)
  model           String?   @db.VarChar(100)
  brand           String?   @db.VarChar(100)
  specifications  Json?     @db.Json // مواصفات إضافية
  
  // العملية
  actionType      String    @map("action_type") @db.VarChar(50) // installed, replaced, removed
  actionDate      DateTime  @map("action_date")
  actionTime      DateTime? @map("action_time") @db.Time
  
  // السبب
  reason          String?   @db.VarChar(200) // تركيب جديد، عطل، ترقية، صيانة دورية
  notes           String?   @db.Text
  
  // الضمان
  warrantyStatus  String?   @map("warranty_status") @db.VarChar(50) // under_warranty, out_of_warranty, extended_warranty
  warrantyEndDate DateTime? @map("warranty_end_date")
  
  // الربط
  workOrderId     String?   @map("work_order_id") @db.Uuid
  replacementId   String?   @map("replacement_id") @db.Uuid
  technicianId    String?   @map("technician_id") @db.Uuid
  
  // التكلفة
  cost            Decimal   @default(0) @db.Decimal(15, 2)
  invoiceId       String?   @map("invoice_id") @db.Uuid
  
  createdAt       DateTime  @default(now()) @map("created_at")

  customer BillCustomer @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([serialNumber])
  @@index([componentType])
  @@index([actionDate])
  @@map("bill_component_history")
}

// ==================== برامج الدعم الحكومي ====================
model BillSubsidyProgram {
  id              String    @id @default(uuid()) @db.Uuid
  code            String    @unique @db.VarChar(20)
  name            String    @db.VarChar(100)
  nameEn          String?   @map("name_en") @db.VarChar(100)
  description     String?   @db.Text
  monthlyQuotaKwh Decimal   @map("monthly_quota_kwh") @db.Decimal(10, 2) // الحصة الشهرية بالكيلوواط
  ratePerKwh      Decimal   @map("rate_per_kwh") @db.Decimal(10, 4) // سعر الكيلوواط المدعوم
  isActive        Boolean   @default(true) @map("is_active")
  effectiveFrom   DateTime  @map("effective_from")
  effectiveTo     DateTime? @map("effective_to")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  quotas BillSubsidyQuota[]

  @@map("bill_subsidy_programs")
}

// ==================== حصص الدعم الشهرية ====================
model BillSubsidyQuota {
  id            String    @id @default(uuid()) @db.Uuid
  customerId    String    @map("customer_id") @db.Uuid
  programId     String    @map("program_id") @db.Uuid
  year          Int
  month         Int
  allocatedKwh  Decimal   @map("allocated_kwh") @db.Decimal(10, 2) // الحصة المخصصة
  consumedKwh   Decimal   @default(0) @map("consumed_kwh") @db.Decimal(10, 2) // المستهلك
  remainingKwh  Decimal?  @map("remaining_kwh") @db.Decimal(10, 2) // المتبقي
  subsidyValue  Decimal?  @map("subsidy_value") @db.Decimal(15, 2) // قيمة الدعم المستحقة
  status        String    @default("active") @db.VarChar(20) // active, exhausted, expired
  exhaustedAt   DateTime? @map("exhausted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  program BillSubsidyProgram @relation(fields: [programId], references: [id])

  @@unique([customerId, year, month])
  @@index([customerId])
  @@index([programId])
  @@index([year, month])
  @@map("bill_subsidy_quotas")
}

// ==================== خطط التقسيط ====================
model BillInstallmentPlan {
  id                String   @id @default(uuid()) @db.Uuid
  planNo            String   @unique @map("plan_no") @db.VarChar(20)
  customerId        String   @map("customer_id") @db.Uuid
  totalAmount       Decimal  @map("total_amount") @db.Decimal(15, 2)
  downPayment       Decimal  @default(0) @map("down_payment") @db.Decimal(15, 2)
  remainingAmount   Decimal  @map("remaining_amount") @db.Decimal(15, 2)
  numberOfInstallments Int   @map("number_of_installments")
  installmentAmount Decimal  @map("installment_amount") @db.Decimal(15, 2)
  startDate         DateTime @map("start_date")
  endDate           DateTime @map("end_date")
  status            String   @default("active") @db.VarChar(20) // active, completed, cancelled, defaulted
  approvedBy        String?  @map("approved_by") @db.Uuid
  approvedAt        DateTime? @map("approved_at")
  notes             String?  @db.Text
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  customer     BillCustomer @relation(fields: [customerId], references: [id])
  installments BillInstallment[]
  invoices     BillInvoice[] @relation("InstallmentPlanInvoices")

  @@index([customerId])
  @@index([status])
  @@map("bill_installment_plans")
}

// ==================== أقساط خطة التقسيط ====================
model BillInstallment {
  id            String    @id @default(uuid()) @db.Uuid
  planId        String    @map("plan_id") @db.Uuid
  installmentNo Int       @map("installment_no")
  dueDate       DateTime  @map("due_date")
  amount        Decimal   @db.Decimal(15, 2)
  paidAmount    Decimal   @default(0) @map("paid_amount") @db.Decimal(15, 2)
  paidDate      DateTime? @map("paid_date")
  status        String    @default("pending") @db.VarChar(20) // pending, paid, overdue, cancelled
  paymentId     String?   @map("payment_id") @db.Uuid
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  plan BillInstallmentPlan @relation(fields: [planId], references: [id])

  @@unique([planId, installmentNo])
  @@index([status])
  @@index([dueDate])
  @@map("bill_installments")
}

// ==================== أوامر الفصل والتوصيل ====================
model BillDisconnectionOrder {
  id              String    @id @default(uuid()) @db.Uuid
  orderNo         String    @unique @map("order_no") @db.VarChar(20)
  customerId      String    @map("customer_id") @db.Uuid
  meterId         String?   @map("meter_id") @db.Uuid
  orderType       String    @map("order_type") @db.VarChar(20) // disconnection, reconnection
  reason          String    @db.VarChar(100) // non_payment, customer_request, violation, maintenance
  reasonDetails   String?   @map("reason_details") @db.Text
  outstandingAmount Decimal? @map("outstanding_amount") @db.Decimal(15, 2)
  scheduledDate   DateTime  @map("scheduled_date")
  executedDate    DateTime? @map("executed_date")
  executedBy      String?   @map("executed_by") @db.Uuid
  status          String    @default("pending") @db.VarChar(20) // pending, scheduled, executed, cancelled
  cancelReason    String?   @map("cancel_reason") @db.Text
  reconnectionFee Decimal?  @map("reconnection_fee") @db.Decimal(15, 2)
  notes           String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  customer BillCustomer @relation(fields: [customerId], references: [id])
  meter    BillMeter?   @relation(fields: [meterId], references: [id])

  @@index([customerId])
  @@index([status])
  @@index([orderType])
  @@map("bill_disconnection_orders")
}

// ==================== الدفع المسبق ====================
model BillPrepaidToken {
  id               String    @id @default(uuid()) @db.Uuid
  tokenNo          String    @unique @map("token_no") @db.VarChar(20)
  token            String    @unique @db.VarChar(30)
  meterId          String    @map("meter_id") @db.Uuid
  customerId       String    @map("customer_id") @db.Uuid
  amount           Decimal   @db.Decimal(12, 2)
  units            Int       @default(0)
  paymentMethod    String?   @map("payment_method") @db.VarChar(50)
  paymentReference String?   @map("payment_reference") @db.VarChar(100)
  status           String    @default("active") @db.VarChar(20) // active, used, expired, cancelled
  expiresAt        DateTime? @map("expires_at")
  usedAt           DateTime? @map("used_at")
  notes            String?   @db.Text
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  meter    BillMeter    @relation(fields: [meterId], references: [id])
  customer BillCustomer @relation(fields: [customerId], references: [id])

  @@map("bill_prepaid_tokens")
}

// ==================== طلبات الخدمة ====================
model BillServiceRequest {
  id            String    @id @default(uuid()) @db.Uuid
  requestNo     String    @unique @map("request_no") @db.VarChar(20)
  customerId    String    @map("customer_id") @db.Uuid
  requestType   String    @map("request_type") @db.VarChar(50)
  description   String    @db.Text
  attachments   String?   @db.Text
  preferredDate DateTime? @map("preferred_date")
  status        String    @default("pending") @db.VarChar(20)
  assignedTo    String?   @map("assigned_to") @db.VarChar(100)
  resolution    String?   @db.Text
  completedAt   DateTime? @map("completed_at")
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  customer BillCustomer @relation(fields: [customerId], references: [id])

  @@map("bill_service_requests")
}
